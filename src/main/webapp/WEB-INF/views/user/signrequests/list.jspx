<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<div xmlns:fmt="http://java.sun.com/jsp/jstl/fmt" xmlns:c="http://java.sun.com/jsp/jstl/core" xmlns:jsp="http://java.sun.com/JSP/Page" xmlns:page="urn:jsptagdir:/WEB-INF/tags/form" xmlns:table="urn:jsptagdir:/WEB-INF/tags/form/fields" xmlns:spring="http://www.springframework.org/tags" xmlns:fn="http://java.sun.com/jsp/jstl/functions" xmlns:util="urn:jsptagdir:/WEB-INF/tags/util" version="2.0">
	<jsp:directive.page contentType="text/html;charset=UTF-8" />
	<jsp:output omit-xml-declaration="yes" />
	<div class="card card-header">
		<nav class="nav justify-content-between" aria-label="breadcrumb">
			<ol class="breadcrumb col-11">
				<li class="breadcrumb-item active">Liste des demandes</li>
			</ol>
			<div class="navbar-nav align-self-center">
				<button data-target="#collapseHelp" data-toggle="collapse" type="button" class="btn btn-info">
					<span class="fas fa-info-circle"><!--  --></span>
				</button>
			</div>
		</nav>
		<br/>
		<div class="row">
			<div class="col-lg-6 text-center">
				<button type="button" alt="Signer un nouveau document" class="btn btn-success" onclick="location.href='/user/signrequests?form'" title="Signer un nouveau Document">
					<i class="fas fa-plus">
						<!--  -->
					</i>&amp;nbsp;
					<spring:message code="menu_item_signrequest_new" />
				</button>
			</div>
			<div class="col-lg-6 text-center">
				<button type="button" alt="Valider la signature d'un document" class="btn btn-success" onclick="location.href='/user/validation'" title="Signer un nouveau Document">
					<i class="fas fa-shield-alt">
						<!--  -->
					</i>&amp;nbsp;Valider la signature d'un document
				</button>
			</div>
		</div>
	</div>

	<div id="collapseHelp" class="collapse" aria-expanded="true" style="">
		<div class="alert alert-info">
			<p>Liste des demandes de signatures concernant l'utilisateur courant (à signer ou envoyés pour signature)</p>
			<p>
			Statut des demandes de signatures :
			</p>
			<p>
			<span class="alert alert-primary">
				<i class="fas fa-clock"> <!--  --></i>&amp;nbsp;<spring:message code="label_org_esupportail_esupsignature_domain_signbook_status_pending" />
			</span>
			La demande se trouve dans un ou plusieurs parapheur, elle est en attente d'une ou plusieurs signatures 
			</p>
			<p>
			<span class="alert alert-success">
				<i class="fas fa-file-signature"> <!--  -->
				</i>&amp;nbsp;<spring:message code="label_org_esupportail_esupsignature_domain_signbook_status_signed" />
			</span>
			Tous les critères de signatures sont remplis
			</p>
			<p>
			<span class="alert alert-success">
				<i class="far fa-check-circle"> <!--  -->
				</i>&amp;nbsp;<spring:message code="label_org_esupportail_esupsignature_domain_signbook_status_checked" />
			</span>
			Le document à été validé par tous les participants
			</p>
			<p>
			<span class="alert alert-danger">
				<i class="fas fa-ban"> <!--  -->
				</i>&amp;nbsp;<spring:message code="label_org_esupportail_esupsignature_domain_signbook_status_refused" />
			</span>
			La demande à été refusée et retirée des parapheurs
			</p>
			<p>
			<span class="alert alert-warning">
				<i class="fas fa-flag-checkered"> <!--  -->
				</i>&amp;nbsp;<spring:message code="label_org_esupportail_esupsignature_domain_signbook_status_completed" />
			</span>
			La demande la demande à été retirée des parapheurs, elle va être supprimée de l'application automatiquement
			</p>
		</div>
	</div>
	<div class="card">
		<div class="card-header">
		<div class="row">

			<div class="col-lg-12">
			<form class="" action="" method="get">
			<div id="accordionfilter">
			<div class="card">
				<div class="card-header">
                    <div class="accordion-heading">
                        <a class="accordion-toggle" data-parent="#accordionfilter" data-toggle="collapse" href="#collapseFilter">Filtres&amp;nbsp;<i class="fas fa-caret-down"><!--  --></i></a>
                    </div>
                    <div class="accordion-body collapse ${finderview ? 'in' : ''}" id="collapseFilter">
                        <div class="accordion-inner">
                        <div class="input-group">
   					<div class="input-group-prepend">
						<div class="input-group-text">
							Type
						</div>
					</div>
					<select class="form-control" name="toSign" onchange="submit();">
						<option value="">Choisir un filtre</option>
						<c:choose>
							<c:when test="${toSign eq true}">
								<option value="false">
									<spring:message code="menu_item_user_my_documents" />
								</option>
								<option value="true" selected="selected">
									<spring:message code="menu_item_user_to_sign_documents" />
								</option>
							</c:when>
							<c:when test="${toSign eq false}">
								<option value="false" selected="selected">
									<spring:message code="menu_item_user_my_documents" />
								</option>
								<option value="true">
									<spring:message code="menu_item_user_to_sign_documents" />
								</option>
							</c:when>
							<c:otherwise>
								<option value="false" >
									<spring:message code="menu_item_user_my_documents" />
								</option>
								<option value="true">
									<spring:message code="menu_item_user_to_sign_documents" />
								</option>
							</c:otherwise>
						</c:choose>
					</select>
					<div class="input-group-prepend">
						<div class="input-group-text">
							<spring:message code="label_org_esupportail_esupsignature_domain_signrequest_status" />
						</div>
					</div>
					<select class="form-control" name="statusFilter" id="statusFilter" onchange="submit();">
						<option value="" disabled="disabled" selected="selected"><spring:message code="menu_item_choose_status" /></option>
						<option value=""><spring:message code="menu_item_all" /></option>
						<c:forEach items="${statuses}" var="status">
							<c:choose>
								<c:when test="${status eq statusFilter}">
									<option value="${status}" selected="selected"><spring:message code="label_org_esupportail_esupsignature_domain_signbook_status_${status}" /></option>
								</c:when>
								<c:otherwise>
									<option value="${status}"><spring:message code="label_org_esupportail_esupsignature_domain_signbook_status_${status}" /></option>
								</c:otherwise>
							</c:choose>
						</c:forEach>
					</select>
					<div class="input-group-prepend">
						<div class="input-group-text">
							<spring:message code="label_org_esupportail_esupsignature_domain_signbook" />
						</div>
					</div>
					<select class="form-control" name="signBookId" onchange="submit();">
						<option value="" disabled="disabled" selected="selected"><spring:message code="menu_item_choose_signbook" /></option>
						<c:forEach items="${signBooks}" var="signBook">
							<c:choose>
								<c:when test="${signBookId eq signBook.id}">
									<option value="${signBook.id}" selected="selected">${signBook.name}</option>
								</c:when>
								<c:otherwise>
									<option value="${signBook.id}">${signBook.name}</option>
								</c:otherwise>
							</c:choose>
						</c:forEach>
					</select>
				</div>
</div></div></div></div></div>

			</form>
			</div>
			<div class="col-lg-12">
			<div class="form-inline">
				<div class="input-group">
					<button id="opendocs" alt="Open docs" class="btn btn-info" onclick="openCheckedDocs()" title="open docs" style="display: none;">
						<span class="far fa-eye"><!--  --></span>&amp;nbsp;<spring:message code="menu_item_open_docs" />
					</button>
				</div>
				<div class="input-group">
					<input class="form-control" id="passwordField" placeholder="Keystore password" name="password" type="password" style="display: none;" />
				</div>
				<div class="input-group">
					<button data-toggle="modal" data-target="#wait" id="signdocs" alt="Sign docs" class="btn btn-primary" onclick="submitSignRequests()" title="Sign docs" style="display: none;">
						<span class="fa fa-pencil-alt"><!--  --></span>&amp;nbsp;<spring:message code="menu_item_sign_docs" />
					</button>
				</div>
				<div class="input-group">
					<button data-toggle="modal" data-target="#wait" id="signdocs" alt="Passer au statut terminé" class="btn btn-warning" onclick="completeSignRequests()" title="Passer au statut terminé" style="display: none;">
						<span class="fas fa-flag-checkered"><!--  --></span>&amp;nbsp;Passer au statut terminé
					</button>
				</div>				
				<div class="mx-auto"><!--  --></div>

			</div>
			</div>
		</div>
		<div style="display: none;" id="alertsigndocs" alt="Sign docs" class="alert alert-danger" role="alert" >Impossible de signer en masse la selection actuelle</div>
		<div class="card-body">
			<div class="table-responsive">
				<table class="table table-sm table-striped table-hover">
					<thead>
						<tr>
							<th data-type="html"><input id="selectall" type="checkbox" /></th>
							<th class="none"><spring:message code="label_org_esupportail_esupsignature_domain_signrequest_title" /></th>
							<th class="none"><spring:message code="label_org_esupportail_esupsignature_domain_signrequest_createdate" /></th>
							<th class="none"><spring:message code="label_org_esupportail_esupsignature_domain_signrequest_createby" /></th>
							<th class="none"><spring:message code="label_org_esupportail_esupsignature_domain_signrequest_insignbook" /></th>
							<th class="none">Destinataires</th>
							<th class="type"><spring:message code="label_org_esupportail_esupsignature_domain_signrequest_signtype" /></th>
							<th class="status"><spring:message code="label_org_esupportail_esupsignature_domain_signrequest_status" /></th>
							<th><spring:message code="button_view" /></th>
							<th><spring:message code="button_delete" /></th>
						</tr>
					</thead>
					<tbody>
						<c:forEach items="${signRequests}" var="signRequestItem" >
							<c:set var="signRequest" value="${signRequestItem}" scope="request" />
							<tr class="roocol">
								<td class="none"><input value="${signRequest.id}" name="check" type="checkbox" class="check" /></td>
								<td class="none" style="width: 240px;">${signRequest.title}</td>
								<td class="none"><fmt:formatDate value="${signRequest.createDate}" pattern="dd/MM/yyyy HH:mm" /></td>
								<td class="none">${signRequest.createBy}</td>
								<td class="none">
								<ul class="list-group">
								<c:forEach items="${signRequest.originalSignBooks}" var="originalSignBook">
								<li class="list-group-item"><i class="fas fa-book"><!--  --></i>&amp;nbsp;${originalSignBook.name}</li>
								</c:forEach>
								</ul>
								</td>
								<td class="signbook" style="display: block;">
									<table class="table table-sm">
									  	<tbody>
											<c:forEach items="${signRequest.signBooksLabels}" var="signBooksLabel">
									  			<tr>
													<td width="100%">${signBooksLabel.key}</td>
													<td align="center">
														<c:choose>
															<c:when test="${signBooksLabel.value eq true}">
																<i class="fas fa-check text-success"><!--  --></i>
															</c:when>
															<c:otherwise>
																<i class="fas fa-times text-danger"><!--  --></i>
															</c:otherwise>
														</c:choose>
													</td>
												</tr>
											</c:forEach>
										</tbody>
									</table>
								</td>
								<spring:url htmlEscape="true" var="json" value="${signRequest.signBooksJson}" />
								<td class="type">
								<input type="hidden" id="signbook_${signRequest.id}" value="${json}" />
								<c:if test="${not empty signRequest.signRequestParams.signType}">
									<div class="alert alert-secondary text-center" id="type_${signRequest.id}" title="${signRequest.signRequestParams.signType}">
										<small><spring:message code="label_org_esupportail_esupsignature_domain_signbook_signtype_${signRequest.signRequestParams.signType}" /></small>
									</div>
								</c:if>	
								</td>
								<td class="status" style="width: 150px;">
									<jsp:include page="includes/status.jspx" />
								</td>
								<td class="utilbox">
									<button class="btn btn-info far fa-eye" title="Sign Request" alt="Sign Request" onclick="location.href='/user/signrequests/${signRequest.id}'">
										<!--  -->
									</button>
								</td>
								<td class="utilbox"><form class="delete" action="/user/signrequests/${signRequest.id}" method="post">
										<input type="hidden" name="_method" value="DELETE" />
										<button onclick="return confirm('Voulez-vous vraiment supprimer cet element ?');" value="Supprimer Sign Request" type="submit" title="Supprimer Sign Request" class="btn btn-danger far fa-trash-alt" alt="Supprimer Sign Request" />
									</form></td>
							</tr>
						</c:forEach>
					</tbody>
					<tfoot>
						<tr>
							<td colspan="100%">
								<c:if test="${not empty maxPages}">
									<util:pagination numberOfResult="false" maxPages="${maxPages}" page="${param.page}" size="${param.size}" />
								</c:if> <c:if test="${not empty param.page}">
									<input name="page" type="hidden" value="1" />
								</c:if> <c:if test="${not empty param.size}">
									<input name="size" type="hidden" value="${fn:escapeXml(param.size)}" />
								</c:if>
							</td>
						</tr>
					</tfoot>
				</table>
			</div>
			<page:list id="pl_org_esupportail_esupsignature_domain_SignRequest" items="${signRequests}" z="user-managed" />
		</div>
		</div>
	</div>
	<script type="text/javascript">
		var selectAll = document.getElementById("selectall");
		var checkBoxes = document.querySelectorAll(".check");
		var openDocsButton = document.getElementById("opendocs");
		var signDocsButton = document.getElementById("signdocs");
		var alertSignDocsButton = document.getElementById("alertsigndocs");
		var passwordField = document.getElementById("passwordField");
		
		if (selectAll != null) {
			passwordField.style.display = "none";	
			openDocsButton.style.display = "none";
			selectAll.onchange = function() {
				[].forEach.call(checkBoxes, function(checkBox) {
					if (selectAll.checked) {
						checkBox.checked = true;
					} else {
						checkBox.checked = false;
					}
				});
				checkOpenDocButtonEnable();
				checkSignDocButtonEnable();
			};
		}
		
		[].forEach.call(checkBoxes, function(checkBox) {
			checkBox.addEventListener('click', function(event) {
				checkOpenDocButtonEnable();
				checkSignDocButtonEnable();
			});
		});
		
		function checkOpenDocButtonEnable() {
			for (i = 0; i &lt; checkBoxes.length; i++) {
				if(checkBoxes[i].checked) {
					openDocsButton.style.display = "block";
					break;
				} else {
					openDocsButton.style.display = "none";
				}
			}
		}
		
		function checkSignDocButtonEnable() {
			signDocsButton.style.display = "none";
			passwordField.style.display = "none";
			alertSignDocsButton.style.display = "none";
			var oldSignBook = "";
			var oldType = "";
			for (i = 0; i &lt; checkBoxes.length; i++) {
				if(checkBoxes[i].checked) {
					var status = document.getElementById("status_" + checkBoxes[i].value).title;
					var signBook = document.getElementById("signbook_" + checkBoxes[i].value).title;
					var type = document.getElementById("type_" + checkBoxes[i].value).title;
					if(type == 'certSign') {
						passwordField.style.display = "block";
					} else {
						passwordField.style.display = "none";
					}
					var signBookId=signBook.split(',');
					if(status != "pending" || (oldType != "" &amp;&amp; oldType != type )) {
						signDocsButton.style.display = "none";
						alertSignDocsButton.style.display = "block";
						passwordField.style.display = "none";
						break;
					} else {
						oldSignBook = signBook;
						oldType = type;
						alertSignDocsButton.style.display = "none";
						signDocsButton.style.display = "block";
					}
				}
				
			}
		}
	
		var checkBoxes = document.querySelectorAll(".check");
		var getProgressTimer = null;
		function openCheckedDocs() {
			[].forEach.call(checkBoxes, function(checkBox) {
				if (checkBox.checked) {
					window.open('/user/signrequests/get-last-file/'
							+ checkBox.value, '_blank');
				}
			});
		}
	
	
		function submitSignRequests() {
			var toSignResquest = new Array();
			[].forEach.call(checkBoxes, function(checkBox) {
				if (checkBox.checked) {
					toSignResquest.push(checkBox.value);
				}
			});
			var signRequestParams = "ids=" + toSignResquest + "&amp;password="
					+ document.getElementById("passwordField").value;
			sendData(signRequestParams);
	
		}
	
		function sendData(signRequestParams) {
			document.getElementById("passwordError").style.display = "none";
			document.getElementById("closeModal").style.display = "none";
			document.getElementById("bar").style.display = "none";
			document.getElementById("loader").style.display = "block";
			getProgressTimer = setInterval(function() {
				getProgress();
			}, 1000);
			var xmlHttp = new XMLHttpRequest();
			xmlHttp.open('POST', '/user/signrequests/sign-multiple', true);
			xmlHttp.setRequestHeader('Content-Type',
					'application/x-www-form-urlencoded');
			xmlHttp.send(signRequestParams);
		}
	
		function getProgress() {
			console.log("getProgress");
			var xmlHttp = new XMLHttpRequest();
			xmlHttp.open("GET", "get-progress", false);
			xmlHttp.onreadystatechange = function() {
				var result = xmlHttp.responseText;
				if (result == "security_bad_password") {
					document.getElementById("passwordError").style.display = "block";
					document.getElementById("closeModal").style.display = "block";
					document.getElementById("loader").style.display = "none";
					clearInterval(getProgressTimer);
				} else if (result == "100") {
					document.getElementById("closeModal").style.display = "block";
					document.getElementById("bar").style.display = "block";
					document.getElementById("bar").style.width = result + "%";
					document.getElementById("bar-text").innerHTML = result + "%";
					document.getElementById("loader").style.display = "none";
					clearInterval(getProgressTimer);
					window.location.reload()
				} else {
					document.getElementById("bar").style.display = "block";
					document.getElementById("bar").style.width = result + "%";
					document.getElementById("bar-text").innerHTML = result
							+ "%";
				}
			}
			xmlHttp.send(null);
			return;
		}
	</script>
	<div id="wait" class="modal fade" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-body text-center">
					<h5>Signature en cours</h5>
					<div class="progress">
						<div class="progress-bar progress-bar-striped active" style="width: 0%;" id="bar">
							<span id="bar-text"> <!--  -->
							</span>
						</div>
					</div>
					<div id="loader" class="loader">
						<!--  -->
					</div>
					<div style="display: none;" id="passwordError" class="alert alert-danger" role="alert">
						<spring:message code="security_bad_password" />
					</div>
					<button onclick="javascript:window.location.reload()" id="closeModal" type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
	<table:table render="false" data="${signRequests}" id="l_org_esupportail_esupsignature_domain_SignRequest" path="/user/signrequests" update="false" z="user-managed">
		<table:column id="c_org_esupportail_esupsignature_domain_SignRequest_name" property="name" z="user-managed" />
		<table:column date="true" dateTimePattern="dd/MM/YYYY HH:mm" id="c_org_esupportail_esupsignature_domain_SignRequest_createDate" property="createDate" z="user-managed" />
		<table:column id="c_org_esupportail_esupsignature_domain_SignRequest_createBy" property="createBy" z="user-managed" />
		<table:column render="false" date="true" dateTimePattern="${signRequest_updatedate_date_format}" id="c_org_esupportail_esupsignature_domain_SignRequest_updateDate" property="updateDate" z="user-managed" />
		<table:column render="false" id="c_org_esupportail_esupsignature_domain_SignRequest_updateBy" property="updateBy" z="user-managed" />
		<table:column render="false" id="c_org_esupportail_esupsignature_domain_SignRequest_description" property="description" z="user-managed" />
		<table:column render="false" id="c_org_esupportail_esupsignature_domain_SignRequest_signType" property="signTypeLabel" z="user-managed" />
		<table:column cssClass="status" id="c_org_esupportail_esupsignature_domain_SignRequest_status" property="status" z="user-managed" />
	</table:table>
</div>
