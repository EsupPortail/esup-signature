<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<!--/*@thymesVar id="workflow" type="org.esupportail.esupsignature.entity.Workflow"*/-->
<!--/*@thymesVar id="workflows" type="java.util.List<org.esupportail.esupsignature.entity.Workflow>"*/-->
<div id="new-workflow" th:fragment="new-workflow" class="clear">
    <div class="d-inline-flex flex-wrap">
        <th:block th:each="workflow : ${workflows}">
            <div th:id="'btn-workflow2-' + ${workflow.id}" class="workflow-button" style="height: 184px;">
                <div class="favorite-icon">
                    <button th:title="${user.uiParams.get(T(org.esupportail.esupsignature.entity.enums.UiParams).favoriteWorkflows) != null && user.uiParams.get(T(org.esupportail.esupsignature.entity.enums.UiParams).favoriteWorkflows).contains('' + workflow.id)} ? 'Supprimer des favoris' : 'Ajouter aux favoris'"
                            class="btn btn-transparent btn-sm text-dark toggle-workflow-start rounded-2"
                            style="margin-top: -6px; margin-left: -6px;"
                            type="button"
                            th:id="'star_' + ${workflow.id}">
                        <i class="fa-solid fa-star" th:classappend="${user.uiParams.get(T(org.esupportail.esupsignature.entity.enums.UiParams).favoriteWorkflows) != null && user.uiParams.get(T(org.esupportail.esupsignature.entity.enums.UiParams).favoriteWorkflows).contains('' + workflow.id)} ? 'text-warning' : 'text-secondary'"></i>
                    </button>
                </div>
                <a tabindex="10" role="button" class="workflow-btn start-wizard-workflow-button btn btn-material border border-secondary-subtle border-opacity-10 btn-light text-center me-2 mb-2 overflow-hidden p-0 workflow-button"
                    data-bs-toggle="modal"
                    data-bs-target="#wiz-workflow-sign-modal"
                    th:id="'workflow-button-' + ${workflow.id}"
                    th:href="'/user/start-workflow/' + ${workflow.id}"
                    style="width: 120px; height: 170px;"
                    th:title="'Lancer le circuit : ' + ${workflow.description}"
                    th:data-es-workflow-id="${workflow.id}"
                    >
                    <div class="d-flex flex-column align-items-center justify-content-center h-100 w-100 gap-3">
                        <i class="fi fi-tr-diagram-project project-diagram-color" style="font-size: 50px;"></i>
                        <h6 style="height: 50px;" th:text="${workflow.description}"></h6>
                    </div>
                </a>
            </div>
        </th:block>
        <script>
            document.querySelectorAll('.toggle-workflow-start').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.id.replace('star_', '');
                    const icon = btn.querySelector('i');
                    const favoriteItem = $('#myFavoritesWorkflows [data-es-workflow-id="' + id + '"]');

                    try {
                        const response = await fetch(`/user/toggle-favorite-workflow/${id}`, {
                            method: 'GET',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });

                        if (response.ok) {
                            if (icon.classList.contains('text-secondary')) {
                                const noFavoritesWorkflows = document.getElementById('noFavoritesWorkflows');
                                if(noFavoritesWorkflows) noFavoritesWorkflows.remove();
                                icon.classList.remove('text-secondary');
                                icon.classList.add('text-warning');
                                btn.title = 'Supprimer des favoris';
                                favoriteItem.parent().removeClass("d-none");
                            } else {
                                icon.classList.remove('text-warning');
                                icon.classList.add('text-secondary');
                                btn.title = 'Ajouter aux favoris';
                                favoriteItem.parent().addClass("d-none");
                            }
                        }
                    } catch (err) {
                        console.error('Erreur lors de la mise en favori :', err);
                    }
                });
            });
        </script>
        <th:block th:if="${workflows != null && workflows.size() == 0}">
            <div class="alert alert-secondary">
                <h6>Aucun circuit</h6>
            </div>
        </th:block>
    </div>
</div>
</html>
