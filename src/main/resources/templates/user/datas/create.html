<!doctype html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head"></head>
<script th:inline="javascript" type="module">
    import {CreateDataUi} from "/static/js/modules/ui/datas/CreateDataUi.js";
    new CreateDataUi([[${form.action}]], null, [[${fields}]]);
</script>
<body>
<header th:replace="fragments/nav"></header>
<main role="main">
    <div class="wrapper">
        <nav th:insert="fragments/side"></nav>
        <nav id="breadcrumb" aria-label="breadcrumb" class="breadcrumb-nav">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/user/datas">Mes brouillons</a></li>
                <li class="breadcrumb-item active" aria-current="page">Formulaire&nbsp;<span th:text="${form.title}"></span>&nbsp;<span th:if="${data.name}" th:text="' : ' + ${data.name}"></span>
                </li>
            </ol>
        </nav>
        <div class="content" id="content">
            <div th:if="${data.status == null && (data.signBook == null || data.signBook.signRequests.size() == 0)}" class="fixed-action-btn" >
                <a th:if="${form.needName}" role="button" title="Enregistrer les modifications" type="button" class="btn-floating btn-lg bg-success wave-effect" data-toggle="modal" data-target="#saveModal">
                    <i class="fas fa-save"></i><br/>
                </a>
                <a th:unless="${form.needName}" onclick="return false;" id="saveButton" href="#" title="Enregistrer les modifications" class="btn-floating btn-lg bg-success wave-effect">
                    <i class="fas fa-save"></i><br/>
                </a>
            </div>
            <div id="addButton" th:unless="${data.status == null}" class="fixed-action-btns active">
                <ul class="">
                    <li>
                        <a id="sendModalButton" href="#" role="button" title="Démarrer la procédure" th:if="${data.signBook == null || data.signBook.signRequests.size() == 0}" type="button" data-toggle="modal" data-target="#sendModal" class="btn-lg btn-floating bg-primary wave-effect">
                            <i class="fas fa-play"></i></a>
                    </li>
                    <li>
                        <a th:if="${form.needName}" role="button" title="Enregistrer les modifications" type="button" class="btn-lg btn-floating bg-success wave-effect" data-toggle="modal" data-target="#saveModal">
                            <i class="fas fa-save"></i>
                        </a>
                        <a th:unless="${form.needName}" onclick="return false;" id="saveButton" href="#" title="Enregistrer les modifications" class="btn-floating btn-lg bg-success wave-effect">
                            <i class="fas fa-save"></i>
                        </a>
                    </li>
                    <li>
                        <a class="btn-floating btn-lg bg-danger wave-effect" href="#deleteModal" role="button" title="Supprimer" data-toggle="modal" data-target="#deleteModal">
                            <i class="fas fa-trash-alt"></i>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="card-body container">
                <form id="newData" th:action="'/user/datas/form/' + ${form.id}" method="post">
                    <input id="newDataSubmit" type="submit" style="display: none;"/>
                    <input id="dataId" type="hidden" name="dataId" th:value="${data.id}"/>
                    <input id="name" type="hidden" name="name" th:value="${data.name}" required/>
                    <th:block th:each="field : ${fields}">
                        <div class="form-group">
                            <input th:if="${field.type.name() == 'checkbox'}" type="checkbox" class="form-check-input" th:name="${field.name}" th:placeholder="${field.name}" th:required="${field.required}"/>
                            <label th:for="${field.name}" th:text="${field.name}"></label>
                            <input th:if="${field.type.name() == 'text'}" type="text" class="form-control" th:name="${field.name}" th:value="${field.defaultValue}" th:placeholder="${field.label}" th:required="${field.required}"/>
                        </div>
                    </th:block>
                </form>
            </div>
        </div>
    </div>
</main>
<div th:if="${data.status != null && data.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).draft}" class="modal fade" id="sendModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3 class="modal-title">Démarrer le circuit</h3>
                <button type="button" class="close" data-dismiss="modal"
                        aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form th:action="'/user/datas/' + ${data.id} + '/send'" method="post" id="send">
                <div class="modal-body">
                    <p>
                        La procédure "<span th:text="${form.title}"></span>" comporte <span th:text="${steps.size()}"></span> étape<span th:if="${steps.size()} > 1">s</span>
                    </p>
                    <th:block th:each="step,iterator : ${steps}">
                        <div class="form-group">
                            <span th:text="'Etape ' + ${iterator.index + 1} + ' : ' + ${step.description}"></span>
                        </div>
<!--                        <div th:if="${step.changeable == true}" class="form-group">-->
<!--                            <span th:text="'Etape ' + ${iterator.index + 1} + ' : ' + ${step.description}"></span>-->
<!--                        </div>-->
<!--                        <div th:unless="${step.changeable == true}" class="form-group d-inline">-->
<!--                            <span th:text="'Etape ' + ${iterator.index + 1} + ' : ' + ${step.description} + ' ('"></span>-->
<!--                            <th:block th:if="${step.recipients.size() > 0}" th:each="recipient,iterator : ${step.recipients}">-->
<!--                                <span th:if="${iterator.index > 0}"> ou </span>-->
<!--                                <span th:text="${recipient.user.firstname} + ' ' + ${recipient.user.name}"></span>-->
<!--                            </th:block>-->
<!--                            <span>)</span>-->
<!--                        </div>-->
                        <br/>
                    </th:block>
                    <hr>
                    <th:block th:each="step,iterator : ${steps}">
                        <div th:if="${step.changeable == true}" class="form-group">
                            <label><span th:text="'L\' étape ' + ${iterator.index + 1} + ' est modifiable '"></span><span th:if="${step.name}" th:text="' : ' + ${step.name}"></span></label>
                            <select class="select-users" th:id="'recipientEmailsSelect_' + ${steps.getCurrentStepNumber()}" multiple="multiple" name="recipientEmails" required="required" >
                                <th:block th:each="recipient : ${step.recipients}">
                                    <option th:if="${recipient.user.email != null}" selected="selected" th:text="${recipient.user.email}" th:value="${iterator.index + 1} + '*' + ${recipient.user.email}"></option>
                                </th:block>
                            </select>
                            <p class="small">
                                Les signataires sont pré-sélectionnés en fonction de vos précédentes saisies.
                            </p>
                        </div>
                    </th:block>
                    <div th:if="${form.targetType.name() == 'mail'}" class="form-group">
                        <label>Etape finale : Envoi par mail à </label>
                        <select id="targetEmailsSelect" multiple="multiple" name="targetEmails" required>
                            <th:block th:each="targetEmail : ${targetEmails}">
                                <option selected="selected" th:text="${targetEmail}" th:value="${targetEmail}"></option>
                            </th:block>
                        </select>
                        <script th:inline="javascript" type="module">
                            import {default as SelectUser} from "/static/js/modules/utils/SelectUser.js";
                            new SelectUser("targetEmailsSelect");
                        </script>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary float-left" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">Valider</button>
                </div>
            </form>
            <script type="javascript">
                $("#send").on('submit', function(e){
                    e.preventDefault();
                    alert("Merci de saisir les participants");
                    if( $(e.target).is(':invalid') ){
                        alert("Merci de saisir les participants");
                    }
                });
            </script>
        </div>
    </div>
</div>
<div id="saveModal" class="modal fade" tabindex="-1" role="dialog" data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Enregistrement du document</h5>
            </div>
            <form id="saveForm">
                <div class="modal-body text-center">
                    <div class="form-group">
                        <input id="tempName" autocomplete="no" class="form-control" type="text" name="name" placeholder="Saisir un nom pour ce document" th:value="${data.name}" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary align-self-center" data-dismiss="modal">
                        Fermer
                    </button>
                    <button type="submit" class="btn btn-success">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal modal-warning fade in" id="deleteModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="command" th:action="'/user/datas/'+ ${data.id}" th:method="delete">
                <div class="modal-header">
                    <h2>Attention</h2>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">Confirmez-vous la suppression de ce brouillon ?</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary float-left" data-dismiss="modal">Non</button>
                    <button type="submit" class="btn btn-danger">Oui</button>
                </div>
            </form>
        </div>
    </div>
</div>
<footer th:replace="fragments/footer"></footer>
</body>
</html>
