<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head"></head>
<body>
	<nav th:replace="fragments/menu :: menu(activeMenu)"></nav>
	<div id="ribbon" class="card">
		<div class="card-body">
			<div class="alert alert-primary float-left">
				Signature NexU en cours <br> <small>L'application Nexu
					va s'ouvrir, vous pouvez utiliser un keystore ou une clé materielle<br>
					Vous devez saisir votre mot de passe plusieurs fois pendant la
					procédure
				</small>
			</div>
		</div>
	</div>

	<main role="main" class="container"> <script
		type="text/javascript"
		src="https://ajax.microsoft.com/ajax/jquery/jquery-1.11.1.min.js">
	<!-- -->
		
	</script>
	<div class="card">
	<div class="card-header">Progression de la procédure de signature</div>
		<div class="card-body">
			<div class="progress">
				<div class="progress-bar progress-bar-striped active"
					style="width: 10%;" id="bar">
					<span id="bar-text">Loading certificates...</span>
				</div>
			</div>
			<div id="error" style="display: none" class="text-center">
			<div class="alert alert-danger" role="danger">
				<strong id="errorText">Une erreur c'est produite lors de la signature</strong>
				<br>
				<small>Erreur : <span id="errorcontent"></span></small>
				</div>
<br>
				<a onclick="location.reload();" class="btn btn-danger btnSeccion text-white" id="btnSeccion4">
				<i class="fas fa-sync-alt fa-2x"></i><br> Relancer
							</a>
			</div>
			<div class="alert alert-success text-center" role="danger"
				id="success">
				<strong>Signature effectuée</strong> <br /> <a
					th:href="${referer}"
					class="btn btn-success btnSeccion" id="btnSeccion3"> Retour
				</a>
			</div>
		</div>
	</div>
	</main>
	<script type="text/javascript" th:src="${nexuUrl} + '/nexu.js'"></script>
	<script type="text/javascript">
		/*<![CDATA[*/
	var tokenId;
	var keyId;

	window.onload = function() {
		$("#success").hide();
		getCertificates();
	};

	function getCertificates() {
		updateProgressBar("Chargement des certificats", "25%");
		nexu_get_certificates(getDataToSign, error);
	}

	function getDataToSign(certificateData) {
		if(certificateData.response == null) {
			$('#bar').removeClass('progress-bar-success active').addClass('progress-bar-danger');
			$('#bar-text').html("Error");
			document.getElementById("errorcontent").innerHTML = "error while reading the Smart Card";
			$("#error").show();
		} else {
			updateProgressBar("Préparation de la signature", "35%");
			var signingCertificate = certificateData.response.certificate;
			var certificateChain = certificateData.response.certificateChain;
			var encryptionAlgorithm = certificateData.response.encryptionAlgorithm;
			tokenId = certificateData.response.tokenId.id;
			keyId = certificateData.response.keyId;
			var toSend = { signingCertificate: signingCertificate, certificateChain: certificateChain, encryptionAlgorithm: encryptionAlgorithm };

			callUrl("[[${rootUrl}]]/user/nexu-sign/get-data-to-sign", "POST",  JSON.stringify(toSend), sign, error);
		}
	}

	function sign(dataToSignResponse) {
		if (dataToSignResponse == null) {
			$('#bar').removeClass('progress-bar-success active').addClass('progress-bar-danger');
			$('#bar-text').html("Error");
			$("#errorcontent").text("unable to compute the data to sign (see server logs)");
			$("#error").show();
		} else {
			updateProgressBar("Signature du/des documents(s)", "50%");
			var digestAlgo = "SHA256";
			nexu_sign_with_token_infos(tokenId, keyId, dataToSignResponse.dataToSign, digestAlgo, signDocument, error);
		}
	}

	function signDocument(signatureData) {
		updateProgressBar("Enregistrement du/des documents(s)", "75%");
		var signatureValue = signatureData.response.signatureValue;
		var toSend = {signatureValue:signatureValue};
		callUrl("[[${rootUrl}]]/user/nexu-sign/sign-document", "POST", JSON.stringify(toSend), downloadSignedDocument, error);
	}

	function downloadSignedDocument(signDocumentResponse) {
		updateProgressBar("Signature terminée", "100%");
		$('#bar').removeClass('progress-bar-striped active');
		$('#bar').addClass('progress-bar-success');
		$("#success").show();
	}

	function error(error) {
		console.log(error);
		$('#bar').removeClass('progress-bar-success active').addClass('progress-bar-danger');
		if (error!= null && error.responseJSON !=null) {
			var jsonResp = error.responseJSON;
			if (jsonResp.errorMessage != null){
				$("#errorcontent").html(jsonResp.errorMessage);
			}
			else if (jsonResp.error != null){
				$("#errorcontent").html(jsonResp.error);
			}
		}
		$("#error").show();
		$("#success").hide();
	}

	function updateProgressBar(action, percent) {
		$('#bar-text').html(action);
		$('#bar').width(percent);
	}
		/*]]>*/
	</script>
</body>
</html>
