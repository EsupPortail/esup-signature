<!doctype html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head"></head>
<body>
<main role="main">
        <div aria-expanded="true" class="collapse" id="collapseHelp">
            <div class="alert alert-info">Pour modifier la position de la signature, cliquez sur le document. Selon le type de signature, le lancement de l'application NexU ou un mot de passe peut être demandé.</div>
        </div>
        <div class="content" id="content">
            <div th:if="${paramsOk == false}">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="embedresize">
                            <div>
                                <iframe allowfullscreen="" frameborder="0" th:src="'/user/documents/getfile/' + ${documentId}" width="560"></iframe>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="alert alert-danger" th:if="${signRequest.parentSignBook.currentWorkflowStep.signType.name() == 'pdfImageStamp'}">
                            <h6>Une signature visuelle est obligatoire pour signer ce document mais votre profil ne contient pas d'image de votre signature</h6>
                            Vous pouvez ajouter une image en accédant à vos paramètres : <a href="/user/users/?form" target="_blank">Modifier vos paramètres</a>
                        </div>
                        <div class="alert alert-danger" th:if="${keystore == null && signRequest.parentSignBook.currentWorkflowStep.signType.name() == 'certSign'}">
                            <h6>La signature demandée requière un certificat</h6>
                            Vous pouvez ajouter un keystore en accédant à vos paramètres : <a href="/user/users/?form" target="_blank">Modifier vos paramètres</a>
                        </div>
                        <div class="alert alert-warning" th:if="${signRequest.parentSignBook.currentWorkflowStep.signType.name() != 'pdfImageStamp' && user.signImage == null}">
                            <h6>Une signature visuelle est possible pour signer ce document mais votre profil ne contient pas d'image de votre signature</h6>
                            Vous pouvez signer aussi signer sans marque visuelle
                            <a href="/user/users/?form" target="_blank">Modifier vos paramètres</a>
                        </div>
                    </div>

                </div>
            </div>
            <form th:if="${signable == 'ok' && paramsOk == false}" id="signForm" th:action="'/user/signrequests/sign/' + ${signRequest.id}" method="post">
                <input type="hidden" name="referer" th:value="${referer}">
                <input type="checkbox" name="visual" id="_visual" style="display: none;"/>
                <input type="checkbox" name="addDate" id="_addDate" style="display: none;"/>
            </form>
            <form th:if="${signable == 'ok' && paramsOk == true}" id="signForm" th:action="'/user/signrequests/sign/' + ${signRequest.id}" method="post">
                <input type="hidden" name="referer" th:value="${referer}">
                <div th:if="${documentType == 'pdf'}">
                    <div class="sign-menu">
                        <div class="btn btn-light col-3 col-md-12 m-1" th:if="${signRequest.parentSignBook.currentWorkflowStep.signType.name() != 'pdfImageStamp'}">
                            <label class="control-label" for="_visual" >Insérer un visuel</label>
                            <br/>
                            <label class="switch">
                                <input onclick="toggleVisual();" type="checkbox" name="visual" id="_visual"/>
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="btn btn-light col-3 col-md-12 m-1">
                            <label class="control-label" for="_zoom" >Zoom</label>
                            <br/>
                            <label class="switch">
                                <input onclick="toggleZoom();" type="checkbox" name="zoom" id="_zoom"/>
                                <span class="slider round"></span>
                            </label>
                        </div>

                        <div class="btn btn-light col-3 col-md-12 m-1">
                            <label class="control-label" for="_addDate">Afficher la date</label>
                            <br/>
                            <label class="switch">
                                <input onclick="activeDate();" type="checkbox" name="addDate" id="_addDate"/>
                                <span class="slider round"></span>
                            </label>
                        </div>

                        <div th:if="${imagePagesSize > 1}" class="btn btn-light col-12 m-1">
                            <label class="control-label">Navigation</label>
                            <ul class="pagination justify-content-center">
                                <li class="page-item">
                                    <a id="previous" onclick="previousImage();" class="btn btn-outline-dark m-1" aria-label="Précédent">
                                        <i class="fas fa-arrow-left"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a id="next" onclick="nextImage();" class="btn btn-outline-dark m-1" aria-label="Prochain">
                                        <i class="fas fa-arrow-right"></i>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="sign-preview">
                        <div th:if="${documentType == 'pdf'}">
                            <div id="pointer_div" onmouseup="savePosition();" ontouchend="savePosition();" ontouchmove="pointIt(event);" onmousemove="pointIt(event);"
                                 th:style="'background-size: ' + ${pdfWidth} + 'px;background-image:url(\'/user/documents/' + ${documentId} + '/getimagepdfpage/' + ${signRequest.parentSignBook.currentWorkflowStep.signRequestParams.signPageNumber -1} + '\');width:' + ${pdfWidth} + 'px;height:' + ${pdfHeight} + 'px;border:1px solid #CCC;pointer-events: none;'">
                                <th:block th:if="${signable == 'ok' && signRequest.status.name() != 'signed' && signRequest.parentSignBook.currentWorkflowStep.signType.name() != 'visa'}">
                                    <div onclick="dragSignature();" id="cross" ontouchstart="this.style.backgroundColor= 'rgba(0, 255, 0, .5)'; dragSignature();" ontouchend="savePosition();" onmousedown="dragSignature();" onmouseup="savePosition();"
                                         onmouseover="this.style.backgroundColor= 'rgba(0, 255, 0, .5)';"
                                         onmouseout="this.style.backgroundColor= 'rgba(255, 0, 0, .0)';"
                                         th:style="'background-repeat: no-repeat; background-position: left bottom; background-size: ' + ${signWidth} + 'px;background-image: url(\'data:image/png;base64,' + ${signFile} + '\'); width: ' + ${signWidth} + 'px; height: ' + ${signHeight} + 'px; line-height: ' + ${signHeight} + 'px; text-align: center; left: ' + ${signRequest.parentSignBook.currentWorkflowStep.signRequestParams.XPos} + 'px;top: ' + ${signRequest.parentSignBook.currentWorkflowStep.signRequestParams.YPos} + 'px;position:relative;pointer-events: auto;cursor: move;'">
                                        <div id="borders" class="anim-border" th:style="'text-align:left;line-height:normal;width: ' + ${signWidth} + 'px; height: ' + ${signHeight} + 'px;'"></div>
                                    </div>
                                </th:block>
                                <th:block th:if="${signable == 'ok' && signRequest.status.name() != 'signed' && signRequest.parentSignBook.currentWorkflowStep.signType.name() == 'visa'}">
                                    <div onclick="dragSignature();" id="cross" ontouchstart="this.style.backgroundColor= 'rgba(0, 255, 0, .5)'; dragSignature();" ontouchend="savePosition();" onmousedown="dragSignature();" onmouseup="savePosition();"
                                         th:style="'background-repeat: no-repeat; background-position: left bottom; background-size: 100px;background-image: url(\'/images/sceau.png\'); width: 100px; height: 75px; line-height: 75px; text-align: center; left: ' + ${signRequest.parentSignBook.currentWorkflowStep.signRequestParams.XPos} + 'px;top: ' + ${signRequest.parentSignBook.currentWorkflowStep.signRequestParams.YPos} + 'px;position:relative;pointer-events: auto;cursor: move;'">
                                        <div id="borders" class="anim-border"
                                             style="text-align:left;line-height:normal;width: 100px; height: 75px;user-select: none;-moz-user-select: none;-khtml-user-select: none;-webkit-user-select: none;-o-user-select: none;">
                                            <span id="textVisa" style="font-size: 8px;" th:text="'Visé par ' + ${user.firstname} + ' ' + ${user.name}"></span>
                                            <br>
                                        </div>
                                    </div>
                                </th:block>
                            </div>
                        </div>
                    </div>
                    <div class="d-none">
                        <div class="col-lg-4">
                            Page : <input readonly="readonly" autocomplete="off" class="form-control form-control-sm col-6" th:value="${signRequest.parentSignBook.currentWorkflowStep.signRequestParams.signPageNumber}" id="signPageNumber" type="text"
                                          name="signPageNumber"/>
                        </div>
                        <div class="col-lg-4">
                            X position : <input readonly="readonly" autocomplete="off" class="form-control form-control-sm col-6" th:value="${signRequest.parentSignBook.currentWorkflowStep.signRequestParams.XPos}" id="xPos" type="text" name="xPos"/>
                        </div>
                        <div class="col-lg-4">
                            Y position : <input readonly="readonly" autocomplete="off" class="form-control form-control-sm col-6" th:value="${signRequest.parentSignBook.currentWorkflowStep.signRequestParams.YPos}" id="yPos" type="text" name="yPos"/>
                        </div>
                    </div>
                </div>
                <div th:unless="${documentType == 'pdf'}">
                    <div class="alert alert-warning" role="alert">
                        <h4 class="alert-heading">Signature d'un document autre que PDF</h4>
                        <p>Vous allez signer un document qui n'est pas un PDF. Dans ce cas la signature visuelle n'est pas possible/</p>
                        <hr>
                        <p class="mb-0">Si vous signez à m'aide d'un certificat, le fichier sera encapsulé dans un zip au format ASIC-E</p>
                    </div>
                </div>
                <input id="csrf" th:value="${_csrf.token}" th:name="${_csrf.parameterName}" type="hidden"/>
                <div class="m-1">
                    <div th:if="${signRequest.parentSignBook.currentWorkflowStep.signType.name() == 'nexuSign'}">
                        <script type="text/javascript" src="/js/jsSignatureLevel.js"></script>
                        <script type="text/javascript" th:replace="user/signrequests/includes/scriptnexu :: scriptnexu"></script>
                        <div id="nexu_version_alert" style="display: none;">
                            <a onclick="location.reload();" class="mr-2 btn btn-warning btnSeccion float-left">
                                <i class="fas fa-sync-alt fa-2x"></i><br> Actualiser
                            </a>
                            <div class="alert alert-warning float-left">
                                L'application NexU n'a pas la bonne version.
                                <span th:text="${nexuVersion} + 'nécessaire'"></span>
                                <br>
                            </div>
                        </div>
                        <div id="nexu_missing_alert" style="display: none;">
                            <a onclick="location.reload();" class="mr-2 btn btn-warning btnSeccion float-left">
                                <i class="fas fa-sync-alt fa-2x"></i><br> Actualiser
                            </a>
                            <div class="alert alert-warning float-left">
                                L'application NexU n'a pas été détectée
                                <br>
                                <small>Merci de lancer l'application sur votre poste.
                                    <a href="https://github.com/nowina-solutions/nexu/releases/">Téléchargement</a>
                                </small>
                            </div>
                        </div>
                        <div id="nexu_ready_alert" style="display: none;">
                            <div class="alert alert-success float-left mb-1">
                                L'application NexU est fonctionnelle
                                <br/>
                                <small>Vous pouvez utiliser une clé materielle ou un keystore</small>
                            </div>
                            <button type="button" onclick="document.getElementById('signForm').submit();" class="btn btn-success float-left col-12 mb-1">
                                <i class="fas fa-signature"></i> Signer
                            </button>
                        </div>
                    </div>
                    <button title="Valider la signature" type="button" class="btn btn-success col-12 mb-1 text-left"
                            th:unless="${signRequest.parentSignBook.currentWorkflowStep.signType.name() == 'visa' || signRequest.parentSignBook.currentWorkflowStep.signType.name() == 'nexuSign' || signRequest.parentSignBook.currentWorkflowStep.signType.name() == 'certSign' || paramsOk == false}"
                            onclick="document.getElementById('signForm').submit();">
                        <i class="fas fa-signature"></i><span class="sidebar-label"> Valider la signature</span>
                    </button>
                    <button class="btn btn-success col-12 mb-1 text-left" th:if="${signRequest.parentSignBook.currentWorkflowStep.signType.name() == 'certSign' && keystore != null}" type="button" data-toggle="modal" data-target="#signModal">
                        <i class="fas fa-signature"></i><span class="sidebar-label"> Valider la signature</span>
                    </button>
                    <button title="Valider le document" type="button" class="btn btn-success col-12 mb-1 text-left"
                            th:if="${signRequest.parentSignBook.currentWorkflowStep.signType.name() == 'visa'}"
                            onclick="document.getElementById('signForm').submit();">
                        <i class="fas fa-check"></i><span class="sidebar-label"> Valider le document</span>
                    </button>
                </div>
            </form>
            <div th:unless="${signable == 'ok'}" class="col-lg-10">
                <div class="alert alert-danger">
                    Vous n'avez plus d'ation à effectuer sur cette demande, merci de fermer cette fenetre
                    <br/>
                    <input class="btn btn-danger text-center d-none" id="signe" title="Signe" type="submit" value="Fermer" onclick="window.close();"/>
                </div>
            </div>
        </div>
</main>
<script language="JavaScript" th:if="${paramsOk == true}">
    document.getElementById("_visual").checked = true
</script>
<script th:inline="javascript">
    /*<![CDATA[*/
    var zoom = 1;
    var nbImagePage = [[${imagePagesSize}]];
    var currentImagePage = [[${signRequest.parentSignBook.currentWorkflowStep.signRequestParams.signPageNumber}]] - 1;
    var documentUrl = "/user/documents/[[${documentId}]]/getimagepdfpage/";
    var signId = [[${signRequest.id}]];

    //pdf navigation;

    function toggleVisual() {
        document.getElementById("cross").classList.toggle('d-none');
        document.getElementById("_visual").toggleAttribute("checked");
    }

    function toggleZoom() {
        if (zoom == 1) {
            zoom = 2;
        } else {
            zoom = 1;
        }

        document.getElementById("pointer_div").style = "background-size: " + [[${pdfWidth}]] * zoom + "px;background-image:url('/user/documents/[[${documentId}]]/getimagepdfpage/" + currentImagePage + "');width:" + ([[${pdfWidth}]] * zoom) + "px;height: " + ([[${pdfHeight}]] * zoom) + "px;border:1px solid #CCC;";
        document.getElementById("cross").style.backgroundSize = "" + [[${signWidth}]] * zoom + "px";
        document.getElementById("cross").style.width = "" + [[${signWidth}]] * zoom + "px";
        document.getElementById("cross").style.height = "" + [[${signHeight}]] * zoom + "px";
        document.getElementById("cross").style.lineHeight = "" + [[${signHeight}]] * zoom + "px";
        document.getElementById("cross").style.left = "" + document.getElementById("xPos").value * zoom + "px";
        document.getElementById("cross").style.top = "" + document.getElementById("yPos").value * zoom + "px";
        document.getElementById("borders").style.width = "" + [[${signWidth}]] * zoom + "px";
        document.getElementById("borders").style.height = "" + [[${signHeight}]] * zoom + "px";
        var textDate = document.getElementById("textDate");
        if (textDate != null) {
            textDate.style.fontSize = 8 * zoom + "px";
        }
        var textVisa = document.getElementById("textVisa");
        if (textVisa != null) {
            textVisa.style.fontSize = 8 * zoom + "px";
        }

    }

    /*]]>*/
</script>
<div id="signModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-body text-center">
                <textarea placeholder="Vous pouvez ajouter un commentaire" class="form-control" name="comment" cols="" rows=""></textarea>

                <div th:switch="${signRequest.parentSignBook.currentWorkflowStep.signType.name()}">
                    <div th:case="'certSign'">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">Mot de passe</span>
                            </div>
                            <input class="form-control" required="required" placeholder="Vous allez signer à l'aide d'un certificat, merci d'entrer le mot de passe" id="password" name="password" type="password"/>
                            <div class="input-group-append">
                                <input data-toggle="modal" data-target="#wait" data-dismiss="modal" onclick="submitSignRequest();" alt="${signLabel}" class="btn btn-success" id="signe" title="Signe" type="button" value="Signer"/>
                            </div>
                        </div>
                    </div>
                    <div th:case="'nexuSign'">
                        <button type="submit" class="btn btn-success  text-center" data-target="#signatureModal">Signer</button>
                    </div>
                    <div th:case="*">
                        <div th:if="${signRequest.parentSignBook.currentWorkflowStep.signType.name() == 'visa'}">
                            <input alt="${visaLabel}" class="btn btn-success  text-center" id="signe" onclick="document.getElementById('signForm').submit();" type="button" value="Viser"/>
                        </div>
                        <div th:unless="${signRequest.parentSignBook.currentWorkflowStep.signType.name() == 'visa'}">
                            <div th:if="${user.signImage != null}">
                                <input alt="${signLabel}" class="btn btn-success  text-center" id="signe" onclick="document.getElementById('signForm').submit();" type="button" value="Signer"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary align-self-center" data-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<div id="wait" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body text-center">
                <h5>Signature en cours</h5>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated active" style="width: 100%;" id="bar">
                        <strong> <span id="bar-text"></span>
                        </strong>
                    </div>
                </div>
                <div style="display: none;" id="passwordError" class="alert alert-danger" role="alert">
                    Mauvais mot de passe
                </div>
                <div style="display: none;" id="signError" class="alert alert-danger" role="alert">
                    Erreur du système de signature
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeModal" type="button" class="btn btn-secondary align-self-center" data-dismiss="modal">
                    Fermer
                </button>
                <a id="validModal" th:href="${referer != null} ? ${referer} : '/user/signrequests/' + ${signRequest.id}" class="btn btn-success align-self-center">Terminer</a>
            </div>
        </div>
    </div>
</div>
</body>
</html>
