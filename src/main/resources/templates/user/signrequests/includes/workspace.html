<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<!--/*@thymesVar id="signRequest" type="org.esupportail.esupsignature.entity.SignRequest"*/-->
<div th:fragment="workspace">
    <div id="workspace" class="alert alert-secondary fadein" style="transition: all 0.3s;">
        <div class="row">
            <div class="col-lg-9">
                <form th:action="'/user/signrequests/comment/' + ${signRequest.id}" method="post" th:if="${documentType == 'pdf'}">
                    <canvas th:if="${signable != 'ok'}" title="Cliquez pour ajouter une annotation" id="pdf" style="border : 1px solid black;" class="drop-shadows ">
                    </canvas>
                    <canvas th:if="${signable == 'ok'}" title="Cliquez pour ajouter une annotation" id="pdf" style="border : 1px solid black;" onmouseup="action();" ontouchend="action();" ontouchmove="point(event);" onmousemove="point(event);" class="drop-shadows ">
                    </canvas>
                    <th:block th:if="${signable == 'ok' && signRequest.status.name() != 'signed' && @signRequestService.getCurrentSignType(signRequest).name() != 'visa'}">
                        <div onclick="dragSignature();" id="cross" ontouchstart="this.style.backgroundColor= 'rgba(0, 255, 0, .5)'; dragSignature();"
                             ontouchend="savePosition();" onmousedown="dragSignature();" onmouseup="savePosition();"
                             onmouseover="this.style.backgroundColor= 'rgba(0, 255, 0, .5)';"
                             onmouseout="this.style.backgroundColor= 'rgba(255, 0, 0, .0)';"
                             th:style="'display: none;background-repeat: no-repeat; background-position: left bottom; background-size: ' + ${signWidth} + 'px;background-image: url(\'data:image/png;base64,' + ${signFile} + '\'); width: ' + ${signWidth} + 'px; height: ' + ${signHeight} + 'px; line-height: ' + ${signHeight} + 'px; text-align: center; left: ' + ${@signRequestService.getCurrentSignRequestParams(signRequest).XPos + 100} + 'px;position:absolute;pointer-events: auto;cursor: move;'">
                            <div id="borders" class="anim-border" th:style="'text-align:left;line-height:normal;width: ' + ${signWidth} + 'px; height: ' + ${signHeight} + 'px;'"></div>
                        </div>
                    </th:block>
                    <th:block th:if="${signable == 'ok' && signRequest.status.name() != 'signed' && @signRequestService.getCurrentSignType(signRequest).name() == 'visa'}">
                        <div onclick="dragSignature();" id="cross" ontouchstart="this.style.backgroundColor= 'rgba(0, 255, 0, .5)'; dragSignature();"
                             ontouchend="savePosition();" onmousedown="dragSignature();" onmouseup="savePosition();"
                             onmouseover="this.style.backgroundColor= 'rgba(0, 255, 0, .5)';"
                             onmouseout="this.style.backgroundColor= 'rgba(255, 0, 0, .0)';"
                             th:style="'display: none;background-repeat: no-repeat; background-position: left bottom; background-size: 100px;background-image: url(\'/images/sceau.svg\'); width: 100px; height: 75px; line-height: 75px; text-align: center; left: ' + ${@signRequestService.getCurrentSignRequestParams(signRequest).XPos} + 'px;top: ' + ${@signRequestService.getCurrentSignRequestParams(signRequest).YPos} + 'px;position:absolute;pointer-events: auto;cursor: move;'">
                            <div id="borders" class="anim-border"
                                 th:style="'text-align:left;line-height:normal;width:  ' + ${signWidth} + 'px; height:  ' + ${signHeight} + 'px;user-select: none;-moz-user-select: none;-khtml-user-select: none;-webkit-user-select: none;-o-user-select: none;'">
                                <span id="textVisa" style="font-size: 8px;" th:text="'Visé par ' + ${user.firstname} + ' ' + ${user.name}"></span>
                                <br>
                            </div>
                        </div>
                    </th:block>
                    <script>
                        var url = '/user/documents/getfile/[[${documentId}]]';

                        var pdfDoc = null,
                            pageNum = 1,
                            pageRendering = false,
                            pageNumPending = null,
                            scale = 0.75,
                            rotation = 0;

                    </script>
                    <div id="postit" class="postit" style="display: none;position: absolute;left: 0px;top: 0px;z-index: 2;">
                        <span onclick="hideComment()" class="float-right" style="cursor: pointer;">X</span>
                        <textarea id="comment" name="comment" class="postitarea" placeholder="Saisir une annotation"></textarea>
                        <button type="submit" class="btn btn-sm float-right">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                    <th:block th:each="postit : ${postits}">
                        <div th:id="${postit.id}" class="circle" th:style="'position: absolute;z-index:1000;left:' + ${postit.posX} + 'px; top:' + ${postit.posY} + 'px;'"></div>
                    </th:block>

                    <input class="form-control form-control-sm col-6 d-none" value="0" id="signPageNumber" type="text" name="pageNumber"/>
                    <input class="form-control form-control-sm col-6 d-none" value="0" id="xPos" type="text" name="posX"/>
                    <input class="form-control form-control-sm col-6 d-none" value="0" id="yPos" type="text" name="posY"/>
                    <input class="form-control form-control-sm col-6 d-none" type="checkbox" name="visual" id="visual"/>
                    <input class="form-control form-control-sm col-6 d-none" type="checkbox" name="addDate" id="addDate"/>

                    <script th:inline="javascript" th:if="${signable == 'ok'}" >
                        /*<![CDATA[*/

                        var signId = [[${signRequest.id}]];
                        var signMode = false;
                        var refuseMode = false;
                        var pointItEnable = true;

                        var pdfjsLib = window['pdfjs-dist/build/pdf'];
                        pdfjsLib.GlobalWorkerOptions.workerSrc = '//mozilla.github.io/pdf.js/build/pdf.worker.js';

                        var canvas = document.getElementById('pdf');
                        var ctx = canvas.getContext('2d');

                        function renderPage(num) {
                            document.getElementById('signPageNumber').value = num;
                            pageRendering = true;
                            pdfDoc.getPage(num).then(function (page) {
                                var viewport = page.getViewport(scale, rotation);
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;
                                var renderContext = {
                                    canvasContext: ctx,
                                    viewport: viewport
                                };
                                var renderTask = page.render(renderContext);
                                renderTask.promise.then(function () {
                                    pageRendering = false;
                                    if (pageNumPending !== null) {
                                        // New page rendering is pending
                                        renderPage(pageNumPending);
                                        pageNumPending = null;
                                    }
                                });
                            });
                            document.getElementById('page_num').textContent = num;
                            refreshSign();
                            if(pdfDoc.numPages == 1) {
                                $('#prev').prop('disabled', true);
                                $('#next').prop('disabled', true);
                            }
                        }

                        function queueRenderPage(num) {
                            if (pageRendering) {
                                pageNumPending = num;
                            } else {
                                renderPage(num);
                            }
                        }

                        function prevPage() {
                            if (pageNum <= 1) {
                                return;
                            }
                            pageNum--;
                            queueRenderPage(pageNum);
                        }

                        document.getElementById('prev').addEventListener('click', prevPage);

                        function nextPage() {
                            if (pageNum >= pdfDoc.numPages) {
                                return;
                            }
                            pageNum++;
                            queueRenderPage(pageNum);
                        }

                        document.getElementById('next').addEventListener('click', nextPage);

                        function zoomIn() {
                            if (scale >= 1.75) {
                                return;
                            }
                            scale = scale + 0.25;
                            queueRenderPage(pageNum);
                        }

                        document.getElementById('zoomin').addEventListener('click', zoomIn);

                        function zoomOut() {
                            if (scale <= 0.75) {
                                return;
                            }
                            scale = scale - 0.25;
                            queueRenderPage(pageNum);
                        }

                        document.getElementById('zoomout').addEventListener('click', zoomOut);

                        function rotateLeft() {
                            if (rotation < -90) {
                                return;
                            }
                            rotation = rotation - 90;
                            queueRenderPage(pageNum);
                        }

                        document.getElementById('rotateleft').addEventListener('click', rotateLeft);

                        function rotateRight() {
                            if (rotation > 90) {
                                return;
                            }
                            rotation = rotation + 90;
                            queueRenderPage(pageNum);
                        }

                        document.getElementById('rotateright').addEventListener('click', rotateRight);

                        pdfjsLib.getDocument(url).promise.then(function (pdfDoc_) {
                            pdfDoc = pdfDoc_;
                            document.getElementById('page_count').textContent = pdfDoc.numPages;

                            // Initial/first page rendering
                            renderPage(pageNum);
                        });

                        var posX,
                            posY;

                        function action() {
                            if(signMode) {
                                savePosition();
                            } else {
                                displayComment();
                            }
                        }

                        function point(e) {
                            if(signMode) {
                                pointIt(e);
                            } else {
                                pointIt2(e)
                            }

                        }

                        function pointIt2(e) {
                            if (pointItEnable) {
                                console.log("mouse");
                                posX = e.offsetX ? (e.offsetX)
                                    : e.clientX - pointerDiv.offsetLeft;
                                posY = e.offsetY ? (e.offsetY)
                                    : e.clientY - pointerDiv.offsetTop;
                                console.log('point' + posX + ' : ' + posY);
                                document.getElementById("xPos").value = Math.round(posX / scale);
                                document.getElementById("yPos").value = Math.round(posY / scale);
                            }
                        }

                        function displayComment() {
                            if(signMode) {

                                return;
                            }
                            pointItEnable = false;
                            document.getElementById("postit").style.left = posX + "px";
                            document.getElementById("postit").style.top = posY + "px";
                            $("#postit").show();
                            //document.getElementById("postit").style.display = "block";
                        }

                        function hideComment() {
                            if(signMode) {
                                return;
                            }
                            pointItEnable = true;
                            $("#postit").hide();
                        }

                        function toggleSignMode() {
                            $('#workspace').toggleClass('alert-success alert-secondary');
                            if(refuseMode) {
                                toggleSignRefuseMode();
                            }
                            if(signMode) {
                                $('#signmod').prop( "checked", false );
                                signMode = false;
                                pointItEnable = true;
                                $('#cross').hide();
                                $('#comments').show();
                                $('#rotateleft').prop('disabled', false);
                                $('#rotateright').prop('disabled', false);
                                $('#signtools').fadeTo(300, 0);
                                $('#signtools').hide();
                            } else {
                                signMode = true;
                                pointItEnable = false;
                                //scale = 1;
                                rotation = 0;
                                queueRenderPage(pageNum);
                                $('#cross').show();
                                $('#comments').hide();
                                $('#rotateleft').prop('disabled', true);
                                $('#rotateright').prop('disabled', true);
                                $('#signtools').show();
                                $('#signtools').fadeTo(300, 1);
                                document.getElementById("xPos").value = Math.round([[${@signRequestService.getCurrentSignRequestParams(signRequest).XPos}]]);
                                document.getElementById("yPos").value = Math.round([[${@signRequestService.getCurrentSignRequestParams(signRequest).YPos}]]);

                            }
                        }

                        function toggleSignRefuseMode() {
                            $('#workspace').toggleClass('alert-danger alert-secondary');
                            if(signMode) {
                                toggleSignMode();
                            }
                            if(!refuseMode) {
                                refuseMode = true;
                                $('#signtools').fadeTo(300, 0);
                                $('#signtools').hide();
                                $('#refusetools').fadeTo(300, 1);
                                $('#refusetools').show();
                            }else{
                                refuseMode = false;
                                $('#refusetools').fadeTo(300, 0);
                                $('#refusetools').hide();
                            }

                        }

                        function refreshSign() {
                            $('#cross').css('left', [[${@signRequestService.getCurrentSignRequestParams(signRequest).XPos}]] * scale + 15);
                            $('#cross').css('top', [[${@signRequestService.getCurrentSignRequestParams(signRequest).YPos}]] * scale);
                            $('#cross').css('backgroundSize', [[${signWidth}]] * scale);
                            $('#cross').css('width', [[${signWidth}]] * scale);
                            $('#cross').css('height', [[${signHeight}]] * scale);
                            $('#borders').css('width', [[${signWidth}]] * scale);
                            $('#borders').css('height', [[${signHeight}]] * scale);
                            $('#textVisa').css('font-size', 8 * scale);
                        }

                        function toggleVisual() {
                            document.getElementById("cross").classList.toggle('d-none');
                            document.getElementById("_visual").toggleAttribute("checked");
                        }

                        function activeDate() {

                            var addDate = document.getElementById("_addDate");
                            var cross = document.getElementById("cross");
                            var borders = document.getElementById("borders");
                            var textDate;

                            if(addDate.checked) {
                                cross.style.width = 200;
                                cross.style.height = cross.offsetHeight + 20;
                                borders.style.width = 200;
                                borders.style.height = borders.offsetHeight + 20;
                                borders.insertAdjacentHTML("beforeend", "<span id='textDate' class='align-top' style='font-size:" + 8 * scale + "px;'>Le XX/XX/XXXX XX:XX</span>");

                            } else {
                                cross.style.width = 100;
                                cross.style.height = cross.offsetHeight - 20;
                                borders.style.width = 100;
                                borders.style.height = borders.offsetHeight - 20;
                                textDate = document.getElementById("textDate");
                                textDate.remove();
                            }
                        }


                        /*]]>*/
                    </script>
                </form>
                <form th:action="'/user/signrequests/comment/' + ${signRequest.id}" method="post" th:if="${documentType != 'pdf'}">
                    <script>
                        /*<![CDATA[*/

                        var signId = [[${signRequest.id}]];

                        var signMode = false;
                        var refuseMode = false;

                        function toggleSignMode() {
                            $('#workspace').toggleClass('alert-success alert-secondary');
                            if(refuseMode) {
                                toggleSignRefuseMode();
                            }
                            if(signMode) {
                                $('#signmod').prop( "checked", false );
                                signMode = false;
                                $('#comments').show();
                                $('#signtools').fadeTo(300, 0);
                                $('#signtools').hide();
                            } else {
                                signMode = true;
                                $('#comments').hide();
                                $('#signtools').show();
                                $('#signtools').fadeTo(300, 1);

                            }
                        }

                        function toggleSignRefuseMode() {
                            $('#workspace').toggleClass('alert-danger alert-secondary');
                            if(signMode) {
                                toggleSignMode();
                            }
                            if(!refuseMode) {
                                refuseMode = true;
                                $('#signtools').fadeTo(300, 0);
                                $('#signtools').hide();
                                $('#refusetools').fadeTo(300, 1);
                                $('#refusetools').show();
                            }else{
                                refuseMode = false;
                                $('#refusetools').fadeTo(300, 0);
                                $('#refusetools').hide();
                            }

                        }
                        /*]]>*/
                    </script>
                </form>
                <!--                        <ul class="list-group">-->
                <!--                            <li class="list-group-item list-group-item-primary">Liste des documents originaux</li>-->
                <!--                            <th:block th:each="document : ${signRequest.originalDocuments}">-->
                <!--                            <li class="list-group-item">-->
                <!--                                <a th:href="'/user/documents/getfile/' + ${document.id}" target="_blank"><i class="fas fa-file"></i> <span th:text="${document.fileName}"></span></a>-->
                <!--                            </li>-->
                <!--                        </th:block>-->
                <!--                            <br/>-->
                <!--                        </ul>-->
                <!--                        <ul class="list-group">-->
                <!--                            <li class="list-group-item list-group-item-success">Documents signés</li>-->
                <!--                            <th:block th:each="document : ${signRequest.signedDocuments}">-->
                <!--                                <li class="list-group-item">-->
                <!--                                    <a th:href="'/user/documents/getfile/' + ${document.id}" target="_blank"><i class="fas fa-file"></i> <span th:text="${document.fileName}"></span></a>-->
                <!--                                </li>-->
                <!--                            </th:block>-->
                <!--                        </ul>-->
            </div>
            <div class="col-lg-3">
                <div th:replace="user/signrequests/includes/statusdetails :: statusdetails"></div>
                <th:block th:if="${documentType != 'pdf'}">
                    <div id="signtools" style="display: none; opacity : 0;transition: all 0.3s;" >
                        <input th:classappend="${@signRequestService.getCurrentSignType(signRequest).name() != 'certSign' && @signRequestService.getCurrentSignType(signRequest).name() != 'nexuSign'} ? 'd-none'" class="form-control" type="password" id="password" name="password" value="" placeholder="Mot de passe du keystore"/>
                        <button class="mb-1 col-12 btn btn-lg btn-success" title="Signer" th:token="${signRequest.token}" onclick="launchSign(this.getAttribute('token'));">
                            <i class="fas fa-signature"></i> <span class="sidebar-label">Signer</span>
                        </button>
                    </div>

                </th:block>
                <div id="signtools" style="display: none; opacity : 0;transition: all 0.3s;" th:if="${documentType == 'pdf'}">
                    <div class="btn btn-light col-3 col-md-12 m-1" th:if="${@signRequestService.getCurrentSignType(signRequest).name() != 'pdfImageStamp'}">
                        <label class="control-label" for="_visual" >Insérer un visuel</label>
                        <br/>
                        <label class="switch">
                            <input onclick="toggleVisual();" type="checkbox" name="visual" id="_visual" checked/>
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <input th:if="${@signRequestService.getCurrentSignType(signRequest).name() == 'pdfImageStamp'}" class="d-none" type="checkbox" name="visual" id="_visual" checked/>

                    <div class="btn btn-light col-3 col-md-12 m-1">
                        <label class="control-label" for="_addDate">Afficher la date</label>
                        <br/>
                        <label class="switch">
                            <input onclick="activeDate();" type="checkbox" name="addDate" id="_addDate"/>
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <input th:classappend="${@signRequestService.getCurrentSignType(signRequest).name() != 'certSign' && @signRequestService.getCurrentSignType(signRequest).name() != 'nexuSign'} ? 'd-none'" class="form-control" type="password" id="password" name="password" value="" placeholder="Mot de passe du keystore"/>
                    <button class="mb-1 col-12 btn btn-lg btn-success" title="Signer" th:token="${signRequest.token}" onclick="launchSign(this.getAttribute('token'));">
                        <i class="fas fa-signature"></i> <span class="sidebar-label">Signer</span>
                    </button>
                </div>
                <div id="refusetools" style="display: none; opacity : 0;transition: all 0.3s;">
                    <button class="mb-1 col-12 btn btn-lg btn-danger" title="Refuser" th:token="${signRequest.token}" data-toggle="modal" data-target="#refuseModal">
                        <i class="fas fa-ban"></i> <span class="sidebar-label">Confirmer le refus</span>
                    </button>
                    <button class="mb-1 col-12 btn btn-lg btn-secondary" title="Annuler" onclick="toggleSignRefuseMode()">
                        <i class="fas fa-times"></i> <span class="sidebar-label">Annuler</span>
                    </button>
                </div>
                <div id="comments" th:if="${signable == 'ok' && documentType == 'pdf'}" style="transition: all 0.3s;">
                    <div class="alert alert-warning">Vous pouvez ajouter des commentaires en cliquant sur l'endroit concerné du document</div>
                    <div class="alert alert-warning clearfix">
                        <th:block th:each="postit : ${postits}">
                            <div th:id="'postit' + ${postit.id}" class="postit angle" style="position: relative;user-select: none;-moz-user-select: none;-khtml-user-select: none;-webkit-user-select: none;-o-user-select: none;cursor: pointer"
                                 th:onmouseover="'$(\'#' + ${postit.id} + '\').show(); queueRenderPage(' + ${postit.pageNumber} + ')'" th:onmouseout="'$(\'#' + ${postit.id} + '\').hide()'">
                                <b th:text="${@userService.getNameFromEppn(postit.eppn)}"></b>
                                <span th:text="${#dates.format(postit.logDate, 'dd/MM/yyyy HH:mm')}"></span>
                                <p class="postitarea" th:text="${postit.comment}"></p>
                            </div>
                            <script>
                                /*<![CDATA[*/
                                var c = document.getElementById("postit[[${postit.id}]]");
                                c.style.setProperty("--angle", Math.round(Math.random()) * 6 - 3 + "deg");
                                /*]]>*/
                            </script>
                        </th:block>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>