<!doctype html>
<!--/*@thymesVar id="signRequest" type="org.esupportail.esupsignature.entity.SignRequest"*/-->
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head"></head>
<body>
<header th:replace="fragments/menu :: menu(activeMenu)"></header>
<main role="main">
    <nav class="wrapper">
        <nav id="sidebar">
            <div class="row">
                <div class="col-lg-2">
                    <button type="button" id="sidebarCollapse" class="mt-3 m-1 btn text-white">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
                <div id="logo" class="col-lg-9">
                    <a href="/">
                        <img src="/images/logo.png"/>
                    </a>
                </div>
            </div>
            <div class="m-1">
                <div th:replace="user/signrequests/includes/status :: status"></div>
                <div class="mb-1 mt-1">
                    <div th:if="${user.eppn == signRequest.createBy}">
                        <div th:if="${(signRequest.status.name() == 'draft' || signRequest.status.name() == 'completed')}">
                            <div th:if="${#lists.size(signRequest.originalDocuments) == 0 || signRequest.currentWorkflowStep.signBooks.size() == 0}">
                                <div class="alert alert-secondary" th:if="${signRequest.status.name() == 'draft'}">
                                    <h6 class="alert-heading">
                                        Demande en cours de création
                                    </h6>
                                    <div th:if="${#lists.size(signRequest.originalDocuments) == 0}">
                                        <div th:if="${modelId != null}">
                                            <button type="button" class="btn btn-info"
                                                    onclick="window.open('${modelId}', '_blank')">
                                                <i class="fas fa-download"></i> Télécharger le modèle
                                            </button>
                                        </div>
                                        <hr/>
                                        <p>Vous devez ajouter des documents</p>
                                    </div>
                                    <div th:if="${signRequest.currentWorkflowStep.signBooks.size() == 0}">
                                        <p>
                                        <hr/>
                                        Vous devez envoyer la demande dans un ou plusieurs parapheurs
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div th:unless="${signRequest.originalDocuments.size() == 0 || signRequest.currentWorkflowStep.signBooks.size() == 0}">
                                <div class="alert alert-info">
                                    <h6 class="alert-heading">
                                        Demande prête pour la mise en signature
                                    </h6>
                                    <hr/>
                                    <th:block
                                            th:if="${signRequest.currentWorkflowStep.signBooks.size() > 0 && user.eppn == signRequest.createBy && #lists.size(signRequest.originalDocuments) > 0}">
                                        <button type="button" class="mr-2 btn btn-success" data-toggle="modal" data-target="#sendModal">
                                            <i class="fa fa-paper-plane " aria-hidden="true"></i> Lancer la procedure de signature
                                        </button>
                                    </th:block>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div th:if="${signRequest.status.name() == 'exported'}" class="alert alert-warning">
                    <small><span th:text="'Emplacement définitif : ' + ${signRequest.exportedDocumentURI}"></span></small>
                    <br>
                    <a class="btn btn-success" th:href="'/ws/get-last-file?name=' + ${signRequest.name}"><i class="fa fa-download"></i> Télécharger le document signé</a>
                </div>
                <div th:if="${signRequest.status.name() == 'pending'}">
                    <div class="alert alert-primary sidebar-label mb-1">
                        <h6 class="alert-heading">
                            La demande est en cours de signature
                        </h6>
                    </div>
                    <div th:if="${signable == 'ok'}">
                        <div class="alert alert-primary sidebar-label mb-1">
                            Vous devez signer cette demande
                        </div>
                        <button type="button" class="btn btn-danger col-12 mb-1" data-toggle="modal" data-target="#refuseModal">
                            <i class="fas fa-ban"></i><span class="sidebar-label"> Refuser</span>
                        </button>
                        <a class="btn btn-success col-12 mb-1" th:href="'/user/signrequests/sign-by-token/' + ${signRequest.name}">
                            <i class="fas fa-signature"></i><span class="sidebar-label"> Signer</span>
                        </a>
                    </div>
                </div>
                <div th:if="${user.eppn == signRequest.createBy}">
                    <div th:switch="${signRequest.status.name()}">
                        <div th:case="'signed'">
                            <dl class="display-group border-bottom m-0">
                                <dt class="col-lg-5">
                                    Terminer
                                    <button data-target="#collapseHelp1" data-toggle="collapse"
                                            type="button" class="btn btn-sm btn-info">
                                        <span class="fas fa-info-circle"></span>
                                    </button>
                                    <div class="collapse" id="collapseHelp1">
                                        <div class="alert alert-info">
                                            <small> La cloture de la demande permet de liberer
                                                le parapheur. La demande sera supprimée dans un délai
                                                défini par l'administrateur. </small>
                                        </div>
                                    </div>
                                </dt>
                                <dd class="col-lg-7">
                                    <form class="form-group"
                                          th:action="'/user/signrequests/complete/' +  ${id}"
                                          method="get">
                                        <div class="input-group">
                                            <button type="submit" class="btn btn-warning">
                                                <i class="fas fa-flag-checkered"> </i> Terminer
                                            </button>
                                        </div>
                                    </form>
                                </dd>
                            </dl>
                        </div>
                        <th:block th:if="${signRequest.status.name() == 'signed' || signRequest.status.name() == 'completed' || signRequest.status.name() == 'checked'}">
                            <div class="alert alert-success mb-1">
                                <div class="sidebar-label">
                                    <h6 class="alert-heading">Toutes les étapes de la demande sont effectuées</h6>
                                </div>
                                <a class="m-1 btn btn-success" th:href="'/user/signrequests/get-last-file/' + ${id}" target="_blank" title="Enregistrer le document signé sous">
                                    <i class="fas fa-save "></i><span class="sidebar-label"> Enregistrer le document signé sous</span>
                                </a>
                                <a class="m-1 btn btn-dark" th:href="'/user/validation/document/' + ${id}" title="Contrôler le document">
                                    <i class="fas fa-shield-alt "></i><span class="sidebar-label"> Contrôler le document</span>
                                </a>
                            </div>
                        </th:block>
                    </div>
                </div>
                <a class="btn btn-light col-12" href="/"><i class="fas fa-door-open"></i>
                    <span class="sidebar-label">Sortir</span>
                </a>
            </div>
        </nav>
        <div id="content" class="content">
            <div aria-expanded="true" class="collapse" id="collapseHelp">
                <div class="alert alert-info">
                    Cet écran permet d'effectuer plusieurs types d'actions sur votre demande :
                    <ul>
                        <li>Ajouter des documents à votre demande et l'envoyer</li>
                        <li>Consulter les documents à signer</li>
                        <li>Signer une demande</li>
                        <li>Consulter / télécharger les documents signés</li>
                    </ul>
                </div>
            </div>
            <div class="mt-2">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/user/signrequests">Liste des demandes</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Demande de signature : <span th:text="${signRequest.name}"></span>
                        </li>
                    </ol>
                </nav>
            </div>
            <div th:if="${signRequest.signedDocuments.size() > 0}" class="card rounded-0 mb-1">
                <div class="card-header">
                    Liste des documents signés
                </div>
                <div class="card-body">
                    <div class="file-loading">
                        <input id="signedFiles" type="file" multiple="multiple"/>
                    </div>
                </div>
            </div>
            <div class="card rounded-0 mb-1">
                <div class="card-header">
                    Liste des documents originaux
                    <th:block th:if="${user.eppn == signRequest.createBy && (signRequest.status.name() == 'completed' || signRequest.status.name() == 'draft')}">
                        <button th:if="${signRequest.status.name() == 'draft' && user.eppn == signRequest.createBy && signRequest.signedDocuments.size() == 0}" id="browseBtn" type="button" class="mr-2 btn btn-primary float-right"
                                onclick="$('.clickable').click();">
                            <i class="fa fa-plus" aria-hidden="true"></i> Ajouter un document
                        </button>
                    </th:block>
                </div>
                <div class="card-body">
                    <div class="file-loading">
                        <input id="multipartFile" name="multipartFiles" type="file"
                               multiple="multiple"/>
                    </div>
                </div>
            </div>
            <div th:replace="user/signrequests/cards/stepscard :: stepscard"></div>
            <div class="card rounded-0 mb-1">
                <div class="card-header">
                    Commentaires <span th:text="'(' + ${#lists.size(comments)} + ')'"></span>
                </div>
                <div id="collapseComments" class="show"
                     aria-labelledby="headingOne" data-parent="#accordion">
                    <div class="card-body">
                        <ul class="list-group">
                            <th:block th:each="comment : ${comments}">
                                <div class="d-flex w-100 justify-content-between">
                                    <li href="#" class="list-group-item list-group-item-action">
                                        De : <span class="mb-1" th:text="${comment.eppn}"></span> -
                                        <small>
                                            le : <span th:text="${#dates.format(comment.logDate, 'dd/MM/yyyy HH:mm')}"></span>
                                            <br>
                                            Action effectuée : <span th:text="#{'signbook.status.' + ${comment.finalStatus}}"></span>
                                        </small>
                                        <p th:text="${comment.comment}"></p>

                                    </li>
                                </div>
                            </th:block>
                        </ul>
                        <form th:action="'/user/signrequests/comment/' + ${id}">
                            <textarea placeholder="Vous pouvez ajouter un commentaire" class="form-control" name="comment" cols="" rows=""></textarea>
                            <button type="submit" class="btn btn-primary float-right">
                                <i class="fas fa-comments" aria-hidden="true"></i> Envoyer un commentaire
                            </button>
                        </form>

                    </div>
                </div>
            </div>
            <div class="card rounded-0 mb-1">
                <div class="card-header">
                    Logs
                </div>
                <div id="collapseLogs" class="show" aria-labelledby="headingOne"
                     data-parent="#accordion">
                    <div class="card-body">
                        <table class="table table-responsive table-sm table-striped table-hover">
                            <thead>
                            <tr>
                                <th class="none">Date</th>
                                <th class="none">Eppn</th>
                                <th class="none">Action</th>
                                <th class="none">Statut initial</th>
                                <th class="none">Statut final</th>
                            </tr>
                            </thead>
                            <tbody>
                            <th:block th:each="log : ${logs}">
                                <tr>
                                    <td><span th:text="${log.logDate}"></span></td>
                                    <td><span th:text="${log.eppn}"></span></td>
                                    <td><span th:text="${log.action}"></span></td>
                                    <td><span th:text="${log.initialStatus}"></span></td>
                                    <td><span th:text="${log.finalStatus}"></span></td>
                                </tr>
                            </th:block>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </nav>
</main>

<div class="modal fade" id="sendModal" tabindex="-1" role="dialog" aria-labelledby="Refus" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form th:action="'/user/signrequests/pending/' + ${id}">
                <div class="modal-header">
                    <h5 class="modal-title">Envoi pour signature</h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        Attention, les paramètres de la demande ne pourront plus etre changés une fois celle-ci envoyée
                    </div>
                    <br/>
                    <textarea placeholder="Vous pouvez ajouter un commentaire" class="form-control" name="comment" cols="" rows=""></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fa fa-paper-plane" aria-hidden="true"></i> Envoyer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="refuseModal" tabindex="-1" role="dialog" aria-labelledby="refuseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form th:action="'/user/signrequests/refuse/' + ${id}">
                <div class="modal-header">
                    <h5 class="modal-title" id="refuseModalLabel">Refuser la demande de signature</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <textarea placeholder="Vous pouvez ajouter un commentaire" class="form-control" name="comment" cols="" rows=""></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-danger">Refuser</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addWorkflow" tabindex="-1" role="dialog" aria-labelledby="addWorkflowLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form th:action="'/user/signrequests/add-workflow/' + ${id}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Ajouter un workflow</h5>
                </div>
                <div class="modal-body">
                    <select name="workflowSignBookId" class="form-control">
                        <th:block th:each="workflowSignBook : ${workflowSignBooks}">
                            <option th:value="${workflowSignBook.id}" th:text="${workflowSignBook.name}"></option>
                        </th:block>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fa fa-paper-plane" aria-hidden="true"></i> Ajouter
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addStep" tabindex="-1" role="dialog" aria-labelledby="addStep" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form th:action="'/user/signrequests/add-step/' + ${id}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Ajouter une étape</h5>
                </div>
                <div class="modal-body">
                    <div class="form-group" id="_signType_div_id">
                        <label for="_signType_id"> <strong> Type de signature
                            par défaut
                            <button data-target="#collapseHelpSignType"
                                    data-toggle="collapse" type="button"
                                    class="btn btn-sm btn-info">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </strong>
                            <div class="collapse" id="collapseHelpSignType">
                                <div class="alert alert-info">
                                    <ul>
                                        <li>PAdES/XAdES : s'appuie sur le certificat P12
                                            uploader au niveau de vos paramètres
                                        </li>
                                        <li>Apposition de la signature : ajoute simplement
                                            l'image de votre signature sur un PDF à l'endroit voulu
                                        </li>
                                        <li>PAdES/XAdES avec NexU : s'appuie l'application NexU
                                            qui permet l'utilisation d'un certificat matériel
                                        </li>
                                        <li>Confirmation de lecture : permet de valider la
                                            lecture d'un document
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </label>
                        <div class="col-lg-8">
                            <select id="_signType_id" name="signType" class="form-control" size="1">
                                <th:block th:each="signType : ${signTypes}">
                                    <option th:value="${signType}" th:text="#{'signbook.signtype.' + ${signType}}"></option>
                                </th:block>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" id="_newPageType_div_id">
                        <label for="_newPageType_id">
                            <strong> Insérer unepage de garde </strong>
                        </label>
                        <div class="col-lg-8">
                            <select id="_newPageType_id" name="newPageType"
                                    class="form-control" size="1">
                                <th:block th:each="newPageType : ${newPageTypes}">
                                    <option th:value="${newPageType}" th:text="#{'signbook.newpagetype.' + ${newPageType}}"></option>
                                </th:block>
                            </select>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fa fa-paper-plane" aria-hidden="true"></i> Envoyer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<footer th:replace="fragments/footer :: footer"></footer>
</body>
<script th:replace="user/signrequests/includes/scriptshow :: scriptshow"></script>
</html>
