<!doctype html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head"></head>
<body>
	<nav th:replace="fragments/menu :: menu(activeMenu)"></nav>
	<nav class="nav justify-content-between" aria-label="breadcrumb">
		<ol class="breadcrumb col-11">
			<li class="breadcrumb-item"><a href="/user/signrequests">Liste des demandes</a></li>
			<li class="breadcrumb-item active" aria-current="page">Demande de signature : <span th:text="${signRequest.name}"></span>
			</li>
		</ol>
		<div class="navbar-nav align-self-center">
			<button data-target="#collapseHelp" data-toggle="collapse"
				type="button" class="btn btn-info">
				<span class="fas fa-info-circle"> <!--  -->
				</span>
			</button>
		</div>
	</nav>
	<div aria-expanded="true" class="collapse" id="collapseHelp">
		<div class="alert alert-info">
			Cet écran permet d'effectuer plusieurs types d'actions sur votre
			demande :
			<ul>
				<li>Ajouter des documents à votre demande et l'envoyer</li>
				<li>Consulter les documents à signer</li>
				<li>Signer une demande</li>
				<li>Consulter / télécharger les documents signés</li>
			</ul>
			Les actions possibles apparaisent dans l'espace "Signature"
		</div>
	</div>
	<div id="ribbon" class="card">
		<div class="card-body">
			<th:block th:if="${signRequest.status.name() == 'signed' || signRequest.status.name() == 'completed' || signRequest.status.name() == 'checked'}">
				<button type="button"
					class="mr-2 btn btn-outline-dark btn-light float-left"
					th:onclick="'window.open(\'/user/signrequests/get-last-file/' + ${id} + '\', \'_blank\')'">
					<p class="text-center">
						<i class="fas fa-save fa-2x"></i> <br /> Enregistrer sous
					</p>
				</button>
				<button type="button"
					class="mr-2 btn btn-outline-dark btn-light float-left"
					th:onclick="'location.href=\'/user/validation/document/' + ${id} +'\''">
					<p class="text-center">
						<i class="fas fa-shield-alt fa-2x"></i> <br> Valider le
						document
					</p>
				</button>
			</th:block>

			<th:block th:if="${signable == 'ok'}">
				<th:block th:switch="${signRequest.currentWorkflowStep.signRequestParams.signType.name()}">
					<th:block th:case="'nexuSign'">
						<script type="text/javascript" src="/js/jsSignatureLevel.js"></script>
						<script type="text/javascript" th:replace="user/signrequests/includes/script :: script"></script>
						<div id="nexu_version_alert" style="display: none;">
							<a onclick="location.reload();" class="mr-2 btn btn-warning btnSeccion float-left" id="btnSeccion3">
								<i class="fas fa-sync-alt fa-2x"></i><br> Actualiser
							</a>
							<div class="alert alert-warning float-left">
								L'application NexU n'a pas la bonne version.
								<br>
								<span th:text="${nexuVersion} + ' nécessaire'"></span>
							</div>
						</div>
						<div id="nexu_missing_alert" style="display: none;">
							<a onclick="location.reload();"
								class="mr-2 btn btn-warning btnSeccion float-left"
								id="btnSeccion2"> <i class="fas fa-sync-alt fa-2x"></i><br>
								Actualiser
							</a>
							<div class="alert alert-warning float-left">
								L'application NexU n'a pas été détectée <br> <small>Merci
									de lancer l'application sur votre poste. <a
									href="https://github.com/nowina-solutions/nexu/releases/">Téléchargement</a>
								</small>
							</div>
						</div>
						<div id="nexu_ready_alert" style="display: none;">
							<a th:href="'/user/signrequests/sign-by-token/' + ${signRequest.name}" class="mr-2 btn btn-success float-left">
								<i class="fas fa-signature fa-2x"></i> <br /> Signer
							</a>
							<div class="alert alert-success float-left">
								L'application NexU est fonctionnelle <br /> <small>Vous
									pouvez utiliser une clé materielle ou un keystore</small>
							</div>

						</div>
					</th:block>
					<th:block th:case="*">
						<button type="button" class="btn btn-danger" data-toggle="modal" data-target="#refuseModal">
							<i class="fas fa-ban fa-2x"></i><br />Refuser
						</button>
						<a class="btn btn-success" th:href="'/user/signrequests/sign-by-token/' + ${signRequest.name} + '?referer=true'">
							<i class="fas fa-signature fa-2x"></i> <br />Signer
						</a>
					</th:block>
				</th:block>
			</th:block>
			<th:block th:if="${user.eppn == signRequest.createBy && (signRequest.status.name() == 'completed' || signRequest.status.name() == 'draft')}">
				<button type="button" class="mr-2 btn btn-outline-dark btn-light float-left"
						data-toggle="modal" data-target="#reSendModal">
					<p class="text-center">
						<i class="fa fa-book-medical fa-2x" aria-hidden="true"></i><br />
						Envoyer dans un parapheur
					</p>
				</button>
			</th:block>
			<th:block th:if="${signRequest.status.name() == 'draft' && #lists.size(originalSignBooks) > 0 && user.eppn == signRequest.createBy && #lists.size(signRequest.originalDocuments) > 0}">
				<button type="button" class="mr-2 btn btn-success float-left" data-toggle="modal" data-target="#sendModal">
					<p class="text-center">
						<i class="fa fa-paper-plane fa-2x" aria-hidden="true"></i><br />Lancer la procedure de signature
					</p>
				</button>
			</th:block>
			<button type="button" title="Retour" class="btn btn-light btn-outline-dark float-right" value="Retour" onclick="location.href='/user/signrequests'">
				<i class="fas fa-door-open fa-2x"></i><br/>Retour
			</button>
		</div>
	</div>
	<main role="main" class="container-fluid">
	<div id="accordion">
		<div class="card card-body">
			<div class="card bg-light">
				<div class="card-header">
					<div class="row">
					<div class="col-lg-1">Statut</div> <div class="col-lg-2"><div th:replace="user/signrequests/includes/status :: status"></div></div>
					</div>
				</div>
				<div class="card-body">
					<div th:switch="${signable}">
						<div th:case="'ok'">
							<dl class="display-group border-bottom m-0 d-none">
								<dt class="col-lg-6">
									Parapheur courant
									<button data-target="#collapseHelpCurrent"
										data-toggle="collapse" type="button"
										class="btn btn-sm btn-info">
										<span class="fas fa-info-circle"></span>
									</button>
									<div class="collapse" id="collapseHelpCurrent">
										<div class="alert alert-info">
											<small> Les paramètres du parapheur courant sont
												appliqués par défaut. Vous pouvez modifier la position
												manuellement à l'aide de la prévisualisation. </small>
										</div>
									</div>
								</dt>
								<dd>
									<span class="alert alert-secondary"> <i
										class="fas fa-book"></i> ${currentSignBook.name}
									</span>
								</dd>
							</dl>
						</div>
						<div th:case="*">
							<div th:if="${user.eppn == signRequest.createBy}">
								<div th:if="${signRequest.status.name() == 'draft'}">
									<div class="alert alert-info">
									<h4 class="alert-heading">
										Demande en cours de création
									</h4>
									<div th:if="${#lists.size(signRequest.originalDocuments) == 0}">
										<div th:if="${modelId != null}">
											<button type="button" class="btn btn-info"
												onclick="window.open('${modelId}', '_blank')">
												<i class="fas fa-download"></i> Télécharger le modèle
											</button>
										</div>
										<p>Vous devez ajouter des documents</p>
									</div>
									<p th:if="${#lists.size(originalSignBooks) == 0}">
										Vous devez envoyer la demande dans un ou plusieurs parapheurs
									</p>
										<p th:unless="${#lists.size(originalSignBooks) == 0}">
										<dt class="col-lg-5">La demande se trouve dans les parapheurs suivants</dt>
										<ul class="list-group">
											<th:block th:each="originalSignBook : ${originalSignBooks}">
												<li class="list-group-item"><i class="fas fa-book"></i><span
														th:text="${originalSignBook.name}"></span></li>
											</th:block>
										</ul>
									</p>
									</div>
								</div>
							</div>
						</div>
						<div th:if="${signRequest.status.name() == 'exported'}" class="alert alert-warning">
						<small><span th:text="'Emplacement définitif : ' + ${signRequest.exportedDocumentURI}"></span></small>
						<br>
						<a class="btn btn-success" th:href="'/ws/get-last-file?name=' + ${signRequest.name}"><i class="fa fa-download"></i> Télécharger le document signé</a>

						</div>
						<div th:if="${signRequest.status.name() == 'pending'}">
							<div class="alert alert-info">
								La demande est en cours de signature par le(s) destinataire(s)
								suivants :
								<div class="form-group">
									<table class="table table-striped table-sm">
										<thead class="thead-dark">
											<tr>
												<th scope="col">Destinataires</th>
												<th scope="col">Statut de la signature</th>
											</tr>
										</thead>
										<tbody>
											<th:block
												th:each="signBooksLabel : ${signRequest.currentWorkflowStep.signBooksLabels}">
												<tr>
													<td align="left"><i class="fas fa-user"></i> <span
														th:text="${signBooksLabel.key}"></span></td>
													<td align="center">
														<div th:switch="${signBooksLabel.value}">
															<i th:case="true" class="fas fa-check text-success"></i>
															<i th:case="false" class="fas fa-times text-danger"></i>
														</div>
													</td>
												</tr>
											</th:block>
										</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>
					<div th:if="${user.eppn == signRequest.createBy}">
						<div th:switch="${signRequest.status.name()}">
							<div th:case="'signed'">
								<dl class="display-group border-bottom m-0">
									<dt class="col-lg-5">
										Terminer
										<button data-target="#collapseHelp1" data-toggle="collapse"
											type="button" class="btn btn-sm btn-info">
											<span class="fas fa-info-circle"></span>
										</button>
										<div class="collapse" id="collapseHelp1">
											<div class="alert alert-info">
												<small> La cloture de la demande permet de liberer
													le parapheur. La demande sera supprimée dans un délai
													défini par l'administrateur. </small>
											</div>
										</div>
									</dt>
									<dd class="col-lg-7">
										<form class="form-group"
											th:action="'/user/signrequests/complete/' +  ${id}"
											method="get">
											<div class="input-group">
												<button type="submit" class="btn btn-warning">
													<i class="fas fa-flag-checkered"> </i> Terminer
												</button>
											</div>
										</form>
									</dd>
								</dl>
							</div>
							<div th:case="*">
								<div th:if="${#lists.size(originalSignBooks) > 1}">
										<label for="_allSignToComplete">
											<strong>
											Tous les participants doivent-ils signer ?
											<button data-target="#collapseHelpAllSign" data-toggle="collapse"
													type="button" class="btn btn-sm btn-info">
												<span class="fas fa-info-circle"></span>
											</button>
											<div class="collapse" id="collapseHelpAllSign">
												<div class="alert alert-info">
													<small>
														<ul>
															<li>
																Oui : Tous les participants doivent signer pour que la demande passe au status "Signé"
															</li>
															<li>
																Non : Une seule signature suffit
															</li>
														</ul>
													</small>
												</div>
											</div>
											</strong>
											<div class="input-group">
												<label class="switch">
													<th:block th:if="${signRequest.currentWorkflowStep.allSignToComplete == true}">
														<input id="_allSignToComplete"
															th:onclick="'document.location=\'/user/signrequests/toggle-need-all-sign/' + ${id} + '\''"
															type="checkbox" name="allSignToComplete"
															checked="checked" /> Oui
													</th:block>
													<th:block th:unless="${signRequest.currentWorkflowStep.allSignToComplete == true}">
														<input id="_allSignToComplete"
															th:onclick="'document.location=\'/user/signrequests/toggle-need-all-sign/' + ${id} + '\''"
															type="checkbox" name="allSignToComplete"
															/> Non
													</th:block>
													<span class="slider round"></span>
												</label>
											</div>
										</label>

								</div>
							</div>
						</div>
					</div>

					<div
						th:unless="${signRequest.status == 'signed' || signRequest.status == 'completed' || signRequest.status == 'checked'}">
						<div th:if="${#lists.size(signRequest.currentWorkflowStep.signBooks) > 1}">
							<div class="alert alert-secondary">
								<div th:switch="${signRequest.allSignToComplete}">
									<small> <span th:case="true">Oui</span> <span
										th:case="*">Non</span>
									</small>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-6">
					<div class="card bg-light">
						<div class="card-header">
							Liste des documents originaux
						</div>
						<div class="card-body">
							<div class="file-loading">
								<input id="multipartFile" name="multipartFiles" type="file"
									multiple="multiple" />
							</div>
						</div>
					</div>
				</div>
				<div class="col-lg-6">
					<div class="card bg-light">
						<div class="card-header">
							Liste des documents signés
						</div>
						<div class="card-body">
							<div class="file-loading">
								<input id="signedFiles" type="file" multiple="multiple" />
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="card bg-light">
				<div class="card-header">
					<button class="btn btn-link" data-toggle="collapse"
						data-target="#collapseComments" aria-expanded="true"
						aria-controls="collapseTools">
						Commentaires <span th:text="'(' + ${#lists.size(comments)} + ')'"></span>
						<i class="fas fa-caret-down"></i>
					</button>
				</div>
				<div id="collapseComments" class="collapse"
					aria-labelledby="headingOne" data-parent="#accordion">
					<div class="card-body">
						<ul class="list-group">
							<th:block th:each="comment : ${comments}">
								<div class="d-flex w-100 justify-content-between">
									<li href="#" class="list-group-item list-group-item-action">
									De : <span class="mb-1" th:text="${comment.eppn}"></span> -
									<small>
										le : <span th:text="${#dates.format(comment.logDate, 'dd/MM/yyyy HH:mm')}"></span>
										<br>
										Action effectuée : <span th:text="#{'signbook.status.' + ${comment.finalStatus}}" ></span>
									</small>
									<p th:text="${comment.comment}"></p>

									</li>
								</div>
							</th:block>
						</ul>
						<form th:action="'/user/signrequests/comment/' + ${id}">
							<textarea placeholder="Vous pouvez ajouter un commentaire"
								class="form-control" name="comment" cols="" rows=""></textarea>
							<button type="submit" class="btn btn-primary">
								<i class="fas fa-comments" aria-hidden="true"></i> Envoyer un
								commentaire
							</button>
						</form>

					</div>
				</div>
			</div>

			<div class="card bg-light">
				<div class="card-header">
					<button class="btn btn-link" data-toggle="collapse"
						data-target="#collapseSignBook" aria-expanded="true"
						aria-controls="collapseTools">
						Workflow
						<i class="fas fa-caret-down"></i>
					</button>
				</div>
				<div id="collapseSignBook" class="collapse"
					aria-labelledby="headingOne" data-parent="#accordion">
					<div class="card-body">
						<dl class="display-group border-bottom m-0">
							<dd>
								<div th:if="${signRequest.workflowSteps != null}">
									Etapes du workflow : <span th:text="${signRequest.signBooksWorkflowStep}"></span>
									<div class="bs-stepper vertical linear">
										<div class="bs-stepper-header" role="tablist">
											<th:block th:each="workflowStep,iterator : ${signRequest.workflowSteps}">
												<div class="step">
													<div class="step-trigger col-12 text-left" role="tab" aria-selected="false">
														<div th:if="${iterator.index + 1 == signRequest.signBooksWorkflowStep && signRequest.status != 'completed'}">
															<span class="bs-stepper-circle bg-danger" th:text="${iterator.index + 1}"></span>
														</div>
														<div th:if="${iterator.index + 1 > signRequest.signBooksWorkflowStep}">
															<span class="bs-stepper-circle" th:text="${iterator.index + 1}"></span>
														</div>
														<div th:unless="${iterator.index + 1 > signRequest.signBooksWorkflowStep || iterator.index + 1 == signRequest.signBooksWorkflowStep}">
															<span class="bs-stepper-circle bg-success" th:text="${iterator.index + 1}"></span>
														</div>
														<span th:if="${workflowStep.allSignToComplete}"> Tous les <span class="bs-stepper-label" th:text="${workflowStep.signRequestParams.signType}"></span> de : </span>
														<span th:unless="${workflowStep.allSignToComplete}"> Une des signatures de : </span>
														<span class="bs-stepper-label" th:text="${workflowStep.signBooksLabels.keySet()}"></span>

													</div>
												</div>
												<div th:if="${#lists.size(signRequest.workflowSteps) > iterator.index + 1}" class="line"></div>
											</th:block>
										</div>
									</div>
								</div>
							</dd>
						</dl>
					</div>
				</div>
			</div>
			<div class="card bg-light">
				<div class="card-header">
					<button class="btn btn-link" data-toggle="collapse"
						data-target="#collapseLogs" aria-expanded="true"
						aria-controls="collapseTools">
						Logs (<span th:text="(${#lists.size(logs)})"></span>) <i
							class="fas fa-caret-down"></i>
					</button>
				</div>
				<div id="collapseLogs" class="collapse" aria-labelledby="headingOne"
					data-parent="#accordion">
					<div class="card-body">
						<table class="table table-sm table-striped table-hover">
							<thead>
								<tr>
									<th class="none">Date</th>
									<th class="none">Eppn</th>
									<th class="none">Action</th>
									<th class="none">Statut initial</th>
									<th class="none">Statut final</th>
								</tr>
							</thead>
							<tbody>
								<th:block th:each="log : ${logs}">
									<tr>
										<td><span th:text="${log.logDate}"></span></td>
										<td><span th:text="${log.eppn}"></span></td>
										<td><span th:text="${log.action}"></span></td>
										<td><span th:text="${log.initialStatus}"></span></td>
										<td><span th:text="${log.finalStatus}"></span></td>
									</tr>
								</th:block>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
	</main>

	<div class="modal fade" id="sendModal" tabindex="-1" role="dialog"
		aria-labelledby="Refus" aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">Envoi pour
						signature</h5>
				</div>
				<div class="modal-body">
					<form th:action="'/user/signrequests/pending/' + ${id}">
						<textarea placeholder="Vous pouvez ajouter un commentaire"
							class="form-control" name="comment" cols="" rows=""></textarea>
						<button type="submit" class="btn btn-success">
							<i class="fa fa-paper-plane" aria-hidden="true"></i> Envoyer
						</button>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-dismiss="modal">Annuler</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="reSendModal" tabindex="-1" role="dialog"
		aria-labelledby="Refus" aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Envoyer dans un	parapheur</h5>
				</div>
				<div class="modal-body">
					<form class="form-group"
						th:action="'/user/signrequests/send-to-signbook/' + ${id}"
						method="get">
						<div class="input-group">
							<select onchange="checkNbRecipients();" name="signBookNames"
								id="signBookNames" size="5" multiple="multiple"
								required="required">
								<th:block th:each="signBook : ${allSignBooks}">
									<option th:value="${signBook.name}"
										th:text="${signBook.name} + ' (' + ${signBook.signBookType} + ')'"></option>
								</th:block>
							</select>
						</div>
						<div class="input-group">
							<textarea class="form-control" name="comment"
								placeholder="Commentaire"></textarea>
						</div>
						<div class="input-group">
							<button type="submit" class="btn btn-primary">
								<i class="fas fa-share-square"></i>Envoyer
							</button>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-dismiss="modal">Annuler</button>
				</div>
			</div>
		</div>
	</div>
	<script th:inline="javascript">
	/*<![CDATA[*/

	var testSignBookName = document.getElementById("signBookNames");

	if(testSignBookName != null) {
    var signBookNamesSelect = new SlimSelect({
			select: '#signBookNames',
			placeholder: 'Choisir un ou plusieurs parapheur(s)',
	    	  searchText: 'Aucun résultat',
	    	  searchPlaceholder: 'Rechercher',
	    	  searchHighlight: true,
	    	  searchFilter: (option, search) => {
	  		    return true;
	  		  },
	    	  ajax: function (search, callback) {
	    		    if (search.length < 3) {
	    		      callback('Merci de saisir au moins 3 caractères')
	    		    }
	    		    fetch('/user/users/searchLdap?searchString=' + search)
	    		    .then(function (response) {
	    		      return response.json()
	    		    })
	    		    .then(function (json) {
	    		      let data = []
	    		      for (let i = 0; i< json.length; i++) {
	    		        data.push({text: json[i].displayName + ' (' + json[i].uid + ')', value: json[i].mail});
	    		      }
	    		      callback(data)
	    		    })
	    		    .catch(function(error) {
	    		      callback(false)
	    		    })
	    		  }
	  	});
	}

	$('#multipartFile').on('filebatchuploadcomplete', function(event, file, previewId, index, reader) {
		location.reload();
	});
	$('#multipartFile').on('fileuploaded', function(event, file, previewId, index, reader) {
		location.reload();
	});

	$('#multipartFile').on('fileloaded', function(event, file, previewId, index, reader) {
		$('#multipartFile').fileinput('upload');
	});

	$('#multipartFile').on('filedeleted', function(event, id, index) {
		location.reload();
	});

	$("#multipartFile").fileinput({
    	language: "fr",
        showCaption: false,
        showClose: false,
        [# th:if="${signRequest.status.name() != 'draft' || user.eppn != signRequest.createBy}"]
        	showUpload: false,
        	showBrowse: false,
        	showRemove: false,
        	dropZoneEnabled: false,
        [/]
        [# th:if="${signRequest.status.name() == 'draft' && user.eppn == signRequest.createBy}"]
        	browseOnZoneClick: true,
        [/]
    	uploadUrl: "/user/signrequests/add-doc/[[${id}]]",
    	uploadAsync: false,
    	overwriteInitial: false,
        theme: 'explorer-fas',
        pdfRendererUrl: 'http://plugins.krajee.com/pdfjs/web/viewer.html',
    	initialPreview: [
    		[# th:each="originalDocument : ${signRequest.originalDocuments}"]
    		[# th:text=${originalDocument.url}][/],
    		[/]
    		],
   	    initialPreviewConfig: [
    		[# th:each="originalDocument : ${signRequest.originalDocuments}"]
       		[# th:switch="${#strings.arraySplit(originalDocument.contentType, '/')[1]}"]
    			[# th:case="'gif'"]
	      	        {type: "image", size: [[${originalDocument.size}]], downloadUrl: "/user/documents/getfile/[[${originalDocument.id}]]",caption: [[${originalDocument.fileName}]], filename: [[${originalDocument.fileName}]], url: [['/user/signrequests/remove-doc/' + ${originalDocument.id}]], key: [[${originalDocument.id}]]},
    			[/]
      	      	[# th:case="'pdf'"]
      	    	  	{type: "pdf", size: [[${originalDocument.size}]], downloadUrl: "/user/documents/getfile/[[${originalDocument.id}]]",caption: [[${originalDocument.fileName}]], filename: [[${originalDocument.fileName}]], url: "/user/signrequests/remove-doc/[[${originalDocument.id}]]", key: [[${originalDocument.id}]]},
      	    	[/]
    			[# th:case="'doc'"]
    				{type: "office", size: [[${originalDocument.size}]], downloadUrl: [[${originalDocument.url}]],caption: [[${originalDocument.fileName}]], filename: [[${originalDocument.fileName}]], url: [['/user/signrequests/remove-doc/' + ${originalDocument.id}]], key: [[${originalDocument.id}]]},
    			[/]
    			[# th:case="'avi'"]
    				{type: "video", size: [[${originalDocument.size}]], downloadUrl: [[${originalDocument.url}]],caption: [[${originalDocument.fileName}]], filename: [[${originalDocument.fileName}]], url: [['/user/signrequests/remove-doc/' + ${originalDocument.id}]], key: [[${originalDocument.id}]]},
    			[/]
	    		[# th:case="*"]
		    		{type: "other", size: [[${originalDocument.size}]], downloadUrl: [[${originalDocument.url}]],caption: [[${originalDocument.fileName}]], filename: [[${originalDocument.fileName}]], url: [['/user/signrequests/remove-doc/' + ${originalDocument.id}]], key: [[${originalDocument.id}]]},
	    		[/]
    		[/]
    		[/]
   	    ],
   		initialPreviewAsData: true,
   		initialPreviewFileType: 'pdf',
        preferIconicPreview: true,
        previewFileIconSettings: { // configure your icon file extensions
            'doc': '<i class="fas fa-file-word text-primary  fa-2x"></i>',
            'xls': '<i class="fas fa-file-excel text-success  fa-2x"></i>',
            'ppt': '<i class="fas fa-file-powerpoint text-danger  fa-2x"></i>',
            'pdf': '<i class="fas fa-file-pdf text-danger  fa-2x"></i>',
            'zip': '<i class="fas fa-file-archive text-muted  fa-2x"></i>',
            'htm': '<i class="fas fa-file-code text-info  fa-2x"></i>',
            'txt': '<i class="fas fa-file-alt text-info fa-2x"></i>',
            'mov': '<i class="fas fa-file-video text-warning fa-2x"></i>',
            'mp3': '<i class="fas fa-file-audio text-warning  fa-2x"></i>',
            'jpg': '<i class="fas fa-file-image text-danger fa-2x"></i>',
            'gif': '<i class="fas fa-file-image text-muted fa-2x"></i>',
            'png': '<i class="fas fa-file-image text-primary fa-2x"></i>'
        },
        previewFileExtSettings: { // configure the logic for determining icon file extensions
            'doc': function(ext) {
                return ext.match(/(doc|docx)$/i);
            },
            'xls': function(ext) {
                return ext.match(/(xls|xlsx)$/i);
            },
            'ppt': function(ext) {
                return ext.match(/(ppt|pptx)$/i);
            },
            'zip': function(ext) {
                return ext.match(/(zip|rar|tar|gzip|gz|7z)$/i);
            },
            'htm': function(ext) {
                return ext.match(/(htm|html)$/i);
            },
            'txt': function(ext) {
                return ext.match(/(txt|ini|csv|java|php|js|css)$/i);
            },
            'mov': function(ext) {
                return ext.match(/(avi|mpg|mkv|mov|mp4|3gp|webm|wmv)$/i);
            },
            'mp3': function(ext) {
                return ext.match(/(mp3|wav)$/i);
            }
        },
        fileActionSettings: {
        	showDrag: false,
            showZoom: function(config) {
                if (config.type === 'pdf' || config.type === 'image') {
                    return true;
                }
                return false;
            },
            [# th:if="${signRequest.status.name() != 'draft' || user.eppn != signRequest.createBy}"]
	        	showRemove: false
        	[/]

        }

    });

	$("#signedFiles").fileinput({
    	language: "fr",
        showCaption: false,
        showClose: false,
       	showUpload: false,
       	showBrowse: false,
       	showRemove: false,
       	dropZoneEnabled: false,
        browseOnZoneClick: true,
    	uploadAsync: false,
        theme: 'explorer-fas',
        pdfRendererUrl: 'http://plugins.krajee.com/pdfjs/web/viewer.html',
    	initialPreview: [
    		[# th:each="signedDocument : ${signRequest.signedDocuments}"]
    		[[${signedDocument.url}]],
    		[/]
    		],
   	    initialPreviewConfig: [
    		[# th:each="signedDocument : ${signRequest.signedDocuments}"]
			[# th:switch="${#strings.arraySplit(signedDocument.contentType, '/')[1]}"]
      	      	[# th:case="'pdf'"]
	      	      	{type: "pdf", size: [[${signedDocument.size}]], downloadUrl: "/user/documents/getfile/[[${signedDocument.id}]]",caption: [[${signedDocument.fileName}]], filename: [[${signedDocument.fileName}]], key: [[${signedDocument.id}]]},
      	    	[/]
	    		[# th:case="*"]
					{type: "other", size: [[${signedDocument.size}]], downloadUrl: "/user/documents/getfile/[[${signedDocument.id}]]",caption: [[${signedDocument.fileName}]], filename: [[${signedDocument.fileName}]], key: [[${signedDocument.id}]]},
	    		[/]
    		[/]
    		[/]
   	    ],
   		initialPreviewAsData: true,
   		initialPreviewFileType: 'image',
   	    overwriteInitial: false,
        preferIconicPreview: true,
        previewFileIconSettings: { // configure your icon file extensions
            'pdf': '<i class="fas fa-file-pdf text-danger fa-2x"></i>',
            'asic': '<i class="fas fa-file-signature text-dark fa-2x"></i>',
        },
        previewFileExtSettings: { // configure the logic for determining icon file extensions
            'asic': function(ext) {
                return ext.match(/(asics|asice)$/i);
            }
        },
        fileActionSettings: {
        	showDrag: false,
        	showZoom: function(config) {
                 if (config.type === 'pdf') {
                     return true;
                 }
                 return false;
             },
        	showRemove: false
        }

    });
/*]]>*/
</script>

</body>
</html>
