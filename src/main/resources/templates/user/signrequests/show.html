<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<!--/*@thymesVar id="signBook" type="org.esupportail.esupsignature.entity.SignBook"*/-->
<!--/*@thymesVar id="signRequest" type="org.esupportail.esupsignature.entity.SignRequest"*/-->
<!--/*@thymesVar id="postits" type="java.util.List<org.esupportail.esupsignature.entity.Comment>"*/-->
<!--/*@thymesVar id="globalProperties" type="org.esupportail.esupsignature.config.GlobalProperties"*/-->
<!--/*@thymesVar id="signatureIds" type="java.util.List<String>"*/-->
<!--/*@thymesVar id="currentSignType" type="org.esupportail.esupsignature.entity.enums.SignType"*/-->
<!--/*@thymesVar id="signable" type="java.lang.Boolean"*/-->
<head th:replace="~{fragments/head :: head}"></head>
<body>
<script th:inline="javascript" type="module" th:if="${globalProperties.enableHelp}">
    import {SignRequestHelp} from '/js/modules/help/SignRequestHelp.js?version=@[(${versionApp})]@';
    let help = new SignRequestHelp([[${myUiParams.get(T(org.esupportail.esupsignature.entity.enums.UiParams).signRequestHelp)}]], [[${#authorization.expression('hasRole(''ROLE_OTP'')')}]]);
    help.autoStart();
</script>
<header th:unless="${frameMode}" th:replace="~{fragments/nav :: nav}"></header>
<script>
    // Include model attributs for online forms javascript
    /*<![CDATA[*/
    class User {
        constructor(id, eppn, name, firstname, email) {
            this.id = id;
            this.eppn = eppn;
            this.login = eppn.split("@")[0];
            this.name = name;
            this.firstname = firstname;
            this.email = email;
        }
    }
    const user = new User("[[${user.id}]]", "[[${user.eppn}]]", "[[${user.name}]]", "[[${user.firstname}]]", "[[${user.email}]]");
    const creator = new User("[[${signRequest.createBy.id}]]", "[[${signRequest.createBy.eppn}]]", "[[${signRequest.createBy.name}]]", "[[${signRequest.createBy.firstname}]]");
    const currentStepNumber = "[[${currentStepNumber}]]";
    const supervisors = "[[${supervisors}]]";
    const isLastStep = "[[${isLastStep}]]";
    /*]]>*/
</script>

<main role="main">
    <div class="wrapper">
        <nav th:if="${user.userType.name() == 'external'}" id="sidebar" class="scrollbar-lite scrollbar-style" th:insert="~{fragments/sides/side-otp :: side}"></nav>
        <nav th:unless="${user.userType.name() == 'external'}" id="sidebar" class="scrollbar-lite scrollbar-style" th:insert="~{fragments/sides/side-sign :: side-sign}"></nav>
        <nav id="breadcrumb" aria-label="breadcrumb" class="breadcrumb-nav">
            <ol class="breadcrumb">
                <li th:if="${editable && userEppn == authUserEppn && user.userType.name() != 'external'}" class="breadcrumb-item"><a href="/user/signbooks">Tableau
                    de bord</a></li>
                <li th:if="${userEppn == authUserEppn  && user.userType.name() != 'external'}" th:unless="${editable}" class="breadcrumb-item"><a
                        href="/user/signbooks?statusFilter=toSign">Documents à signer</a></li>
                <li class="breadcrumb-item active" aria-current="page">Demande : <span
                        th:text="${signRequest.parentSignBook.subject}"></span>&nbsp;du&nbsp;<span
                        th:text="${#dates.format(signRequest.createDate, 'dd/MM/yyyy HH:mm')}"></span>
                    <span class="not-viewed fw-bold" th:unless="${signRequest.viewedBy != null && signRequest.viewedBy.contains(user)}">(non lu)</span>
                </li>
            </ol>
        </nav>
        <div id="content" class="content" th:data-es-signbook-id="${signRequest.parentSignBook.id}">
            <div id="signButtons" class="fixed-action-btns active">
                <ul id="buttonList" class="list-unstyled">
                    <li>
                        <button th:if="${isManager && signRequest.data == null}" tabindex="1" id="addSpotButton2" role="button" class="btn-floating btn-lg bg-warning d-none" title="Ajouter un emplacement de signature" style="border: 0px solid #0d6efd;">
                            <i class="fa-solid fa-signature fa-2xl text-dark" style="margin-top: -8px;"></i>
                        </button>
                    </li>
                    <li>
                        <button tabindex="1" id="addCommentButton2" role="button" class="btn-floating btn-lg bg-warning d-none" title="Ajouter une annotation" style="border: 0px solid #0d6efd;">
                            <i class="fa-solid fa-comment fa-2xl text-dark" style="margin-top: -8px;"></i>
                        </button>
                    </li>
                    <li th:if="${signable && signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa && toSignDocument.contentType == 'application/pdf'}">
                        <button tabindex="1" id="addSignButton2" role="button" class="btn-floating btn-lg bg-white pulse-primary" title="Insérer une signature" style="border: 0px solid #0d6efd;">
                            <i class="fa-solid fa-file-signature fa-2xl text-primary" style="margin-top: -8px;"></i>
                        </button>
                    </li>
                    <li th:if="${signable && signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).visa && signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">
                        <button tabindex="1" id="signLaunchButton" role="button" class="btn btn-floating btn-lg bg-success" title="Enregistrer la signature et passer à l'étape suivante">
                            <span class="fa-stack fa-sm">
                                <i class="fa-solid fa-save fa-stack-1x" style="margin-top: 14px; margin-left: 10px"></i>
                                <i class="fa-solid fa-signature fa-stack-2x" style="margin-top: -8px; margin-left: -5px"></i>
                            </span>
<!--                            <i class="fa-solid fa-file-signature fa-2xl"></i>-->
                        </button>
                    </li>
                    <li th:unless="${!signable || signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).visa && signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">
                        <a tabindex="1" id="visaLaunchButton" role="button" class="btn-floating btn-lg bg-success"
                            title="Viser"><i class="fa-solid fa-check fa-2xl"></i></a>
                    </li>
                    <li tabindex="1" th:if="${signable && (currentStepNumber > 1 || signRequest.createBy.eppn != userEppn)}">
                        <button tabindex="1" id="refuseLaunchButton" class="btn-floating btn-lg bg-danger border-0" title="Refuser"
                            th:token="${signRequest.token}" data-bs-toggle="modal" data-bs-target="#refuseModal"><i
                                class="fa-solid fa-file-excel fa-2xl" style="margin-top: -8px;"></i></button>
                    </li>
                    <li th:if="${!user.userType.name.equals('external')}">
                        <a tabindex="1" id="forward-btn" th:if="${signable}" class="btn-floating btn-lg bg-warning " title="Réaffecter la demande" data-bs-toggle="modal" data-bs-target="#forwardModal">
                            <i class="fa-solid fa-people-arrows fa-2xl text-dark"></i>
                        </a>
                    </li>
                    <li th:if="${signRequest.createBy.eppn == userEppn && signRequest.deleted}">
                        <a tabindex="1" th:href="'/user/signbooks/restore/' + ${signBook.id}" role="button" class="btn-floating btn-lg bg-primary" title="Restaurer">
                            <i class="fa-solid fa-trash-restore fa-2xl"></i>
                        </a>
                    </li>
                    <li th:if="${signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).refused && signRequest.createBy.eppn == userEppn}">
                        <a tabindex="1" class="btn-lg btn-floating bg-primary"
                           th:href="'/ws-secure/global/get-original-file/' + ${id}" target="_blank"
                           title="Télécharger le document original"><i class="fa-solid fa-download fa-2xl"></i></a>
                    </li>
                    <li th:if="${(signRequest.parentSignBook.liveWorkflow.workflow == null || signRequest.parentSignBook.liveWorkflow.workflow.authorizeClone) && signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).refused && signRequest.createBy.eppn == userEppn}">
                        <a tabindex="1" type="button"
                           class="btn-lg btn-floating bg-primary" data-bs-toggle="modal" title="Relancer cette demande"
                           data-bs-target="#cloneModal">
                            <i class="fa-solid fa-refresh fa-2xl"></i>
                        </a>
                    </li>
                    <li th:if="${(signRequest.parentSignBook.liveWorkflow.workflow == null || signRequest.parentSignBook.liveWorkflow.workflow.forbidDownloadsBeforeEnd == null || !signRequest.parentSignBook.liveWorkflow.workflow.forbidDownloadsBeforeEnd) && signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).pending}">
                        <a tabindex="1" class="btn-lg btn-floating bg-primary"
                            th:href="'/ws-secure/global/get-last-file/' + ${id}" target="_blank"
                            title="Télécharger le document"><i class="fa-solid fa-download fa-2xl"></i></a>
                    </li>
                    <li th:if="${signRequest.status != T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).pending && signRequest.status != T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).refused}">
                        <a tabindex="1" class="btn-lg btn-floating bg-primary"
                            th:href="'/ws-secure/global/get-last-file/' + ${id}" target="_blank"
                            title="Télécharger la dernière version du document"><i class="fa-solid fa-download fa-2xl"></i></a>
                    </li>
                    <li th:if="${signRequest.parentSignBook.signRequests.size() > 1 && signRequest.status != T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).pending}">
                        <a tabindex="1" class="btn-lg btn-floating bg-primary"
                           th:href="'/ws-secure/global/get-last-files/' + ${signRequest.parentSignBook.id}" target="_blank"
                           title="Télécharger la dernière version des documents dans une archive ZIP"><i class="fa-solid fa-file-archive fa-2xl"></i></a>
                    </li>
                    <li th:if="${signRequest.lastSignedDocument.contentType == 'application/pdf' && signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).completed}">
                        <a tabindex="1" class="btn-lg btn-floating bg-primary"
                            onclick='alert("Le document ainsi téléchargé est destiné exclusivement à l`impression. Les signatures éléctroniques ne sont présentes que dans la version numérique")'
                            th:href="'/ws-secure/global/print-with-code/' + ${id}" target="_blank"
                            title="Imprimer avec un code datamatrix"><i class="fa-solid fa-print fa-2xl"></i></a>
                    </li>
                    <li th:if="${@preAuthorizeService.signRequestDelete(signRequest.id, authUserEppn) && (!signRequest.status.equals(T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).completed) || signBook.status.equals(T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).completed))}">
                        <button tabindex="1" id="trashLaunchButton" class="btn btn-floating btn-lg bg-danger"
                                th:title="${!signRequest.deleted ? 'Mettre à la corbeille' : 'Supprimer définitivement de la corbeille'}"
                                data-bs-toggle="modal" th:data-bs-target="'#modal-warning-' + ${signRequest.id}">
                            <i th:if="${signRequest.deleted}" class="fa-solid fa-dumpster-fire fa-xl" style="margin-top: -8px;"></i>
                            <i th:if="${!signRequest.deleted}" class="fa-solid fa-trash-alt fa-xl" style="margin-top: -8px;"></i>
                        </button>
                    </li>
                    <th:block id="signButtons" th:if="${signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).draft}" th:unless="${signable}" class="fixed-action-btns active">
                        <li>
                            <a tabindex="1" id="start-button" role="button" class="btn-floating btn-lg bg-success" title="Démarrer le circuit"
                                data-bs-toggle="modal" data-bs-target="#sendModal"><i class="fa-solid fa-play fa-2xl"></i>
                            </a>
                        </li>
<!--                        <li>-->
<!--                            <a role="button" class="btn-floating btn-lg bg-danger" title="Supprimer"-->
<!--                               data-bs-toggle="modal" data-bs-target="#modal-warning"-->
<!--                               th:data-bs-target="'#modal-warning-' + ${signRequest.id}"><i class="fa-solid fa-trash-alt"></i>-->
<!--                            </a>-->
<!--                        </li>-->
                    </th:block>
                    <th:block id="openButtons" class="fixed-action-btns active"
                        th:if="${viewRight && (signRequest.deleted || signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).completed || signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).exported || signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).archived || signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).cleaned)}"
                        onmouseover="$('#openButtons').toggleClass('active');"
                        onmouseout="$('#openButtons').toggleClass('active');">
                        <li>
                            <a tabindex="1" class="btn-lg btn-floating bg-primary"
                                th:href="'/ws-secure/global/get-last-file-report/' + ${id}" target="_blank"
                                title="Enregistrer le document signé et le rapport de signature"><i class="fa-solid fa-file-shield fa-2xl"></i>
                            </a>
                        </li>
                        <li>
                            <a tabindex="1" title="Export SEDA" class="btn btn-floating bg-primary d-none" th:href="'/ws-secure/global/get-seda/' + ${id}">
                                <i class="fa-solid fa-file-export fa-2xl"></i>
                            </a>
                        </li>
                        <li>
                            <a tabindex="1" th:if="${signRequest.status != T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).exported}" class="btn btn-floating bg-primary d-none" th:href="'/user/validation/document/' + ${id}" title="Contrôler le document">
                                <i class="fa-solid fa-shield-alt fa-2xl"></i>
                            </a>
                        </li>
                    </th:block>
                    <li th:if="${nextSignBook != null}" class="">
                        <a tabindex="1" th:unless="${user.userType.name() == 'external'}" id="nextSignBookButton" role="button" th:href="'/user/signbooks/' + ${nextSignBook.id}" class="btn-lg btn-floating bg-primary" title="Demande suivante">
                            <i class="fa-solid fa-arrow-right fa-2xl"></i>
                        </a>
                        <a tabindex="1" th:if="${user.userType.name() == 'external'}" id="nextSignBookButton" role="button" th:href="'/otp/signrequests/' + ${nextSignBook.signRequests.get(0).id}" class="btn-lg btn-floating bg-primary" title="Demande suivante">
                            <i class="fa-solid fa-arrow-right fa-2xl"></i>
                        </a>
                    </li>
                </ul>
            </div>
            <div th:replace="~{user/signrequests/includes/tools :: tools}"></div>
            <div style="position: absolute;top: 200px;">
                <div id="potit-comment" class="postit-global d-none overflow-hidden"
                     th:if="${signRequest.parentSignBook.description != null && signRequest.parentSignBook.description != ''}"
                     style="cursor: move;background-color: #FFF740;position: fixed; left: 278px; top : 178px;z-index: 1000;">
                    <button type="button" class="postit-global-close close">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                    <b>Note</b>
                    <button th:es-postit-id="${signRequest.id}" type="button" title="Copier le texte du postit" class="postit-copy btn btn-sm btn-transparent text-dark">
                        <i th:es-postit-id="${signRequest.id}" class="fa-regular fa-copy"></i>
                    </button>
                    <p th:id="'postit-text-' + ${signRequest.id}" class="postitarea" th:text="${signRequest.parentSignBook.description}"></p>
                </div>
                <th:block th:each="postit, iterate : ${postits}">
                    <div th:id="'postit-' + ${postit.id}" class="postit-global d-none overflow-hidden"
                        th:style="'z-index: 1000; cursor: move;background-color: ' + ${postit.postitColor} + ';position: fixed; left: ' + ${290 + (iterate.index * 15)} + 'px; top : ' + ${190 + (iterate.index * 70)} + 'px;'">
                        <button type="button" class="postit-global-close close">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                        <b th:text="${postit.createBy.firstname + ' ' + postit.createBy.name}"></b>
                        <span th:text="'le ' + ${#dates.format(postit.createDate, 'dd/MM/yyyy HH:mm')}"></span>
                        <button th:es-postit-id="${postit.id}" type="button" title="Copier le texte du postit" class="postit-copy btn btn-sm btn-transparent text-dark">
                            <i th:es-postit-id="${postit.id}" class="fa-regular fa-copy"></i>
                        </button>
                        <p th:classappend="${postit.createBy.eppn == userEppn} ? 'd-none' : ''" th:id="'postit-text-' + ${postit.id}" class="postitarea" th:text="${postit.text}"></p>
                        <form style="height: 70%;" th:if="${postit.createBy.eppn == userEppn}" th:action="'/' + ${urlProfil} + '/signrequests/comment/' + ${signRequest.id} + '/update/' + ${postit.id}" th:method="put">
                            <textarea th:style="'width: 100%;height: 75%;resize:none;background-color: ' + ${postit.postitColor}" name="comment" th:id="'postit-text-' + ${postit.id}" class="postitarea" th:text="${postit.text}"></textarea>
                            <button type="submit" class="btn btn-sm btn-dark float-end position-absolute" style="bottom: 10px;right: 25px;" title="Enregistrer"><i class="fa fa-save"></i></button>
                        </form>
                        <form th:if="${postit.createBy.eppn == userEppn}" th:action="'/' + ${urlProfil} + '/signrequests/comment/' + ${signRequest.id} + '/delete/' + ${postit.id}" th:method="delete">
                            <button type="submit" onclick="return confirm('Confirmez-vous la suppression ?');" class="btn btn-sm btn-dark float-start position-absolute" title="Supprimer" style="bottom: 10px;">
                                <i class="fa fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </th:block>
            </div>
            <th:block th:if="${toSignDocument != null && toSignDocument.contentType == 'application/pdf'}">
                <div th:replace="~{user/signrequests/includes/workspace :: workspace}"></div>
            </th:block>
            <th:block th:if="${signRequest.parentSignBook.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).cleaned}">
                <div class="alert alert-success">Les documents contenus dans cette demande de signature ont été archivés. Vous avez la possibilité de les télécharger à l’aide du bouton en bas à droite.</div>
            </th:block>
            <div th:if="${signable && (toSignDocument == null || toSignDocument.contentType != 'application/pdf') && signRequest.originalDocuments.size() > 0}" id="workspace"
                class="workspace alert alert-secondary row" style="margin-top: 128px;">
                <div class="card col-lg-10 mx-auto mb-1">
                    <div class="card-body">
                        <h5 class="text-center">Liste des documents originaux</h5>
                        <div class="file-loading">
                            <input id="multipartFiles" name="multipartFiles" type="file" multiple="multiple"/>
                        </div>
                    </div>
                </div>
                <div class="card col-lg-10 mx-auto"
                    th:if="${signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).completed || signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).exported}">
                    <div class="card-body">
                        <h5 class="text-center">Liste des documents signés</h5>
                        <div class="file-loading">
                            <input id="signedFiles" name="signedFiles" type="file" multiple="multiple"/>
                        </div>
                    </div>
                </div>
                <script th:inline="javascript" type="module">
                    import {default as FilesInput} from '/js/modules/utils/FilesInput.js?version=@[(${versionApp})]@';
                    new FilesInput($("#multipartFiles"),[[${globalProperties.maxUploadSize}]], [[${_csrf}]], [[${signRequest.originalDocuments}]], true);
                    new FilesInput($("#signedFiles"),[[${globalProperties.maxUploadSize}]], [[${_csrf}]], [[${signRequest.signedDocuments}]], true);
                </script>
            </div>
            <div th:if="${!signable && toSignDocument == null && signRequest.originalDocuments.size() > 0}" class="workspace alert alert-danger">
                Un document de cette demande est corrompu. Merci de supprimer la demande et d’en émettre une nouvelle à l’aide d’un fichier valide.
            </div>
            <div th:if="${toSignDocument.contentType != 'application/pdf' && (signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).completed || signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).exported || signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).archived || signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).cleaned)}" class="workspace alert alert-success">
                Le document a bien été signé, vous pouvez le téléchargé
            </div>
            <div th:if="${toSignDocument == null && signRequest.deleted}" class="alert alert-danger">
                <h4>La demande de signature a été supprimée</h4>
                <p th:if="${signRequest.exportedDocumentURI != null}">
                    Vous trouverez une copie du document signé ici : <a th:href="${signRequest.exportedDocumentURI}" th:text="${signRequest.exportedDocumentURI}"></a>
                </p>
            </div>
        </div>
    </div>
</main>

<div id="wait" data-bs-focus="false" class="modal fade"  role="dialog" data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body text-center">
                <h5>Signature du document</h5>
                <div id="signSpinner" class="justify-content-center">
                    <div class="spinner-border" role="status" style="width: 3rem; height: 3rem;">
                        <span class="sr-only">En cours...</span>
                    </div>
                </div>
                <div id="signError" class="alert alert-danger text-left" role="alert">
                    Erreur du système de signature
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeModal" type="button" class="btn btn-secondary align-self-center" data-bs-dismiss="modal">
                    Fermer
                </button>
                <button id="validModal" onclick="location.reload();" class="btn btn-secondary">Terminer</button>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/sign-modal :: sign-modal}"></div>

<div th:if="${signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).draft}"
    data-bs-focus="false" class="modal fade" id="sendModal"  role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Démarrer le circuit</h3>
                <button type="button" class="btn-close" title="Fermer" data-bs-dismiss="modal"
                        aria-label="Close">
                </button>
            </div>
            <form th:action="'/user/signbooks/pending/' + ${signBook.id}" method="post">
                <div class="modal-body">
                    <th:block th:unless="${steps.size() > 0}">
                        <p th:unless="${signRequest.parentSignBook.liveWorkflow.liveWorkflowSteps.size() > 0}">
                            Après la validation, vous pourrez télécharger le document
                        </p>
                    </th:block>
                    <div th:if="${steps.size() > 0 || signRequest.parentSignBook.liveWorkflow.liveWorkflowSteps.size() > 0}">
                        <th:block th:if="${signRequest.parentSignBook.liveWorkflow.workflow != null && signRequest.parentSignBook.liveWorkflow.liveWorkflowSteps.size() > 0}">
                            <h5>
                                Le circuit comporte <span
                                    th:text="${signRequest.parentSignBook.liveWorkflow.workflow.workflowSteps.size()}"></span>
                                étape<span
                                    th:if="${signRequest.parentSignBook.liveWorkflow.workflow.workflowSteps.size() > 1}">s</span>
                            </h5>
                            <br>
                            <ul class="list-group">
                                <th:block th:each="step, iterator : ${steps}">
                                    <li class="list-group-item">
                                        <div class="form-group d-inline mb-1">
                                            <span th:text="'Etape ' + ${iterator.index + 1} + ' : '"></span><span
                                                th:text="${step.description != null ?  step.description + ' (' : ''}"></span>
                                            <th:block th:if="${step.users.size() > 0}" th:each="user, iterator : ${step.users}">
                                                <span th:if="${iterator.index > 0}"> ou </span>
                                                <span th:text="${user.firstname} + ' ' + ${user.name}"></span>
                                            </th:block>
                                            <span th:text="${step.description != null ?  ')' : ''}"></span>
                                        </div>
                                    </li>
                                </th:block>
                            </ul>
                        </th:block>

                        <th:block th:if="${signRequest.parentSignBook.liveWorkflow.workflow != null && signRequest.parentSignBook.liveWorkflow.liveWorkflowSteps.size() == 0}">
                            <h5>
                                Le circuit comporte <span
                                    th:text="${signRequest.parentSignBook.liveWorkflow.workflow.workflowSteps.size()}"></span>
                                étape<span
                                    th:if="${signRequest.parentSignBook.liveWorkflow.workflow.workflowSteps.size() > 1}">s</span>
                            </h5>
                            <br>
                            <ul class="list-group">
                            <th:block th:each="step, iterator : ${steps}">
                                <li class="list-group-item">
                                <!--                            <div class="form-group mb-3">-->
                                <!--                                <span th:text="'Etape ' + ${iterator.index + 1} + ' : ' + ${liveWorkflowStep.description}"></span>-->
                                <!--                            </div>-->
                                <div th:if="${step.changeable == true}" class="form-group mb-1">
                                    <span th:text="'Etape ' + ${iterator.index + 1} + ' : '"></span><span
                                        th:text="${step.description != null ?  step.description : ''}"></span>
                                </div>
                                <div th:unless="${step.changeable == true}" class="form-group d-inline mb-1">
                                    <span th:text="'Etape ' + ${iterator.index + 1} + ' : '"></span><span
                                        th:text="${step.description != null ?  step.description + ' (' : ''}"></span>
                                    <th:block th:if="${step.users.size() > 0}" th:each="user, iterator : ${step.users}">
                                        <span th:if="${iterator.index > 0}"> ou </span>
                                        <span th:text="${user.firstname} + ' ' + ${user.name}"></span>
                                    </th:block>
                                    <span th:text="${step.description != null ?  ')' : ''}"></span>
                                </div>
                                <div th:if="${step.changeable == true}" class="form-group mb-1">
                                    <label><span th:text="'Vous pouvez modifier ou saisir le(s) participant(s) pour l\'étape ' + ${iterator.index + 1}"></span></label>
                                    <select class="auto-select-users"
                                            th:data-signrequest-id="${signRequest.id}"
                                            th:id="'recipientEmailsSelect_' + ${iterator.index + 1}"
                                            multiple="multiple" name="recipientEmails" required="required">
                                        <option data-placeholder="true"></option>
                                        <th:block th:each="user : ${step.users}">
                                            <option th:if="${user.email != null}" selected="selected"
                                                    th:text="${user.email}"
                                                    th:value="${user.email}"></option>
                                        </th:block>
                                    </select>
                                    <p class="small">
                                        Les signataires sont pré-sélectionnés en fonction de vos précédentes saisies.
                                    </p>
                                </div>
                                <div th:id="'tempUsers-recipientEmailsSelect_' + ${iterator.index + 1}"></div>
                                </li>
                            </th:block>
                            </ul>
                        </th:block>
                        <th:block th:unless="${signRequest.parentSignBook.liveWorkflow.workflow != null}">
                            <p>
                                La procédure comporte une étape
                            </p>
                            <th:block th:each="liveWorkflowStep, iterator : ${signRequest.parentSignBook.liveWorkflow.liveWorkflowSteps}">
                                <!--                            <div class="form-group mb-3">-->
                                <!--                                <span th:text="'Etape ' + ${iterator.index + 1} + ' : ' + ${liveWorkflowStep.description}"></span>-->
                                <!--                            </div>-->
                                <p>
                                    <span th:text="'Etape ' + ${iterator.index + 1} + ' : '"></span>
                                    <th:block th:if="${liveWorkflowStep.recipients.size() > 0}" th:each="recipient, iterator : ${liveWorkflowStep.recipients}">
                                        <span th:if="${iterator.index > 0}"> ou </span>
                                        <span th:text="${recipient.user.firstname} + ' ' + ${recipient.user.name}"></span>
                                    </th:block>
                                </p>
                            </th:block>
                        </th:block>
                        <th:block th:if="${isTempUsers}">
                            <hr>
                            <p>Certains destinataires sont externes à l'établissement, merci de saisir/vérifier les informations complémentaires si besoin</p>
                            <th:block th:each="liveWorkflowStep : ${signRequest.parentSignBook.liveWorkflow.liveWorkflowSteps}">
                                <th:block th:each="recipient : ${liveWorkflowStep.recipients}">
                                    <div th:if="${recipient.user.userType.name() == 'external'}">
                                        <b>Destinataire : <span th:text="${recipient.user.email}"></span></b>
                                        <div class="form-inline">
                                            <input id="emails" type="hidden" name="emails" th:value="${recipient.user.email}">
                                            <label for="names">Nom</label>
                                            <input id="names" class="form-control me-2" type="text" name="names" th:value="${recipient.user.firstname != 'Nouvel utilisateur'} ? ${recipient.user.name} : ''" required>
                                            <label for="firstnames">Prénom</label>
                                            <input id="firstnames" class="form-control me-2" type="text" name="firstnames" th:value="${recipient.user.firstname != 'Nouvel utilisateur'} ? ${recipient.user.firstname} : ''" required>
                                            <label for="phones">Mobile</label>
                                            <input id="phones" class="form-control  me-2" type="text" name="phones" value="">
                                        </div>
                                    </div>
                                </th:block>
                            </th:block>
                            <th:block th:if="${signRequest.parentSignBook.liveWorkflow.liveWorkflowSteps.size() == 0}" th:each="workflowStep : ${steps}">
                                <th:block th:each="user : ${workflowStep.users}">
                                    <div th:if="${user.userType.name() == 'external'}">
                                        <b>Destinataire : <span th:text="${user.email}"></span></b>
                                        <div class="form-inline">
                                            <input id="emails" type="hidden" name="emails" th:value="${user.email}">
                                            <label for="names">Nom</label>
                                            <input id="names" class="form-control me-2" type="text" name="names" th:value="${user.name}" required>
                                            <label for="firstnames">Prénom</label>
                                            <input id="firstnames" class="form-control me-2" type="text" name="firstnames" th:value="${user.firstname}" required>
                                            <label for="phones">Mobile</label>
                                            <input id="phones" class="form-control  me-2" type="text" name="phones" th:value="${user.eppn}" th:required="${globalProperties.smsRequired}">
                                        </div>
                                    </div>
                                </th:block>
                            </th:block>
                        </th:block>
                        <th:block th:each="target : ${signRequest.parentSignBook.liveWorkflow.targets}">
                        <div th:if="${target != null && target.targetUri != null && target.targetUri.contains('mailto:')}" class="form-group mb-3">
                            <label>Etape finale : Envoi par mail à </label>
                            <select class="auto-select-users" id="targetEmailsSelect" multiple="multiple" name="targetEmails" required>
                                <th:block th:each="targetEmail : ${target.targetUri.replace('mailto:', '').split(',')}">
                                    <option selected="selected" th:if="${targetEmail != ''}" th:text="${targetEmail}" th:value="${targetEmail}"></option>
                                </th:block>
                            </select>
                        </div>
                        </th:block>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary float-start" data-bs-dismiss="modal">Annuler</button>
                    <input type="hidden" name="draft" value="false">
                    <button type="submit" class="btn btn-success">Valider</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div th:if="${@preAuthorizeService.signRequestOwner(signRequest.id, authUserEppn)}" data-bs-focus="false" class="modal modal-lg modal-warning fade in" th:id="'modal-warning-' + ${signRequest.id}">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="command" th:action="'/user/signrequests/'+ ${signRequest.id}" th:method="delete">
                <input th:if="${!signRequest.deleted && signBook.signRequests.size() > 1}" type="hidden" name="definitive" value="true">
                <div class="modal-header">
                    <h2>Attention</h2>
                    <button type="button" class="btn-close" title="Fermer" data-bs-dismiss="modal" aria-label="Close">

                    </button>
                </div>
                <div class="modal-body">
                    <div th:if="${!signRequest.deleted && signBook.signRequests.size() > 1}" class="alert alert-danger">Confirmez-vous la suppression définitive de ce document ? (les autres documents de la demande sont conservés)</div>
                    <div th:if="${!signRequest.deleted && signBook.signRequests.size() == 1}" class="alert alert-danger">
                        <h4>Confirmez-vous la mise à la corbeille de cette demande ?</h4>
                        <div class="form-check mt-4 mb-2">
                            <input class="form-check-input" type="checkbox" value="true" id="definitive" name="definitive" onclick="alert('Attention cette action est irreversible !')">
                            <label class="form-check-label" for="definitive">
                                Cocher pour supprimer <b>définitivement</b> la demande sans passer par la corbeille
                            </label>
                        </div>
                    </div>
                    <div th:if="${signRequest.deleted}" class="alert alert-danger">Confirmez-vous la suppression définitivement de cette demande ?</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary float-start" data-bs-dismiss="modal">Non</button>
                    <button type="submit" class="btn btn-danger">Oui</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div data-bs-focus="false" class="modal fade" id="refuseModal"  role="dialog" aria-labelledby="refuseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form th:action="'/' + ${urlProfil} + '/signrequests/refuse/' + ${signRequest.id}" method="post">
                <div class="modal-header">
                    <h3 class="modal-title" id="refuseModalLabel">Refuser la demande de signature</h3>
                    <button type="button" class="btn-close" title="Fermer" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <textarea id="refuseComment" placeholder="Vous devez ajouter un motif de refus. Celui-ci sera visible par tous les participants" class="form-control" name="comment" required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <div th:unless="${signType == T(org.esupportail.esupsignature.entity.enums.SignType).signature}">
                        <button type="submit" id="refuseEnd" name="redirect" value="end" th:if="${signBook.signRequests.size() == 1 || nextSignBook == null}"
                                class="btn btn-danger me-1" title="Refuser" autofocus>
                            <span>Refuser</span>
                        </button>
                        <button type="submit" id="refuseNext" th:if="${nextSignRequest != null && otp == null}" name="redirect" th:value="${nextSignRequest.id}"
                                class="btn btn-danger" title="Refuser et aller à la suivante" autofocus>
                            <span>Refuser et aller à la suivante </span>
                            <i class="fa-solid fa-arrow-alt-circle-right"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div data-bs-focus="false" class="modal fade" id="detailsModal"  role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="detailsModalLabel">Details de la demande</h3>
                <button type="button" class="btn-close" title="Fermer" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div th:replace="~{user/signrequests/includes/details :: details}"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<div data-bs-focus="false" class="modal fade" id="sendLinkModal"  role="dialog" aria-labelledby="sendLinkLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="sendLinkLabel">Transmettre un lien d’accès à un utilisateur externe</h3>
                <button type="button" class="btn-close" title="Fermer" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-striped table-borderless table-hover">
                    <tr>
                        <th>Email</th>
                        <th>Actions</th>
                    </tr>
                <th:block th:each="extrenalRecipient : ${externalsRecipients}">
                    <tr>
                        <td th:text="${extrenalRecipient.email}"></td>
                        <td>
                            <form th:action="'/user/signrequests/send-otp-download/' + ${signRequest.parentSignBook.id} + '/' + ${extrenalRecipient.id}" method="post" class="d-inline-flex">
                                <input type="text" name="phone" class="form-control me-1" placeholder="Numéro de mobile" th:value="${extrenalRecipient.phone}" th:if="${globalProperties.smsRequired}">
                                <button type="submit" class="btn btn-success" title="Envoyer un nouveau lien d'accès">Envoyer</button>
                            </form>
                        </td>
                    </tr>
                </th:block>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<div data-bs-focus="false" class="modal fade" id="forwardModal"  role="dialog" aria-labelledby="forwardModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="forwardModalLabel">Réaffecter la demande</h3>
                <button type="button" class="btn-close" title="Fermer" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-3">
                    <p>Vous allez réaffecter la demande à une autre personne que vous.</p>
                    <form id="send-sign-form" method="post" th:action="'/user/signrequests/transfert/' + ${signRequest.id}">
                    <label class="form-label" for="transfertRecipientsEmails">Choisir la personne qui vous remplacera dans cette demande</label>
                    <select class="auto-select-users" name="transfertRecipientsEmails" id="transfertRecipientsEmails" size="1" multiple="multiple" required="required">
                        <option data-placeholder="true"></option>
                    </select>
                    <div class="mt-2 mb-2" id="tempUsers-transfertRecipientsEmails"></div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="keepFollow" id="keepFollow">
                        <label class="form-check-label" for="keepFollow">
                            Continuer de recevoir les alertes mail pour cette demande
                        </label>
                    </div>
                    <button type="submit" class="btn btn-success float-end">Valider</button>
                    <button type="button" class="btn btn-secondary float-end me-1" data-bs-dismiss="modal">Fermer</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div data-bs-focus="false" class="modal fade" id="addViewersModal"  role="dialog" aria-labelledby="viewersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="addViewersLabel">Ajouter des observateurs</h3>
                <button type="button" class="btn-close" title="Fermer" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-3">
                    <form id="add-viewers-form" th:method="post" th:action="'/user/signbooks/add-viewers/' + ${signBook.id}">
                    <label class="form-label" for="transfertRecipientsEmails">Choisir la/les personne(s) à ajouter</label>
                    <select class="auto-select-users mb-4" name="viewers" id="viewers" size="1" multiple="multiple" required="required">
                        <option data-placeholder="true"></option>
                    </select>
                    <button type="submit" class="btn btn-success float-end">Valider</button>
                    <button type="button" class="btn btn-secondary float-end me-1" data-bs-dismiss="modal">Fermer</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div data-bs-focus="false" class="modal fade" id="cloneModal"  role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true" th:if="${(signRequest.parentSignBook.liveWorkflow.workflow == null || signRequest.parentSignBook.liveWorkflow.workflow.authorizeClone) && signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).refused && signRequest.createBy.eppn == userEppn}">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form th:action="'/user/signrequests/clone/' + ${signRequest.id}" method="post" enctype="multipart/form-data">
                <div class="modal-header">
                    <h3 class="modal-title" id="cloneLabel">Redémarrer cette demande</h3>
                    <button type="button" class="btn-close" title="Fermer" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="alert alert-primary mb-1">
                        Cette action permet de créer une nouvelle demande signature en reprenant le même circuit. Le nouveau circuit sera cloné et redémarré de zéro, merci donc de déposer un document, corrigé, ne contenant pas les signatures faites via le circuit actuel.
                    </p>
                    <label for="multipartFiles1">
                        <b>Nouveau document</b>
                    </label>
                    <br>
                    <input id="multipartFiles1" name="multipartFiles" type="file" multiple="multiple" />
                        <script th:inline="javascript" type="module">
                            $("#multipartFiles1").fileinput({
                                    language: "fr",
                                    showCaption: false,
                                    minFileSize: 1,
                                    showClose: false,
                                    showCancel: false,
                                    showBrowse: true,
                                    showUpload: false,
                                    showUploadStats: false,
                                    progressDelay: 50,
                                    maxAjaxThreads: 1,
                                    uploadAsync: false,
                                    theme: 'explorer-fa6',
                                    pdfRendererUrl: 'http://plugins.krajee.com/pdfjs/web/viewer.html',
                                    overwriteInitial: false,
                                    preferIconicPreview: true,
                                    showRemove: true,
                                    dropZoneEnabled: true,
                                    browseOnZoneClick: true,
                                    allowedFileTypes : [],
                                    previewFileIconSettings: {
                                        'pdf': '<i class="fa-solid fa-file-pdf text-danger fa-xl"></i>',
                                        'doc': '<i class="fa-solid fa-file-word text-primary fa-xl"></i>',
                                        'xls': '<i class="fa-solid fa-file-excel text-success fa-xl"></i>',
                                        'ppt': '<i class="fa-solid fa-file-powerpoint text-danger fa-xl"></i>',
                                        'zip': '<i class="fa-solid fa-file-archive text-muted fa-xl"></i>',
                                        'htm': '<i class="fa-solid fa-file-code text-info fa-xl"></i>',
                                        'txt': '<i class="fa-solid fa-file-alt text-info fa-xl"></i>',
                                        'mov': '<i class="fa-solid fa-file-video text-warning fa-xl"></i>',
                                        'mp3': '<i class="fa-solid fa-file-audio text-warning fa-xl"></i>',
                                        'jpg': '<i class="fa-solid fa-file-image text-danger fa-xl"></i>',
                                        'gif': '<i class="fa-solid fa-file-image text-muted fa-xl"></i>',
                                        'png': '<i class="fa-solid fa-file-image text-primary fa-xl"></i>',
                                        'other': '<i class="fa-solid fa-file text-muted fa-xl"></i>'
                                    },
                                    previewFileExtSettings: {
                                        'other': function() {
                                            return true;
                                        },
                                        'pdf': function(ext) {
                                            return ext.match(/(pdf)$/i);
                                        },
                                        'doc': function(ext) {
                                            return ext.match(/(doc|docx|odt)$/i);
                                        },
                                        'xls': function(ext) {
                                            return ext.match(/(xls|xlsx)$/i);
                                        },
                                        'ppt': function(ext) {
                                            return ext.match(/(odp|ppt|pptx)$/i);
                                        },
                                        'zip': function(ext) {
                                            return ext.match(/(zip|rar|tar|gzip|gz|7z)$/i);
                                        },
                                        'htm': function(ext) {
                                            return ext.match(/(htm|html)$/i);
                                        },
                                        'txt': function(ext) {
                                            return ext.match(/(txt|ini|csv|java|php|js|css)$/i);
                                        },
                                        'mov': function(ext) {
                                            return ext.match(/(avi|mpg|mkv|mov|mp4|3gp|webm|wmv)$/i);
                                        },
                                        'mp3': function(ext) {
                                            return ext.match(/(mp3|wav)$/i);
                                        }
                                    }
                                }
                            );
                        </script>
                    <br>
                    <label for="comment">
                        <b>Commentaire (obligatoire)</b>
                    </label>
                    <textarea id="comment" name="comment" class="form-control" rows="3" style="background-color: #FFF740;" required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="submit" class="btn btn-success">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div data-bs-focus="false" class="modal fade" id="addCommentModal"  role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form th:action="'/' + ${urlProfil} + '/signrequests/postit/' + ${signRequest.id}" method="post">
                <div class="modal-header">
                    <h3 class="modal-title" id="addCommentLabel">Ajouter un post-it</h3>
                    <button type="button" class="btn-close" title="Fermer" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <textarea name="comment" class="form-control" rows="3" style="background-color: #FFF740;"></textarea>
                    <br>
                    <input type="hidden" name="postit" value="on" />
                    <div class="form-check mb-3">
                        <label for="forceSend" class="form-check-label">Forcer l’envoi par mail à tous les participants</label>
                        <input type="checkbox" class="form-check-input" id="forceSend" name="forceSend">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="submit" class="btn btn-success">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div th:replace="~{user/signrequests/includes/modals/attachment :: attachment}"></div>
<div id="add-sign-image" class="modal" >
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" title="Fermer" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-2" th:if="${signImages == null || signImages.size() <= 2}">
                    Vous n’avez pas encore d’image de signature dans votre profil. Merci de saisir à minima vos nom et prénom pour en ajouter une. Vous pouvez aussi dessiner une signature ci-dessous ou importer une image.
                    <br>
                    Après l’enregistrement, vous devrez cliquer de nouveau sur "Mes signature" pour la voir apparaître.
                </div>
                <div class="alert alert-light mb-2" th:unless="${signImages == null || signImages.size() <= 2}">
                    <h4 class="text-start"><strong>Mes Signatures</strong></h4>
                        <div style="height: 150px;" th:if="${userImagesIds.size() > 0 && userImagesIds.get(0) != null}" id="carouselSign2" class="carousel slide border rounded border-secondary">
                            <div class="carousel-inner">
                                <th:block th:each="signImageId, iterator : ${userImagesIds}">
                                    <div class="carousel-item text-center" th:classappend="${iterator.index == 0} ? 'active'">
                                        <img height="145" class="bg-white" th:src="'/ws-secure/users/get-sign-image/' + ${signImageId}" alt="sign image" />
                                        <a style="position: absolute; top: 110px; left: 30%;" th:title="${user.defaultSignImageNumber == iterator.index}? 'Ma signature favorite' : 'Choisir comme signature favorite '"
                                            th:href="'/' + ${urlProfil} + '/users/set-default-sign-image/' + ${iterator.index}" role="button"
                                            class="btn btn-light btn-outline-light" th:classappend="${user.defaultSignImageNumber == iterator.index} ? 'text-warning' : 'text-secondary'">
                                            <i class="fa-solid fa-star"></i>
                                        </a>
                                        <form style="position: absolute; top: 110px; left: 60%;" th:id="'deleteForm-' + ${signImageId}" th:action="'/' + ${user.userType.name() == 'external' ? 'otp' : 'user'} + '/users/delete-sign/' + ${signImageId}" th:method="'delete'">
                                            <button type="submit" th:id="'deleteSign_' + ${signImageId}" th:data-es-id="${signImageId}" class="btn btn-sm btn-danger text-white">
                                                <i class="fa-solid fa-trash-alt"></i>
                                            </button>
                                        </form>
                                    </div>
                                </th:block>
                            </div>
                            <button title="Signature précédente" class="carousel-control-prev" href="#carouselSign2" role="button" data-bs-slide="prev">
                                <span class="text-dark" aria-hidden="true"><i class="fa-solid fa-chevron-left"></i></span>
                                <span class="sr-only">Previous</span>
                            </button>
                            <button title="Signature suivante" class="carousel-control-next" href="#carouselSign2" role="button" data-bs-slide="next">
                                <span class="text-dark" aria-hidden="true"><i class="fa-solid fa-chevron-right"></i></span>
                                <span class="sr-only">Next</span>
                            </button>
                        </div>
                </div>
                <form id="userParamsForm" th:object="${authUser}" th:action="'/' + ${user.userType.name() == 'external' ? 'otp' : 'user'} + '/users?' + ${_csrf.parameterName} + '=' + ${_csrf.token}" enctype="multipart/form-data" method="post">
                    <input type="hidden" name="id" th:value="${authUser.id}"/>
                    <input type="submit" class="d-none" id="submitUserParamsForm" />
                    <div class="alert alert-light mb-2" th:if="${user.userType.name() == 'external'}">
                        <h4 class="text-start"><strong>Mettre à jour mon identité</strong></h4>
                        <label class="col-form-label">
                            <strong>Nom</strong>
                        </label>
                        <input type="text" class="form-control" id="name" name="name" th:value="${authUser.name}" required="required"/>
                        <label class="col-form-label">
                            <strong>Prénom</strong>
                        </label>
                        <input type="text" class="form-control" id="firstname" name="firstname" th:value="${authUser.firstname}" required="required"/>
                    </div>
                    <div class="alert alert-light text-center">
                        <h4 class="text-start"><strong>Ajouter une signature</strong></h4>
                        <label class="col-form-label">
                            <strong>Vous pouvez choisir une image provenant de votre ordinateur</strong>
                            <button data-bs-target="#collapseHelpSignImage" data-bs-toggle="collapse"
                                    type="button"
                                    class="btn btn-sm btn-transparent">
                                <i class="fa-solid fa-info-circle text-info"></i>
                            </button>
                            <div class="collapse" id="collapseHelpSignImage">
                                <div class="alert alert-info">
                                    <small> Après avoir sélectionné une image, vous pourrez ajuster sa
                                        taille pour
                                        que la signature entre dans le carré blanc. La résolution de l’image sera de 600*300 pixels.
                                    </small>
                                </div>
                            </div>
                        </label>
                        <div class="mx-auto mb-1" style="width: 600px;">
                            <input type="file" class="form-control" id="vanilla-upload" value="Choose a file" accept="image/*" aria-describedby="inputGroupFileAddon01"/>
                        </div>
                        <label id="signPadLabel" class="col-form-label"><strong>Vous pouvez dessiner une signature dans le rectangle ci dessous</strong></label>
                        <div id="signPad">
                            <div class="signature-pad-background">
                                Dessinez votre signature ici
                            </div>
                            <canvas id="canvas" style="border: 1px solid black;"></canvas>
                            <button id="erase" type="button" class="btn btn-light btn-outline-dark float-left">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div id="sign-crop" class="mx-auto">
                        <div id="crop-div" class="alert alert-light text-dark text-center" style="display: none;">
                            <div class="d-flex justify-content-center">
                                <button type="button" id="crop-zoomout"
                                        class="btn btn-light btn-outline-dark ms-1 d-none d-lg-block">
                                    <i class="fa-solid fa-search-minus"></i></button>
                                <button type="button" id="crop-zoomin"
                                        class="btn btn-light btn-outline-dark ms-1 d-none d-lg-block">
                                    <i class="fa-solid fa-search-plus"></i></button>
                                <button type="button"
                                        class="btn btn-light btn-outline-dark ms-1 d-none d-lg-block vanilla-rotate"
                                        data-deg="90"><i class="fa-solid fa-undo"></i></button>
                                <button type="button"
                                        class="btn btn-light btn-outline-dark ms-1 d-none d-lg-block vanilla-rotate"
                                        data-deg="-90"><i class="fa-solid fa-redo"></i></button>
                            </div>
                            <div id="vanilla-crop" class="mt-2"></div>
                        </div>
                    </div>
                    <input type="hidden" id="signImageBase64" name="signImageBase64" value="">
                    <div class="text-end">
                    <a id="saveButton" class="btn btn-success align-self-end mt-2 mb-2">
                        <i class="fa-solid fa-save"></i> Enregistrer la signature
                    </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<footer th:replace="~{fragments/footer :: footer}"></footer>
<script th:inline="javascript" type="module">
    import {SignUi} from '/js/modules/ui/signrequests/SignUi.js?version=@[(${versionApp})]@';
    let signable = [[${signable}]];
    let editable = [[${editable}]];
    let currentSignType = [[${signRequest.currentSignType}]];
    sessionStorage.setItem("favoriteSignRequestParams", [[${favoriteSignRequestParamsJson}]]);
    new SignUi(
        [[${signRequest.id}]],
        [# th:if="${signRequest.data != null}"]
            [[${signRequest.data.id}]],
        [/]
        [# th:unless="${signRequest.data != null}"]
            null,
        [/]
        [# th:if="${signRequest.data != null && signRequest.data.form != null}"]
            [[${signRequest.data.form.id}]],
        [/]
        [# th:unless="${signRequest.data != null && signRequest.data.form != null}"]
            null,
        [/]
        [[${toUseSignRequestParams}]],
        [[${user.defaultSignImageNumber}]],
        currentSignType,
        signable,
        editable,
        [[${signRequest.comments}]],
        [[${toSignDocument != null && toSignDocument.contentType == 'application/pdf'}]],
        [[${currentStepNumber}]],
        [[${currentStepMultiSign}]],
        [[${currentStepSingleSignWithAnnotation}]],
        [[${currentStepMinSignLevel}]],
        [# th:if="${signRequest.parentSignBook.liveWorkflow.currentStep != null}"]
            [[${workflow != null}]],
        [/]
        [# th:if="${signRequest.parentSignBook.liveWorkflow.currentStep == null}"]
            null,
        [/]
        [[${signImages}]],
        [[${user.firstname + ' ' + user.name}]],
        [[${authUser.firstname + ' ' + authUser.name}]],
        [[${_csrf}]],
        [[${fields}]],
        [# th:if="${signRequest.parentSignBook.liveWorkflow.currentStep != null}"]
            [[${signRequest.parentSignBook.liveWorkflow.currentStep.repeatable}]],
        [/]
        [# th:if="${signRequest.parentSignBook.liveWorkflow.currentStep == null}"]
            null,
        [/]
        [[${signRequest.status}]],
        [[${action}]],
        [[${signRequest.parentSignBook.signRequests.size()}]],
        [[${isNotSigned}]],
        [[${attachmentAlert}]],
        [[${attachmentRequire}]],
        [[${#authorization.expression('hasRole(''ROLE_OTP'')')}]],
        [[${user.favoriteSignRequestParams == null} ? true : false]],
        [[${user.phone}]],
        [[${user.returnToHomeAfterSign}]]
    );

</script>
</body>
</html>
