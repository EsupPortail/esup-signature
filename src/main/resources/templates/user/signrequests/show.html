<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<!--/*@thymesVar id="signBook" type="org.esupportail.esupsignature.entity.SignBook"*/-->
<!--/*@thymesVar id="signRequest" type="org.esupportail.esupsignature.entity.SignRequest"*/-->
<!--/*@thymesVar id="postits" type="java.util.List<org.esupportail.esupsignature.entity.Comment>"*/-->
<!--/*@thymesVar id="globalProperties" type="org.esupportail.esupsignature.config.GlobalProperties"*/-->
<!--/*@thymesVar id="signatureIds" type="java.util.List<String>"*/-->
<!--/*@thymesVar id="currentSignType" type="org.esupportail.esupsignature.entity.enums.SignType"*/-->
<!--/*@thymesVar id="signable" type="java.lang.Boolean"*/-->
<head th:replace="fragments/head :: head"></head>
<body>
<header th:unless="${frameMode}" th:replace="fragments/nav :: nav"></header>
<script>
    // Include model attributs for online forms javascript
    /*<![CDATA[*/
    class User {
        constructor(id, eppn, name, firstname, email) {
            this.id = id;
            this.eppn = eppn;
            this.login = eppn.split("@")[0];
            this.name = name;
            this.firstname = firstname;
            this.email = email;
        }
    }
    const user = new User([[${user.id}]], "[[${user.eppn}]]", "[[${user.name}]]", "[[${user.firstname}]]", "[[${user.email}]]");
    const creator = new User([[${signRequest.createBy.id}]], "[[${signRequest.createBy.eppn}]]", "[[${signRequest.createBy.name}]]", "[[${signRequest.createBy.firstname}]]");
    const currentStepNumber = "[[${currentStepNumber}]]";
    const supervisors = "[[${supervisors}]]";
    const isLastStep = "[[${isLastStep}]]";
    /*]]>*/
</script>

<main role="main">
    <div class="wrapper">
        <nav th:replace="fragments/sides/side-sign :: side-sign"></nav>
        <nav id="breadcrumb" aria-label="breadcrumb" class="breadcrumb-nav">
            <ol class="breadcrumb">
                <li th:if="${editable && userEppn == authUserEppn}" class="breadcrumb-item"><a href="/user/signbooks">Tableau
                    de bord</a></li>
                <li th:if="${userEppn == authUserEppn}" th:unless="${editable}" class="breadcrumb-item"><a
                        href="/user/signbooks/?statusFilter=toSign">Documents à signer</a></li>
                <li class="breadcrumb-item active" aria-current="page">Demande : <span
                        th:text="${signRequest.parentSignBook.subject}"></span>&nbsp;du&nbsp;<span
                        th:text="${#dates.format(signRequest.createDate, 'dd/MM/yyyy HH:mm')}"></span>
                </li>
            </ol>
        </nav>
        <div id="content" class="content">
            <div id="signButtons" class="fixed-action-btns active">
                <ul id="buttonList" class="list-unstyled">
                    <li th:if="${signable && signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).visa && signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">
                        <a id="signLaunchButton" role="button" class="btn-floating btn-lg bg-success waves-effect"
                            title="Signer"><i class="fas fa-file-signature"></i></a>
                    </li>
                    <li th:unless="${!signable || signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).visa && signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">
                        <a id="visaLaunchButton" role="button" class="btn-floating btn-lg bg-success waves-effect"
                            title="Viser"><i class="fas fa-check"></i></a>
                    </li>
                    <li th:if="${signRequest.createBy.eppn != userEppn && signable && signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).pending}">
                        <a id="refuseLaunchButton" role="button" class="btn-floating btn-lg bg-danger waves-effect" title="Refuser"
                            th:token="${signRequest.token}" data-bs-toggle="modal" data-bs-target="#refuseModal"><i
                                class="fas fa-file-excel"></i></a>
                    </li>
                    <li th:if="${signRequest.createBy.eppn == userEppn && signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).deleted}">
                        <a th:href="'/user/signrequests/restore/' + ${signRequest.id}" role="button" class="btn-floating btn-lg bg-primary waves-effect" title="Restaurer"><i class="fas fa-trash-restore"></i></a>
                    </li>
                    <li th:if="${@preAuthorizeService.signRequestOwner(signRequest.id, authUserEppn)}">
                        <a id="trashLaunchButton" role="button" class="btn-floating btn-lg bg-danger waves-effect"
                           th:title="${signRequest.status != T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).deleted ? 'Mettre à la corbeille' : 'Supprimer de la corbeille'}"
                           data-bs-toggle="modal" th:data-bs-target="'#modal-warning-' + ${signRequest.id}">
                            <span th:if="${signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).deleted}" class="fa-stack">
                              <i class="fas fa-trash-alt" style="opacity: 0.85;"></i>
                              <i class="fas fa-ban fa-stack-1x" style="font-size: 41px;"></i>
                            </span>
                            <i th:if="${signRequest.status != T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).deleted}" class="fas fa-trash-alt"></i>
                        </a>
                    </li>
                    <li th:if="${signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).pending}">
                        <a class="btn-lg btn-floating bg-primary waves-effect"
                           th:href="'/ws-secure/signrequests/get-last-file/' + ${id}" target="_blank"
                           title="Télécharger le document"><i class="fas fa-file-download"></i></a>
                    </li>
                    <li th:if="${signRequest.status != T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).pending}">
                        <a class="btn-lg btn-floating bg-primary waves-effect"
                           th:href="'/ws-secure/signrequests/get-last-file/' + ${id}" target="_blank"
                           title="Télécharger la dernière version du document"><i class="fas fa-file-download"></i></a>
                    </li>
                    <li th:if="${signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).completed || signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).exported || signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).archived || signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).cleaned}">
                        <a class="btn-lg btn-floating bg-primary waves-effect"
                           onclick='alert("Le document ainsi téléchargé est destiné exclusivement à l`impression. Les signatures éléctroniques ne sont présentes que dans la version numérique")'
                           th:href="'/ws-secure/signrequests/print-with-code/' + ${id}" target="_blank"
                           title="Imprimer avec un code datamatrix"><i class="fas fa-print"></i></a>
                    </li>
                    <th:block id="signButtons" th:if="${signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).draft}" th:unless="${signable}" class="fixed-action-btns active">
                        <li>
                            <a role="button" class="btn-floating btn-lg bg-success waves-effect" title="Démarrer le circuit"
                               data-bs-toggle="modal" data-bs-target="#sendModal"><i class="fas fa-play"></i>
                            </a>
                        </li>
<!--                        <li>-->
<!--                            <a role="button" class="btn-floating btn-lg bg-danger waves-effect" title="Supprimer"-->
<!--                               data-bs-toggle="modal" data-bs-target="#modal-warning"-->
<!--                               th:data-bs-target="'#modal-warning-' + ${signRequest.id}"><i class="fas fa-trash-alt"></i>-->
<!--                            </a>-->
<!--                        </li>-->
                    </th:block>
                <th:block id="openButtons" class="fixed-action-btns active"
                     th:if="${viewRight && (signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).deleted || signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).completed || signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).exported || signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).archived || signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).cleaned)}"
                     onmouseover="$('#openButtons').toggleClass('active');"
                     onmouseout="$('#openButtons').toggleClass('active');">
                    <li>
                        <a class="btn-lg btn-floating bg-primary waves-effect"
                           th:href="'/ws-secure/signrequests/get-last-file-report/' + ${id}" target="_blank"
                           title="Enregistrer le document signé et le rapport de signature"><i class="fas fa-file-archive"></i></a>
                    </li>
                    <li><a title="Export SEDA" class="btn btn-floating bg-primary aves-effect d-none" th:href="'/ws-secure/signrequests/get-seda/' + ${id}">
                        <i class="fas fa-file-export"></i>
                    </a></li>
                    <li><a th:if="${signRequest.status != T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).exported}" class="btn btn-floating bg-primary waves-effect d-none" th:href="'/user/validation/document/' + ${id}" title="Contrôler le document">
                        <i class="fas fa-shield-alt "></i>
                    </a></li>
                   </th:block>
                    <li th:if="${nextSignBook != null}" class="">
                        <a id="nextSignBookButton" role="button" th:href="'/user/signbooks/' + ${nextSignBook.id}"
                           class="btn-lg btn-floating bg-primary waves-effect" title="Demande suivante">
                            <i class="fas fa-arrow-right"></i>
                        </a>
                        <a id="nextSignRequest" th:href="'/user/signrequests/' + ${nextSignRequest.id}" class="d-none"></a>
                    </li>
                </ul>
            </div>
            <div th:replace="user/signrequests/includes/tools :: tools"></div>
            <div style="position: absolute;left: 270px;top: 180px;">
                <th:block th:each="postit, iterate : ${postits}">
                    <div class="postit-global d-none"
                         th:style="'background-color: ' + ${postit.postitColor} + ';position: fixed; left: ' + ${280 + (iterate.index * 10)} + 'px; top : ' + ${180 + (iterate.index * 70)} + 'px;'">
                        <button type="button" class="postit-global-close close">
                            <i class="fas fa-eye"></i>
                        </button>
                        <b th:text="${postit.createBy.firstname + ' ' + postit.createBy.name}"></b>
                        <span th:text="'le ' + ${#dates.format(postit.createDate, 'dd/MM/yyyy HH:mm')}"></span>
                        <button th:es-postit-id="${postit.id}" type="button" title="Copier le texte du postit" class="postit-copy btn btn-sm btn-transparent text-dark">
                            <i th:es-postit-id="${postit.id}" class="far fa-copy"></i>
                        </button>
                        <p th:class="${postit.createBy.eppn == userEppn} ? 'd-none' : ''" th:id="'postit-text-' + ${postit.id}" class="postitarea" th:text="${postit.text}"></p>
                        <form style="height: 70%;" th:if="${postit.createBy.eppn == userEppn}" th:action="${'/user/signrequests/comment/' + signRequest.id + '/update/' + postit.id}" th:method="post">
                            <textarea th:style="'height: 70%;background-color: ' + ${postit.postitColor}" name="comment" th:id="'postit-text-' + ${postit.id}" class="postitarea" th:text="${postit.text}"></textarea>
                            <button type="submit" class="btn btn-sm btn-dark float-end"><i class="fa fa-save"></i></button>
                        </form>

                    </div>
                </th:block>
            </div>
            <th:block th:if="${toSignDocument != null && toSignDocument.contentType == 'application/pdf'}">
                <div th:replace="user/signrequests/includes/workspace :: workspace"></div>
            </th:block>
            <th:block th:if="${signRequest.parentSignBook.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).cleaned}">
                <div class="alert alert-success">
                    Le document contenu dans cette demande de signature a été archivé. Vous avez la possibilité de le télécharger à l’aide du bouton en bas à droite.
                </div>
            </th:block>
            <div th:if="${signable && (toSignDocument == null || toSignDocument.contentType != 'application/pdf') && signRequest.originalDocuments.size() > 0}" id="workspace"
                 class="workspace alert alert-secondary row">
                <div class="card col-lg-10 mx-auto mb-1">
                    <div class="card-body">
                        <h5 class="text-center">Liste des documents originaux</h5>
                        <div class="file-loading">
                            <input id="multipartFiles" name="multipartFiles" type="file" multiple="multiple"/>
                        </div>
                    </div>
                </div>
                <div class="card col-lg-10 mx-auto"
                     th:if="${signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).completed || signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).exported}">
                    <div class="card-body">
                        <h5 class="text-center">Liste des documents signés</h5>
                        <div class="file-loading">
                            <input id="signedFiles" name="signedFiles" type="file" multiple="multiple"/>
                        </div>
                    </div>
                </div>
                <script th:inline="javascript" type="module">
                    import {default as FilesInput} from '/js/modules/utils/FilesInput.js?version=[[${versionApp}]]';
                    new FilesInput($("#multipartFiles"),[[${globalProperties.maxUploadSize}]], [[${_csrf}]], "multipartFiles", [[${signRequest.originalDocuments}]], true);
                    new FilesInput($("#signedFiles"),[[${globalProperties.maxUploadSize}]], [[${_csrf}]], "signedFiles", [[${signRequest.signedDocuments}]], true);
                </script>
            </div>
            <div th:if="${!signable && (toSignDocument == null || toSignDocument.contentType != 'application/pdf') && signRequest.originalDocuments.size() > 0}" class="workspace alert alert-danger">
                Un document de cette demande est corrompu. Merci de supprimer la demande et d'en émettre une nouvelle à l'aide d'un fichier valide.
            </div>
            <div th:if="${toSignDocument == null && signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).deleted}" class="alert alert-danger">
                <h4>La demande de signature a été supprimée</h4>
                <p th:if="${signRequest.exportedDocumentURI != null}">
                    Vous trouverez une copie du document signé ici : <a th:href="${signRequest.exportedDocumentURI}" th:text="${signRequest.exportedDocumentURI}"></a>
                </p>
            </div>
        </div>
    </div>
</main>

<div id="wait" data-bs-focus="false" class="modal fade"  role="dialog" data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body text-center">
                <h5>Signature du document</h5>
                <div id="signSpinner" class="justify-content-center">
                    <div class="spinner-border" role="status" style="width: 3rem; height: 3rem;">
                        <span class="sr-only">En cours...</span>
                    </div>
                </div>
                <div id="signError" class="alert alert-danger" role="alert">
                    Erreur du système de signature
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeModal" type="button" class="btn btn-secondary align-self-center" data-bs-dismiss="modal">
                    Fermer
                </button>
                <button id="validModal" onclick="location.reload();" class="btn btn-secondary">Terminer</button>
            </div>
        </div>
    </div>
</div>

<div th:if="${signable}" th:with="signType = ${signRequest.currentSignType}" data-bs-focus="false" class="modal fade" id="signModal"
      role="dialog" aria-labelledby="signModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="signModalLabel">
                    <span th:if="${signType == T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">Confirmer le visa du document</span>
                    <span th:unless="${signType == T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">Confirmer la signature du document</span>
                </h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger mb-1" th:if="${!(signRequest.parentSignBook.liveWorkflow.currentStep.signType == T(org.esupportail.esupsignature.entity.enums.SignType).certSign || signRequest.parentSignBook.liveWorkflow.currentStep.signType == T(org.esupportail.esupsignature.entity.enums.SignType).nexuSign) && signatureIds.size() > 0}">
                    Attention ce document comporte <span th:text="${signatureIds.size()}"></span> signature(s) électronique(s). Le fait d’apposer une signature calligraphique ou un visa visuel aura pour effet de détruire les précédentes signatures
                </div>
                <div id="visaFormConfirm" th:if="${signType == T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">
                    <div class="alert alert-primary">
                        <p th:utext="'<p>Le visa vous permet de valider le document et de le passer à l’étape suivante.</p><p>L’opération sera enregistrée mais aucune trace n’apparaitra sur le document.</p>'"></p>
                    </div>
                </div>
                <div id="signFormConfirm" th:unless="${signType == T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">
                    <div class="alert alert-primary">
                        <p th:utext="'Le niveau de signature minimum demandé pour signer ce document est : <br><center><b>' + #{'signbook.signtype.' + ${signType}} + '</b></center>'"></p>
                    </div>
                </div>
                <div id="noOptions" class="alert alert-danger mt-1" style="display: none;">
                    Votre profil ne possède pas les prérequis nécessaires pour signer cette demande. Si vous en avez la possibilité, merci de contrôler vos paramètres de signature, d’importer un certificat ou de démarrer NexU.
                    <br>
                    Sinon merci de contacter la personne ou le service émetteur de cette demande de signature.
                </div>
                <div id="noSeal" th:if="${!sealCertOK}" class="alert alert-danger mt-1" style="display: none;">
                    La signature par certificat cachet d’établissement est temporairement indisponible pour des raisons de maintenance. Merci refaire un essai ultérieurement.
                </div>
                <div id="selectTypeDiv" class="alert alert-success mt-1" th:if="${signType != T(org.esupportail.esupsignature.entity.enums.SignType).visa && signType != T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">
                    <label for="certType">Merci de sélectionner le type de signature que vous souhaitez utiliser parmi les types disponibles</label>
                    <select id="certType" name="certType" class="form-select mt-2" required>
                        <th:block th:each="signWith : ${signWiths}">
                            <th:block th:if="${signWith.name != 'sealCert'}">
                                <option th:value="${signWith}" th:text="#{'signwith.' + ${signWith}}"></option>
                            </th:block>
                            <th:block th:if="${signWith.name == 'sealCert'}">
                                <option th:if="${sealCertOK}" th:value="${signWith}" th:text="#{'signwith.' + ${signWith}}"></option>
                                <option th:unless="${sealCertOK}" value="" th:text="#{'signwith.' + ${signWith}}" disabled></option>
                            </th:block>
                        </th:block>
                    </select>
                    <input class="form-control mt-2 mb-1" type="password" id="password" name="password" value="" placeholder="Mot de passe du keystore" />
                </div>
                <div id="signCommentDiv">
                    <label for="signComment">Commentaire (facultatif)</label>
                    <textarea id="signComment" placeholder="Votre commentaire sera visible de tous les participants."  onfocus="this.placeholder = ''" class="form-control" name="comment"></textarea>
                </div>
                <div id="nexuCheck" th:classappend="${signType != T(org.esupportail.esupsignature.entity.enums.SignType).nexuSign ? 'd-none' : ''}">
                    <div id="nexu_version_alert" style="display: none;text-align: center;">
                        <div class="alert alert-warning float-start">
                            L'application NexU n’a pas la bonne version : NexU <span th:text="${globalProperties.nexuVersion} + 'est nécessaire'"></span>
                            <br>
                            <button onclick="location.reload();" class="mt-2 mx-auto btn btn-warning">
                                <i class="fas fa-sync-alt fa-2x"></i><br> Cliquez ici après le lancement de NexU
                            </button>
                        </div>
                    </div>
                    <div id="nexu_missing_alert" class="mt-1" style="display: none;">
                        <div class="alert alert-warning text-center">
                            <p class="text-left">L'application NexU n'a pas été détectée</p>
                            <p  class="text-left">Si vous souhaitez signer à l'aide d'un certificat présent sur votre poste ou sur clé USB, merci de lancer l’application NexU sur votre poste puis d'actualiser la page.<br/>
                                Pour plus d'informations sur l'utilisation de NexU merci de consulter la documentation à cette adresse :
                                <a target="_blank" href="https://www.esup-portail.org/wiki/display/SIGN/Application+NexU">https://www.esup-portail.org/wiki/display/SIGN/Application+NexU</a>
                            </p>
                            <button onclick="location.reload();" class="mt-2 mx-auto btn btn-warning align-self-center">
                                <i class="fas fa-sync-alt fa-2x"></i><br> Cliquez ici après le lancement de NexU
                            </button>
                        </div>
                    </div>
                    <div id="nexu_ready_alert" style="display: none;">
                        <div class="alert alert-success mt-1 mb-1 col-12">
                            L’application NexU est fonctionnelle
                            <br/>
                            <small>Vous allez être redirigé vers le système NexU qui permet d’utiliser une clé matérielle</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button id="checkValidateSignButtonEnd" th:if="${signBook.signRequests.size() == 1 || nextSignBook == null}"
                        class="btn btn-success me-1" title="Signer" th:value="${signRequest.id}" autofocus>
                    <span th:unless="${signType == T(org.esupportail.esupsignature.entity.enums.SignType).visa || signType == T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">Signer</span>
                    <span th:if="${signType == T(org.esupportail.esupsignature.entity.enums.SignType).visa || signType == T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">Viser</span>
                </button>
                <button id="checkValidateSignButtonNext" th:if="${nextSignBook != null && otp == null}"
                        class="btn btn-success" title="Signer" th:value="${signRequest.id}" autofocus>
                    <span th:unless="${signType == T(org.esupportail.esupsignature.entity.enums.SignType).visa || signType == T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">Signer et aller à la suivante </span>
                    <span th:if="${signType == T(org.esupportail.esupsignature.entity.enums.SignType).visa || signType == T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">Viser et aller à la suivante </span>
                    <i class="fas fa-arrow-alt-circle-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div th:if="${signable}" data-bs-focus="false" class="modal fade" id="signAllModal"  role="dialog"
     aria-labelledby="signModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="signAllModalLabel">Confirmer la signature des documents</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input autocomplete="new-password"
                       th:classappend="${signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).certSign && currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).nexuSign} ? 'd-none'"
                       class="form-control" type="password" id="passwordAll" name="passwordAll" value=""
                       placeholder="Mot de passe du keystore"/>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary col-12" data-bs-dismiss="modal">Annuler</button>
                <button id="checkValidateSignButton" class="mb-1 col-12 btn btn-success" title="Signer"
                        th:value="${signRequest.parentSignBook.id}">
                    <span th:if="${signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).visa && signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa && signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">
                        <i class="fas fa-signature"></i> Signer
                    </span>
                    <span th:if="${signRequest.currentSignType == T(org.esupportail.esupsignature.entity.enums.SignType).visa || signRequest.currentSignType == T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">
                    <i class="fas fa-check"></i> Viser
                        </span>
                </button>
            </div>
        </div>
    </div>
</div>

<div th:if="${signRequest.parentSignBook.liveWorkflow.currentStep != null && signRequest.parentSignBook.liveWorkflow.currentStep.repeatable != null && signRequest.parentSignBook.liveWorkflow.currentStep.repeatable}" data-bs-focus="false" class="modal fade" id="stepRepeatableModal"  role="dialog"
     aria-labelledby="signModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="stepRepeatableModalLabel">Étape supplémentaire ?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input th:classappend="${signRequest.parentSignBook.liveWorkflow.currentStep.signType != T(org.esupportail.esupsignature.entity.enums.SignType).certSign || user.keystore == null} ? 'd-none'"
                       class="form-control mt-2 mb-1" type="password" id="passwordInfinite" name="password" value=""
                       placeholder="Mot de passe du keystore" />
                <p>
                    Vous avez la possibilité de demander une validation intermédiaire avant l’étape suivante.
                </p>
                <p>
                    Sans modification de votre part,
                    <span th:if="${signRequest.parentSignBook.liveWorkflow.liveWorkflowSteps.size() == signRequest.parentSignBook.liveWorkflow.getCurrentStepNumber()}">
                        vous resterez le dernier destinataire de ce document
                    </span>
                    <span th:unless="${signRequest.parentSignBook.liveWorkflow.liveWorkflowSteps.size() == signRequest.parentSignBook.liveWorkflow.getCurrentStepNumber()}">
                        le document sera envoyé pour l'étape :
                        <span th:if="${signRequest.parentSignBook.liveWorkflow.liveWorkflowSteps.get(signRequest.parentSignBook.liveWorkflow.getCurrentStepNumber()).workflowStep != null}"
                              th:text="${signRequest.parentSignBook.liveWorkflow.liveWorkflowSteps.get(signRequest.parentSignBook.liveWorkflow.getCurrentStepNumber()).workflowStep.description}">

                        </span>
                        <span th:unless="${signRequest.parentSignBook.liveWorkflow.liveWorkflowSteps.get(signRequest.parentSignBook.liveWorkflow.getCurrentStepNumber()).workflowStep != null}"
                              th:text="${signRequest.parentSignBook.liveWorkflow.getCurrentStepNumber() + 1}">
                        </span>
                        .
                    </span>
                </p>
                <button id="enableInfinite" class="mb-1 col-12 btn btn-primary" title="Signer" th:value="${signRequest.parentSignBook.id}">
                    <th:block th:if="${signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).visa && signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa && signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">
                        <i class="fas fa-caret-down"></i> Signer le document puis ajouter une étape <i class="fas fa-caret-down"></i>
                    </th:block>
                    <th:block th:if="${signRequest.currentSignType == T(org.esupportail.esupsignature.entity.enums.SignType).visa || signRequest.currentSignType == T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">
                        <i class="fas fa-caret-down"></i> Signer le document puis ajouter une étape <i class="fas fa-caret-down"></i>
                    </th:block>
                </button>
                <form id="infiniteForm" class="d-none">
                    <input type="submit" id="infiniteFormSubmit" class="d-none">
                    <label for="recipientsEmailsInfinite">Choisir les participants</label>
                    <div class="form-group mb-3">
                        <select class="select-users" data-check="true" name="recipientsEmails" id="recipientsEmailsInfinite" multiple="multiple" required="required">
                            <option data-placeholder="true"></option>
                        </select>
                    </div>
                    <div class="form-group mb-3" id="allSignToComplete-infinite">
                        <label for="allSignToCompleteInfinite">
                            Tous les participants doivent-ils signer ?
                        </label>
                        <label class="switch">
                            <input type="checkbox" class="form-check-input" name="allSignToComplete" id="allSignToCompleteInfinite"/>
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="form-group mb-3" id="multi-sign">
                        <label for="multiSign">
                            L'utilisateur peut apposer plusieurs signatures ?
                        </label>
                        <label class="switch">
                            <input type="checkbox" class="form-check-input" name="multiSign" id="multiSign"/>
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="form-group mb-3" th:if="${signRequest.parentSignBook.liveWorkflow.currentStep.repeatableSignType == null}">
                        <label for="signTypeInfinite">Choisir un type de signature</label>
                        <select name="signType" id="signTypeInfinite" class="form-select">
                            <th:block th:each="signType : ${signTypes}">
                                <option th:value="${signType}"
                                        th:text="#{'signbook.signtype.' + ${signType}}" th:selected="${signType == 'pdfImageStamp'}"></option>
                            </th:block>
                        </select>
                    </div>
                    <input th:if="${signRequest.parentSignBook.liveWorkflow.currentStep.repeatableSignType != null}" type="hidden" id="signTypeInfinite" name="signType" th:value="${signRequest.parentSignBook.liveWorkflow.currentStep.repeatableSignType}">
                    <div class="form-group mb-3">
                        <textarea id="signCommentInfinite" class="form-control" name="comment" placeholder="Vous pouvez saisir un commentaire ici. Celui-ci sera visible de tous les participants."></textarea>
                    </div>
                    <button type="button" id="launchInfiniteSignButton" class="mb-1 col-12 btn btn-success" title="Signer" th:value="${signRequest.parentSignBook.id}">
                    <span th:if="${signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).visa && signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa && signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">
                        <i class="fas fa-signature"></i> Confirmer la signature et l'ajout de l'étape
                    </span>
                    <span th:if="${signRequest.currentSignType == T(org.esupportail.esupsignature.entity.enums.SignType).visa || signRequest.currentSignType == T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">
                        <i class="fas fa-check"></i> Confirmer le visa et l'ajout de l'étape
                    </span>
                    </button>
                </form>
                <textarea id="signCommentNoInfinite" placeholder="Vous pouvez saisir un commentaire ici. Celui-ci sera visible de tous les participants."  onfocus="this.placeholder = ''" class="form-control mt-1" name="comment"></textarea>
                <button id="launchNoInfiniteSignButton" class="mt-1 col-12 btn btn-success" title="Signer"
                        th:value="${signRequest.parentSignBook.id}">
                    <span th:if="${signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).visa && signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa && signRequest.currentSignType != T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">
                        <i class="fas fa-signature"></i> Signer le document sans ajout d'étape
                    </span>
                    <span th:if="${signRequest.currentSignType == T(org.esupportail.esupsignature.entity.enums.SignType).visa || signRequest.currentSignType == T(org.esupportail.esupsignature.entity.enums.SignType).hiddenVisa}">
                        <i class="fas fa-check"></i> Viser le document sans ajout d'étape
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<div th:if="${signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).draft}"
     data-bs-focus="false" class="modal fade" id="sendModal"  role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 th:if="${signRequest.parentSignBook.liveWorkflow.liveWorkflowSteps.size() > 0}" class="modal-title">Démarrer le circuit</h3>
                <h3 th:unless="${signRequest.parentSignBook.liveWorkflow.liveWorkflowSteps.size() > 0}" class="modal-title">Valider le document</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close">

                </button>
            </div>
            <form th:action="'/user/signrequests/pending/' + ${signRequest.id}" method="post">
                <div class="modal-body">
                    <th:block th:unless="${steps.size() > 0}">
                        <p th:unless="${signRequest.parentSignBook.liveWorkflow.liveWorkflowSteps.size() > 0}">
                            Après la validation, vous pourrez télécharger le document
                        </p>
                    </th:block>
                    <div th:if="${steps.size() > 0 || signRequest.parentSignBook.liveWorkflow.liveWorkflowSteps.size() > 0}">
                        <th:block th:if="${signRequest.parentSignBook.liveWorkflow.workflow != null && signRequest.parentSignBook.liveWorkflow.liveWorkflowSteps.size() == 0}">
                            <h5>
                                Le circuit comporte <span
                                    th:text="${signRequest.parentSignBook.liveWorkflow.workflow.workflowSteps.size()}"></span>
                                étape<span
                                    th:if="${signRequest.parentSignBook.liveWorkflow.workflow.workflowSteps.size() > 1}">s</span>
                            </h5>
                            <br>
                            <ul class="list-group">
                            <th:block th:each="step, iterator : ${steps}">
                                <li class="list-group-item">
                                <!--                            <div class="form-group mb-3">-->
                                <!--                                <span th:text="'Etape ' + ${iterator.index + 1} + ' : ' + ${liveWorkflowStep.description}"></span>-->
                                <!--                            </div>-->
                                <div th:if="${step.changeable == true}" class="form-group mb-1">
                                    <span th:text="'Etape ' + ${iterator.index + 1} + ' : '"></span><span
                                        th:text="${step.description != null ?  step.description : ''}"></span>
                                </div>
                                <div th:unless="${step.changeable == true}" class="form-group d-inline mb-1">
                                    <span th:text="'Etape ' + ${iterator.index + 1} + ' : '"></span><span
                                        th:text="${step.description != null ?  step.description + ' (' : ''}"></span>
                                    <th:block th:if="${step.users.size() > 0}" th:each="user, iterator : ${step.users}">
                                        <span th:if="${iterator.index > 0}"> ou </span>
                                        <span th:text="${user.firstname} + ' ' + ${user.name}"></span>
                                    </th:block>
                                    <span th:text="${step.description != null ?  ')' : ''}"></span>
                                </div>
                                <div th:if="${step.changeable == true}" class="form-group mb-1">
                                    <label><span th:text="'Merci de saisir le(s) participant(s) pour l\'étape ' + ${iterator.index + 1}"></span></label>
                                    <select class="select-users"
                                            th:data-signrequest-id="${signRequest.id}"
                                            th:id="'recipientEmailsSelect_' + ${iterator.index + 1}"
                                            multiple="multiple" name="recipientEmails" required="required">
                                        <option data-placeholder="true"></option>
                                        <th:block th:each="user : ${step.users}">
                                            <option th:if="${user.email != null}" selected="selected"
                                                    th:text="${user.email}"
                                                    th:value="${iterator.index + 1} + '*' + ${user.email}"></option>
                                        </th:block>
                                    </select>
                                    <p class="small">
                                        Les signataires sont pré-sélectionnés en fonction de vos précédentes saisies.
                                    </p>
                                </div>
                                <div th:id="'tempUsers-recipientEmailsSelect_' + ${iterator.index + 1}"></div>
                                </li>
                            </th:block>
                            </ul>
                        </th:block>
                        <th:block th:unless="${signRequest.parentSignBook.liveWorkflow.workflow != null}">
                            <p>
                                La procédure comporte une étape
                            </p>
                            <th:block th:each="liveWorkflowStep,iterator : ${signRequest.parentSignBook.liveWorkflow.liveWorkflowSteps}">
                                <!--                            <div class="form-group mb-3">-->
                                <!--                                <span th:text="'Etape ' + ${iterator.index + 1} + ' : ' + ${liveWorkflowStep.description}"></span>-->
                                <!--                            </div>-->
                                <p>
                                    <span th:text="'Etape ' + ${iterator.index + 1} + ' : '"></span>
                                    <th:block th:if="${liveWorkflowStep.recipients.size() > 0}" th:each="recipient, iterator : ${liveWorkflowStep.recipients}">
                                        <span th:if="${iterator.index > 0}"> ou </span>
                                        <span th:text="${recipient.user.firstname} + ' ' + ${recipient.user.name}"></span>
                                    </th:block>
                                </p>
                            </th:block>
                        </th:block>
                        <th:block th:if="${isTempUsers}">
                            <hr>
                            <p>Certains destinataires sont externes à l'établissement, merci de saisir/vérifier les informations complémentaires si besoin</p>
                            <th:block th:each="liveWorkflowStep : ${signRequest.parentSignBook.liveWorkflow.liveWorkflowSteps}">
                                <th:block th:each="recipient : ${liveWorkflowStep.recipients}">
                                    <div th:if="${recipient.user.userType.name() == 'external'}">
                                        <b>Destinataire : <span th:text="${recipient.user.email}"></span></b>
                                        <div class="form-inline">
                                            <input id="emails" type="hidden" name="emails" th:value="${recipient.user.email}">
                                            <label for="names">Nom</label>
                                            <input id="names" class="form-control me-2" type="text" name="names" th:value="${recipient.user.firstname != 'Nouvel utilisateur'} ? ${recipient.user.name} : ''" required>
                                            <label for="firstnames">Prénom</label>
                                            <input id="firstnames" class="form-control me-2" type="text" name="firstnames" th:value="${recipient.user.firstname != 'Nouvel utilisateur'} ? ${recipient.user.firstname} : ''" required>
                                            <label for="phones">Mobile</label>
                                            <input id="phones" class="form-control  me-2" type="text" name="phones" value="" th:required="${globalProperties.smsRequired}">
                                        </div>
                                    </div>
                                </th:block>
                            </th:block>
                            <th:block th:if="${signRequest.parentSignBook.liveWorkflow.liveWorkflowSteps.size() == 0}" th:each="workflowStep : ${steps}">
                                <th:block th:each="user : ${workflowStep.users}">
                                    <div th:if="${user.userType.name() == 'external'}">
                                        <b>Destinataire : <span th:text="${user.email}"></span></b>
                                        <div class="form-inline">
                                            <input id="emails" type="hidden" name="emails" th:value="${user.email}">
                                            <label for="names">Nom</label>
                                            <input id="names" class="form-control me-2" type="text" name="names" th:value="${user.name}" required>
                                            <label for="firstnames">Prénom</label>
                                            <input id="firstnames" class="form-control me-2" type="text" name="firstnames" th:value="${user.firstname}" required>
                                            <label for="phones">Mobile</label>
                                            <input id="phones" class="form-control  me-2" type="text" name="phones" th:value="${user.eppn}" th:required="${globalProperties.smsRequired}">
                                        </div>
                                    </div>
                                </th:block>
                            </th:block>
                        </th:block>
                        <th:block th:each="target : ${signRequest.parentSignBook.liveWorkflow.targets}">
                        <div th:if="${target.targetUri.contains('mailto:')}" class="form-group mb-3">
                            <label>Etape finale : Envoi par mail à </label>
                            <select class="select-users" id="targetEmailsSelect" multiple="multiple" name="targetEmails" required>
                                <th:block th:each="targetEmail : ${target.targetUri.replace('mailto:', '').split(',')}">
                                    <option selected="selected" th:if="${targetEmail != ''}" th:text="${targetEmail}" th:value="${targetEmail}"></option>
                                </th:block>
                            </select>
                        </div>
                        </th:block>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary float-start" data-bs-dismiss="modal">Annuler</button>
                    <input type="hidden" name="draft" value="false">
                    <button type="submit" class="btn btn-success">Valider</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div th:if="${@preAuthorizeService.signRequestOwner(signRequest.id, authUserEppn)}"
     data-bs-focus="false" class="modal modal-warning fade in" th:id="'modal-warning-' + ${signRequest.id}">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="command" th:action="'/user/signbooks/'+ ${signRequest.parentSignBook.id}" th:method="delete">
                <div class="modal-header">
                    <h2>Attention</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">

                    </button>
                </div>
                <div class="modal-body">
                    <div th:unless="${signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).deleted}" class="alert alert-danger">Confirmez-vous la suppression de cette demande ?</div>
                    <div th:if="${signRequest.status == T(org.esupportail.esupsignature.entity.enums.SignRequestStatus).deleted}" class="alert alert-danger">Confirmez-vous la suppression définitivement de cette demande ?</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary float-start" data-bs-dismiss="modal">Non</button>
                    <button type="submit" class="btn btn-danger">Oui</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div data-bs-focus="false" class="modal fade" id="refuseModal"  role="dialog" aria-labelledby="refuseModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form th:action="'/'+${user.userType.name() == 'external' ? 'otp' : 'user'}+'/signrequests/refuse/' + ${signRequest.id}" method="post">
                <div class="modal-header">
                    <h3 class="modal-title" id="refuseModalLabel">Refuser la demande de signature</h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <textarea placeholder="Vous devez ajouter un commentaire" class="form-control" name="comment" required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <div th:unless="${signType == T(org.esupportail.esupsignature.entity.enums.SignType).nexuSign}">
                        <button type="submit" id="refuseEnd" name="redirect" value="end" th:if="${signBook.signRequests.size() == 1 || nextSignBook == null}"
                                class="btn btn-danger me-1" title="Refuser" autofocus>
                            <span>Refuser</span>
                        </button>
                        <button type="submit" id="refuseNext" th:if="${nextSignBook != null && otp == null}" name="redirect" th:value="${nextSignRequest.id}"
                                class="btn btn-danger" title="Refuser et aller à la suivante" autofocus>
                            <span>Refuser et aller à la suivante </span>
                            <i class="fas fa-arrow-alt-circle-right"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div data-bs-focus="false" class="modal fade" id="detailsModal"  role="dialog" aria-labelledby="detailsModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="detailsModalLabel">Details de la demande</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div th:replace="user/signrequests/includes/details :: details"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<div data-bs-focus="false" class="modal fade" id="forwardModal"  role="dialog" aria-labelledby="forwardModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="forwardModalLabel">Réaffecter la demande</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-3">
                    <p>Vous allez réaffecter la demande à une autre personne que vous.</p>
                    <form id="send-sign-form" method="post" th:action="'/user/signrequests/transfert/'">
                    <label class="form-label" for="transfertRecipientsEmails">Choisir la personne qui vous remplacera dans cette demande</label>
                    <select class="select-users" name="transfertRecipientsEmails" id="transfertRecipientsEmails" size="1" multiple="multiple" required="required">
                        <option data-placeholder="true"></option>
                    </select>
                    <div class="mt-2 mb-2" id="tempUsers-recipientsEmails"></div>
                    <button type="submit" class="btn btn-success float-end">Valider</button>
                    <button type="button" class="btn btn-secondary float-end me-1" data-bs-dismiss="modal">Fermer</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div data-bs-focus="false" class="modal fade" id="addViewersModal"  role="dialog" aria-labelledby="forwardModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="addViewersLabel">Ajouter des observateurs</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-3">
                    <p>Vous allez réaffecter la demande à une autre personne que vous.</p>
                    <form id="add-viewers-form" th:method="post" th:action="'/user/signbooks/add-viewers/' + ${signBook.id}">
                    <label class="form-label" for="transfertRecipientsEmails">Choisir la personne qui vous remplacera dans cette demande</label>
                    <select class="select-users mb-4" name="viewers" id="viewers" size="1" multiple="multiple" required="required">
                        <option data-placeholder="true"></option>
                    </select>
                    <button type="submit" class="btn btn-success float-end">Valider</button>
                    <button type="button" class="btn btn-secondary float-end me-1" data-bs-dismiss="modal">Fermer</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


<div data-bs-focus="false" class="modal fade" id="addCommentModal"  role="dialog" aria-labelledby="detailsModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form th:action="'/user/signrequests/comment/' + ${signRequest.id}" method="post">
                <div class="modal-header">
                    <h3 class="modal-title" id="addCommentLabel">Ajouter un post-it</h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <textarea name="comment" class="form-control" rows="3" style="background-color: #FFF740;"></textarea>
                    <input type="hidden" name="postit" value="on" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="submit" class="btn btn-success">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div th:replace="user/signrequests/includes/modals/attachment :: attachment"></div>
<div id="add-sign-image" class="modal" >
    <div class="modal-dialog modal-lg">
        <form id="userParamsForm" th:object="${authUser}" th:action="'/' + ${user.userType.name() == 'external' ? 'otp' : 'user'} + '/users?' + ${_csrf.parameterName} + '=' + ${_csrf.token}" enctype="multipart/form-data" method="post">
        <input type="hidden" name="id" th:value="${authUser.id}"/>
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajout d'une image de signature</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class="alert alert-warning">
                        Vous n'avez pas encore d'image de signature dans votre profil. Merci de retenter l'opération après l'enregistrement de votre image.
                    </div>
                    <label class="col-form-label">
                        <strong>Vous pouvez choisir une image provenant de votre ordinateur</strong>
                        <button data-bs-target="#collapseHelpSignImage" data-bs-toggle="collapse"
                                type="button"
                                class="btn btn-sm btn-transparent">
                            <i class="fas fa-info-circle text-info"></i>
                        </button>
                        <div class="collapse" id="collapseHelpSignImage">
                            <div class="alert alert-info">
                                <small> Après avoir sélectionné une image, vous pourrez ajuster sa
                                    taille pour
                                    que la signature entre dans le carré blanc. Si votre signature
                                    est grande
                                    (contient un tampon par exemple), il est possible
                                    d’élargir
                                    le carré blanc (la signature prendra plus de place sur le
                                    document) <br/>
                                    Une image de la signature sera toujours nécessaire pour signer
                                    un PDF
                                </small>
                            </div>
                        </div>
                    </label>
                    <div class="mx-auto mb-1" style="width: 600px;">
                        <input type="file" class="form-control" id="vanilla-upload" value="Choose a file" accept="image/*" aria-describedby="inputGroupFileAddon01"/>
                        <label class="custom-file-label" for="vanilla-upload">
                            Choisissez une nouvelle image
                        </label>
                    </div>
                    <br/>
                    <label id="signPadLabel" class="col-form-label"><strong>Vous pouvez dessiner une signature dans le rectangle ci dessous</strong></label>
                    <div id="signPad">
                        <canvas id="canvas" style="border: 1px solid black;"></canvas>
                        <button id="validate" type="button" class="btn btn-light btn-outline-dark d-none">
                            Valider la signature
                        </button>
                        <button id="erase" type="button" class="btn btn-light btn-outline-dark float-left">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button id="reset" type="button" class="btn btn-light btn-outline-dark d-none">
                            Réinitialiser
                        </button>
                        <div>
                        </div>
                    </div>
                    <div id="signCrop" class="mx-auto">
                        <div id="crop-div" class="alert alert-light text-dark text-center" style="display: none;">
                            <div class="d-flex justify-content-center">
                                <button type="button" id="zoomout"
                                        class="btn btn-light btn-outline-dark ms-1 d-none d-lg-block">
                                    <i
                                            class="fas fa-search-minus"></i></button>
                                <button type="button" id="zoomin"
                                        class="btn btn-light btn-outline-dark ms-1 d-none d-lg-block">
                                    <i
                                            class="fas fa-search-plus"></i></button>
                                <button type="button"
                                        class="btn btn-light btn-outline-dark ms-1 d-none d-lg-block vanilla-rotate"
                                        data-deg="90"><i class="fas fa-undo"></i></button>
                                <button type="button"
                                        class="btn btn-light btn-outline-dark ms-1 d-none d-lg-block vanilla-rotate"
                                        data-deg="-90"><i class="fas fa-redo"></i></button>
                            </div>
                            <div id="vanilla-crop" class="mt-2"></div>
                        </div>
                    </div>
                    <input type="hidden" id="signImageBase64" name="signImageBase64" value="">
                </div>
            </div>
            <div class="modal-footer">
                <a id="saveButton"
                   class="btn btn-success">
                    <i class="fas fa-save"></i> Enregistrer la signature
                </a>
            </div>
        </div>
        </form>
    </div>
</div>
<footer th:replace="fragments/footer :: footer"></footer>
<script th:inline="javascript" type="module">
    import {Nexu} from '/js/modules/ui/signrequests/Nexu.js?version=[[${versionApp}]]';
    import {SignUi} from '/js/modules/ui/signrequests/SignUi.js?version=[[${versionApp}]]';
    import {SignRequestHelp} from '/js/modules/help/SignRequestHelp.js?version=[[${versionApp}]]';
    let help = new SignRequestHelp([[${myUiParams.get(T(org.esupportail.esupsignature.entity.enums.UiParams).signRequestHelp)}]], [[${user.userType.name() == 'external' ? 'otp' : 'user'}]]);
    help.autoStart();
    let signable = [[${signable}]];
    let editable = [[${editable}]];
    let currentSignType = [[${signRequest.currentSignType}]];
    sessionStorage.setItem("favoriteSignRequestParams", [[${favoriteSignRequestParamsJson}]]);
    new SignUi(
        [[${signRequest.id}]],
        [# th:if="${signRequest.data != null}"]
            [[${signRequest.data.id}]],
        [/]
        [# th:unless="${signRequest.data != null}"]
            null,
        [/]
        [# th:if="${signRequest.data != null && signRequest.data.form != null}"]
            [[${signRequest.data.form.id}]],
        [/]
        [# th:unless="${signRequest.data != null && signRequest.data.form != null}"]
            null,
        [/]
        [[${toUseSignRequestParams}]],
        [[${user.defaultSignImageNumber}]],
        currentSignType,
        signable,
        editable,
        [[${signRequest.comments}]],
        [[${toSignDocument != null && toSignDocument.contentType == 'application/pdf'}]],
        [[${currentStepNumber}]],
        [[${currentStepMultiSign}]],
        [# th:if="${signRequest.parentSignBook.liveWorkflow.currentStep != null}"]
            [[${workflow != null}]],
        [/]
        [# th:if="${signRequest.parentSignBook.liveWorkflow.currentStep == null}"]
            null,
        [/]
        [[${signImages}]],
        [[${user.firstname + ' ' + user.name}]],
        [[${authUser.firstname + ' ' + authUser.name}]],
        [[${_csrf}]],
        [[${fields}]],
        [# th:if="${signRequest.parentSignBook.liveWorkflow.currentStep != null}"]
            [[${signRequest.parentSignBook.liveWorkflow.currentStep.repeatable}]],
        [/]
        [# th:if="${signRequest.parentSignBook.liveWorkflow.currentStep == null}"]
            null,
        [/]
        [[${signRequest.status}]],
        [[${action}]],
        [[${signRequest.parentSignBook.signRequests.size()}]],
        [[${isNotSigned}]],
        [[${attachmentAlert}]],
        [[${attachmentRequire}]],
        [[${#authorization.expression('hasRole(''ROLE_OTP'')')}]],
        [[${user.favoriteSignRequestParams == null} ? true : false]],
        [[${user.phone}]],
        [[${user.returnToHomeAfterSign}]]
    );
    $(document).ready(function () {
        if (signable) {
            new Nexu(null, null, currentSignType);
        }
    });
</script>
</body>
</html>
