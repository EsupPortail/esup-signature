<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head"></head>
<body>
<div class="header-fixed fixed-top">
    <th:block th:if="${referer == 'null'}">
        <nav th:replace="fragments/menu :: menu(activeMenu)"></nav>
        <nav class="nav justify-content-between bg-white" aria-label="breadcrumb">
            <ol class="breadcrumb col-11">
                <li class="breadcrumb-item"><a href="/">Liste des demandes</a></li>
                <li class="breadcrumb-item active" aria-current="page">Demande de signature : <span th:text="${signRequest.name}"></span></li>
            </ol>
            <div class="navbar-nav align-self-center">
                <button data-target="#collapseHelp" data-toggle="collapse" type="button" class="btn btn-info">
					<span class="fas fa-info-circle"> <!--  -->
					</span>
                </button>
            </div>
        </nav>
    </th:block>
    <th:block th:unless="${referer == 'null'}">
        <nav th:replace="fragments/emptyBar :: emptyBar"></nav>
    </th:block>
    <div id="ribbon" class="card" th:if="${signable == 'ok'}">
        <div class="card-body">
            <div th:if="${user.signImage == null && documentType == 'pdf' && signRequest.signRequestParams.signType.name() != 'visa'}">
                <div class="card card-body bg-danger text-white">
                    <a href="/user/users/" class="text-white">Pas d'image de signature</a>
                </div>
            </div>

            <div class="alert alert-secondary mr-2 float-left" style="height: 100px;">
                <label class="switch">
                    <input onclick="toggleZoom();" checked="checked" type="checkbox" name="zoom" id="_zoom"/> <span class="slider round"> <!--  -->
						</span>
                </label>
                <br/>
                <label class="control-label" for="_zoom">Zoom</label>

            </div>

            <div class="alert alert-secondary mr-2 float-left" style="height: 100px;">
                <label class="switch"> <input onclick="activeDate();" type="checkbox" id="_activeDate"/> <span class="slider round"> <!--  -->
					</span>
                </label>
                <br/>
                <label class="control-label" for="_activeDate">Afficher la date</label>
            </div>

            <div th:if="${imagePagesSize > 1}" class="mr-2 alert alert-secondary float-left" style="height: 100px;">
                <ul class="pagination">
                    <li id="previous" class="page-item">
                        <a onclick="previousImage();" class="page-link" aria-label="Précédent">
                            <span aria-hidden="true">‹</span>
                        </a>
                    </li>
                    <li id="next" class="page-item">
                        <a onclick="nextImage();" class="page-link" aria-label="Prochain">
                            <span aria-hidden="true">›</span>
                        </a>
                    </li>
                </ul>
                Navigation
            </div>
            <button class="mr-2 btn btn-success float-left" th:if="${signRequest.signRequestParams.signType.name() == 'certSign'}" type="button" data-toggle="modal" data-target="#signModal" style="height: 100px;">
                <i class="fas fa-signature fa-2x"></i><br/>Valider la signature
            </button>
            <div th:if="${signRequest.signRequestParams.signType.name() == 'nexuSign'}">
                <script type="text/javascript" src="/js/jsSignatureLevel.js"></script>
                <script type="text/javascript" th:replace="user/signrequests/includes/script :: script"></script>
                <div id="nexu_version_alert" style="display: none;">
                    <a onclick="location.reload();" class="mr-2 btn btn-warning btnSeccion float-left">
                        <i class="fas fa-sync-alt fa-2x"></i><br> Actualiser
                    </a>
                    <div class="alert alert-warning float-left">
                        L'application NexU n'a pas la bonne version.
                        <span th:text="${nexuVersion} + 'nécessaire'"></span>
                        <br>
                    </div>
                </div>
                <div id="nexu_missing_alert" style="display: none;">
                    <a onclick="location.reload();" class="mr-2 btn btn-warning btnSeccion float-left">
                        <i class="fas fa-sync-alt fa-2x"></i><br> Actualiser
                    </a>
                    <div class="alert alert-warning float-left">
                        L'application NexU n'a pas été détectée
                        <br>
                        <small>Merci de lancer l'application sur votre poste.
                            <a href="https://github.com/nowina-solutions/nexu/releases/">Téléchargement</a>
                        </small>
                    </div>
                </div>
                <div id="nexu_ready_alert" style="display: none;">
                    <button type="button" onclick="document.getElementById('signForm').submit();" class="mr-2 btn btn-success float-left">
                        <i class="fas fa-signature fa-2x"></i> <br/>
                        Signer
                    </button>
                    <div class="alert alert-success float-left">
                        L'application NexU est fonctionnelle <br/> <small>Vous pouvez utiliser une clé
                        materielle ou un keystore</small>
                    </div>
                </div>
            </div>

            <button class="mr-2 btn btn-success float-left" th:unless="${signRequest.signRequestParams.signType.name() == 'nexuSign' || signRequest.signRequestParams.signType.name() == 'certSign'}" type="button"
                    onclick="document.getElementById('signForm').submit();" style="height: 100px;">
                <i class="fas fa-signature fa-2x"></i><br/>Valider la signature
            </button>

            <button th:if="${referer != null}" type="button" class="btn  btn-danger float-right" value="Retour" th:onclick="@{'location.href=\'' + ${referer} + '\''}">
                <i class="fas fa-times fa-2x"></i><br/>Abandonner
            </button>

            <button th:unless="${referer != null}" type="button" class="btn  btn-danger float-right" value="Retour" onclick="window.history.back()">
                <i class="fas fa-times fa-2x"></i><br/>Abandonner
            </button>
        </div>
    </div>
</div>
<div aria-expanded="true" class="collapse" id="collapseHelp">
    <div class="alert alert-info">Pour modifier la position de la signature, cliquez sur le document. Selon le type de signature, le lancement de l'application NexU ou un mot de passe peut être demandé.</div>
</div>
</div>
<main role="main" class="container-fluid">
    <div th:if="${signable == 'ok'}">
        <form id="signForm" th:action="'/user/signrequests/sign/' + ${signRequest.id}" method="post">
            <input type="hidden" name="signonly" value="true">
            <input id="addDate" type="hidden" name="addDate" value="false">
            <input type="hidden" name="referer" th:value="${referer}">
            <div th:if="${documentType == 'pdf'}">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="">
                            <div id="pointer_div" onmousedown="savePosition();" onmouseout="resetPosition();" onmousemove="pointIt(event);"
                                 th:style="'background-size: ' + ${pdfWidth * 2} + 'px;background-image:url(\'/user/documents/' + ${documentId} + '/getimagepdfpage/' + ${signRequest.signRequestParams.signPageNumber -1} + '\');width:' + ${pdfWidth * 2} + 'px;height:' + ${pdfHeight * 2} + 'px;border:1px solid #CCC;pointer-events: none;'">
                                <th:block th:if="${signable == 'ok' && signRequest.status.name() != 'signed' && signRequest.signRequestParams.newPageType.name() == 'none' && signRequest.signRequestParams.signType.name() != 'visa'}">
                                    <div onclick="dragSignature();" onmouseover="animBorder();" id="cross"
                                         th:style="'background-repeat: no-repeat; background-position: left bottom; background-size: ' + ${signWidth * 2} + 'px;background-image: url(\'data:image/png;base64,' + ${signFile} + '\'); width: ' + ${signWidth * 2} + 'px; height: ' + ${signHeight * 2} + 'px; line-height: ' + ${signHeight * 2} + 'px; text-align: center; left: ' + ${signRequest.signRequestParams.XPos * 2} + 'px;top: ' + ${signRequest.signRequestParams.YPos * 2} + 'px;position:relative;pointer-events: auto;cursor: move;'">
                                        <div id="borders" th:style="'text-align:left;line-height:normal;width: ' + ${signWidth * 2} + 'px; height: ' + ${signHeight * 2} + 'px;'"></div>
                                    </div>
                                </th:block>
                                <th:block th:if="${signable == 'ok' && signRequest.status.name() != 'signed' && signRequest.signRequestParams.newPageType.name() == 'none' && signRequest.signRequestParams.signType.name() == 'visa'}">
                                    <div onclick="dragSignature();" onmouseover="animBorder();" id="cross"
                                         th:style="'background-repeat: no-repeat; background-position: left bottom; background-size: ' + ${signWidth * 2} + 'px;background-image: url(\'/images/sceau.png\'); width: ' + ${signWidth * 2} + 'px; height: ' + ${signHeight * 2} + 'px; line-height: ' + ${signHeight * 2} + 'px; text-align: center; left: ' + ${signRequest.signRequestParams.XPos * 2} + 'px;top: ' + ${signRequest.signRequestParams.YPos * 2} + 'px;position:relative;pointer-events: auto;cursor: move;'">
                                        <div id="borders" th:style="'text-align:left;line-height:normal;width: ' + ${signWidth * 2} + 'px; height: ' + ${signHeight * 2} + 'px;'">
                                            <span style="font-size: 16px;" th:text="'Visé par ' + ${user.firstname} + ' ' + ${user.name}"></span>
                                            <br>
                                        </div>
                                    </div>
                                </th:block>
                            </div>
                        </div>
                    </div>
                    <script th:inline="javascript">
                        /*<![CDATA[*/
                        var zoom = 2;
                        var nbImagePage = [[${imagePagesSize}]];
                        var currentImagePage = [[${signRequest.signRequestParams.signPageNumber}]] - 1;
                        var documentUrl = "/user/documents/[[${documentId}]]/getimagepdfpage/";
                        var signId = [[${signRequest.id}]];
                        /*]]>*/
                    </script>
                </div>
                <div class="d-none">
                    <div class="col-lg-4">
                        Page : <input readonly="readonly" autocomplete="off" class="form-control form-control-sm col-6" th:value="${signRequest.signRequestParams.signPageNumber}" id="signPageNumber" type="text" name="signPageNumber"/>
                    </div>
                    <div class="col-lg-4">
                        X position : <input readonly="readonly" autocomplete="off" class="form-control form-control-sm col-6" th:value="${signRequest.signRequestParams.XPos}" id="xPos" type="text" name="xPos"/>
                    </div>
                    <div class="col-lg-4">
                        Y position : <input readonly="readonly" autocomplete="off" class="form-control form-control-sm col-6" th:value="${signRequest.signRequestParams.YPos}" id="yPos" type="text" name="yPos"/>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <div th:unless="${signable == 'ok'}">
        <div class="alert alert-danger">
            Vous n'avez plus d'ation à effectuer sur cette demande, merci de fermer cette fenetre
            <br/>
            <input class="btn btn-danger text-center d-none" id="signe" title="Signe" type="submit" value="Fermer" onclick="window.close();"/>
        </div>
    </div>

    <div id="signModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <textarea placeholder="Vous pouvez ajouter un commentaire" class="form-control" name="comment" cols="" rows=""></textarea>

                    <div th:switch="${signRequest.signRequestParams.signType.name()}">
                        <div th:case="'certSign'">
                            <div th:if="${keystore != null}">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">Mot de passe</span>
                                    </div>

                                    <input class="form-control" required="required" placeholder="Vous allez signer à l'aide d'un certificat, merci d'entrer le mot de passe" id="password" name="password" type="password"/>
                                    <div class="input-group-append">
                                        <input data-toggle="modal" data-target="#wait" onclick="submitSignRequest();" alt="${signLabel}" class="btn btn-success" id="signe" title="Signe" type="button" value="Signer"/>
                                    </div>
                                </div>
                            </div>
                            <div th:unless="${keystore != null}">
                                <div class="card card-body bg-danger text-white">
                                    <a href="/user/users/" class="text-white">Pas de keystore</a>
                                </div>
                            </div>
                        </div>
                        <div th:case="'nexuSign'">
                            <button type="submit" class="btn btn-success  text-center" data-target="#signatureModal">Signer</button>
                        </div>
                        <div th:case="*">
                            <div th:if="${signRequest.signRequestParams.signType.name() == 'visa'}">
                                <input alt="${visaLabel}" class="btn btn-success  text-center" id="signe" onclick="document.getElementById('signForm').submit();" type="button" value="Viser"/>
                            </div>
                            <div th:unless="${signRequest.signRequestParams.signType.name() == 'visa'}">
                                <div th:if="${user.signImage != null}">
                                    <input alt="${signLabel}" class="btn btn-success  text-center" id="signe" onclick="document.getElementById('signForm').submit();" type="button" value="Signer"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary align-self-center" data-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <div id="wait" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <h5>Signature en cours</h5>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated active" style="width: 100%;" id="bar">
                            <strong> <span id="bar-text"></span>
                            </strong>
                        </div>
                    </div>
                    <div style="display: none;" id="passwordError" class="alert alert-danger" role="alert">
                        Mauvais mot de passe
                    </div>
                    <div style="display: none;" id="signError" class="alert alert-danger" role="alert">
                        Erreur du système de signature
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="closeModal" type="button"
                            class="btn btn-secondary align-self-center" data-dismiss="modal">Fermer
                    </button>
                    <button type="button" class="btn btn-secondary align-self-center" data-dismiss="modal">Fermer</button>
                    <a id="validModal" th:href="${referer}" class="btn btn-success align-self-center">Terminer</a>
                </div>
            </div>
        </div>
    </div>
</main>
<script th:inline="javascript">
    /*<![CDATA[*/
    zoom == 2;

    function toggleZoom() {
        if (zoom == 1) {
            zoom = 2;
        } else {
            zoom = 1;
        }

        document.getElementById("pointer_div").style = "background-size: " + [[${pdfWidth}]] * zoom + "px;background-image:url('/user/documents/[[${documentId}]]/getimagepdfpage/" + currentImagePage + "');width:" + ([[${pdfWidth}]] * zoom) + "px;height: " + ([[${pdfHeight}]] * zoom) + "px;border:1px solid #CCC;";
        document.getElementById("cross").style.backgroundSize = "" + [[${signWidth}]] * zoom + "px";
        document.getElementById("cross").style.width = "" + [[${signWidth}]] * zoom + "px";
        document.getElementById("cross").style.height = "" + [[${signHeight}]] * zoom + "px";
        document.getElementById("cross").style.lineHeight = "" + [[${signHeight}]] * zoom + "px";
        document.getElementById("cross").style.left = "" + document.getElementById("xPos").value * zoom + "px";
        document.getElementById("cross").style.top = "" + document.getElementById("yPos").value * zoom + "px";
        document.getElementById("borders").style.width = "" + [[${signWidth}]] * zoom + "px";
        document.getElementById("borders").style.height = "" + [[${signHeight}]] * zoom + "px";
        var textDate = document.getElementById("textDate");
        if (textDate != null) {
            textDate.style.fontSize = 8 * zoom + "px";
        }
    }

    /*]]>*/
</script>
</body>
</html>
