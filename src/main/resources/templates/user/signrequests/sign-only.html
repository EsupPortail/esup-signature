<!doctype html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head"></head>
<body>
<div class="header-fixed fixed-top">
    <th:block th:if="${referer == 'null'}">
        <nav th:replace="fragments/menu :: menu(activeMenu)"></nav>
        <nav class="nav justify-content-between bg-white" aria-label="breadcrumb">
            <ol class="breadcrumb col-11">
                <li class="breadcrumb-item"><a href="/">Liste des demandes</a></li>
                <li class="breadcrumb-item active" aria-current="page">Demande de signature : <span th:text="${signRequest.name}"></span></li>
            </ol>
            <div class="navbar-nav align-self-center">
                <button data-target="#collapseHelp" data-toggle="collapse" type="button" class="btn btn-info">
					<span class="fas fa-info-circle"> <!--  -->
					</span>
                </button>
            </div>
        </nav>
    </th:block>
    <th:block th:unless="${referer == 'null'}">
        <nav th:replace="fragments/emptyBar :: emptyBar"></nav>
    </th:block>
</div>
<div aria-expanded="true" class="collapse" id="collapseHelp">
    <div class="alert alert-info">Pour modifier la position de la signature, cliquez sur le document. Selon le type de signature, le lancement de l'application NexU ou un mot de passe peut être demandé.</div>
</div>
</div>
<main role="main" class="container-fluid">
    <div class="row bg-white">
        <div class="col-lg-2">
            <div class="nav flex-column nav-pills" style="z-index: 1;" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                <div class="row">
                    <div th:if="${documentType == 'pdf'}">
                        <div th:if="${user.signImage == null && documentType == 'pdf' && signRequest.currentWorkflowStep.signRequestParams.signType.name() != 'visa'}">
                            <div class="card card-body bg-danger text-white">
                                <a href="/user/users/" class="text-white">Pas d'image de signature</a>
                            </div>
                        </div>

                        <div class="alert alert-secondary col-12 col-sm-2 col-lg-12 m-2">
                            <label class="control-label col-7" for="_zoom">Zoom</label>
                            <label class="switch">
                                <input onclick="toggleZoom();" type="checkbox" name="zoom" id="_zoom"/>
                                <span class="slider round"></span>
                            </label>
                        </div>

                        <div class="alert alert-secondary col-12 col-sm-2 col-lg-12 m-2">
                            <label class="control-label col-7" for="_activeDate">Afficher la date</label>
                            <label class="switch"> <input onclick="activeDate();" type="checkbox" id="_activeDate"/>
                                <span class="slider round"></span>
                            </label>
                        </div>

                        <div th:if="${imagePagesSize > 1}" class="alert alert-secondary col-12 col-sm-2 col-lg-12 m-2">
                            <label class="control-label col-12" for="_zoom">Navigation</label>
                            <ul class="pagination float-right">
                                <li class="page-item">
                                    <button id="previous" type="button" onclick="previousImage();" class="btn btn-outline-dark mr-2 disabled" aria-label="Précédent" disabled>
                                        <i class="fas fa-arrow-left"></i>
                                    </button>
                                </li>
                                <li class="page-item">
                                    <button id="next" onclick="nextImage();" class="btn btn-outline-dark mr-2" aria-label="Prochain">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <button class="btn btn-success col-12 col-sm-2 col-lg-12 m-2" th:if="${signRequest.currentWorkflowStep.signRequestParams.signType.name() == 'certSign'}" type="button" data-toggle="modal" data-target="#signModal">
                        <i class="fas fa-signature fa-2x"></i> Valider la signature
                    </button>
                    <div th:if="${signRequest.currentWorkflowStep.signRequestParams.signType.name() == 'nexuSign'}">
                        <script type="text/javascript" src="/js/jsSignatureLevel.js"></script>
                        <script type="text/javascript" th:replace="user/signrequests/includes/script :: script"></script>
                        <div id="nexu_version_alert" style="display: none;">
                            <a onclick="location.reload();" class="mr-2 btn btn-warning btnSeccion float-left">
                                <i class="fas fa-sync-alt fa-2x"></i><br> Actualiser
                            </a>
                            <div class="alert alert-warning float-left">
                                L'application NexU n'a pas la bonne version.
                                <span th:text="${nexuVersion} + 'nécessaire'"></span>
                                <br>
                            </div>
                        </div>
                        <div id="nexu_missing_alert" style="display: none;">
                            <a onclick="location.reload();" class="mr-2 btn btn-warning btnSeccion float-left">
                                <i class="fas fa-sync-alt fa-2x"></i><br> Actualiser
                            </a>
                            <div class="alert alert-warning float-left">
                                L'application NexU n'a pas été détectée
                                <br>
                                <small>Merci de lancer l'application sur votre poste.
                                    <a href="https://github.com/nowina-solutions/nexu/releases/">Téléchargement</a>
                                </small>
                            </div>
                        </div>
                        <div id="nexu_ready_alert" style="display: none;">
                            <button type="button" onclick="document.getElementById('signForm').submit();" class="mr-2 btn btn-success float-left">
                                <i class="fas fa-signature fa-2x"></i> <br/>
                                Signer
                            </button>
                            <div class="alert alert-success float-left">
                                L'application NexU est fonctionnelle <br/> <small>Vous pouvez utiliser une clé
                                materielle ou un keystore</small>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-success col-12 col-sm-2 col-lg-12 m-2" th:unless="${signRequest.currentWorkflowStep.signRequestParams.signType.name() == 'nexuSign' || signRequest.currentWorkflowStep.signRequestParams.signType.name() == 'certSign'}" type="button"
                            onclick="document.getElementById('signForm').submit();">
                        <i class="fas fa-signature fa-2x"></i> Valider la signature
                    </button>

                    <button th:if="${referer != null}" type="button" class="btn btn-danger col-12 col-sm-2 col-lg-12 m-2" value="Retour" th:onclick="@{'location.href=\'' + ${referer} + '\''}">
                        <i class="fas fa-times fa-2x"></i> Abandonner
                    </button>

                    <button th:unless="${referer != null}" type="button" class="btn btn-danger col-12 col-sm-2 col-lg-12 m-2" value="Retour" onclick="window.history.back()">
                        <i class="fas fa-times fa-2x"></i> Abandonner
                    </button>
                </div>
            </div>
        </div>
        <div th:if="${signable == 'ok'}" class="col-lg-10 tab-content" id="v-pills-tabContent">
            <form id="signForm" th:action="'/user/signrequests/sign/' + ${signRequest.id}" method="post">
                <input type="hidden" name="signonly" value="true">
                <input id="addDate" type="hidden" name="addDate" value="false">
                <input type="hidden" name="referer" th:value="${referer}">
                <div th:if="${documentType == 'pdf'}">
                    <div id="pointer_div" onmouseup="savePosition();" ontouchend="savePosition();" ontouchmove="pointIt(event);"  onmousemove="pointIt(event);"
                         th:style="'background-size: ' + ${pdfWidth} + 'px;background-image:url(\'/user/documents/' + ${documentId} + '/getimagepdfpage/' + ${signRequest.currentWorkflowStep.signRequestParams.signPageNumber -1} + '\');width:' + ${pdfWidth} + 'px;height:' + ${pdfHeight} + 'px;border:1px solid #CCC;pointer-events: none;'">
                        <th:block th:if="${signable == 'ok' && signRequest.status.name() != 'signed' && signRequest.currentWorkflowStep.signRequestParams.newPageType.name() == 'none' && signRequest.currentWorkflowStep.signRequestParams.signType.name() != 'visa'}">
                            <div onclick="dragSignature();" id="cross" ontouchstart="this.style.backgroundColor= 'rgba(0, 255, 0, .5)'; dragSignature();" ontouchend="savePosition();" onmousedown="dragSignature();" onmouseup="savePosition();" onmouseover="this.style.backgroundColor= 'rgba(0, 255, 0, .5)';"
                                 onmouseout="this.style.backgroundColor= 'rgba(255, 0, 0, .0)';"
                                 th:style="'background-repeat: no-repeat; background-position: left bottom; background-size: ' + ${signWidth} + 'px;background-image: url(\'data:image/png;base64,' + ${signFile} + '\'); width: ' + ${signWidth} + 'px; height: ' + ${signHeight} + 'px; line-height: ' + ${signHeight} + 'px; text-align: center; left: ' + ${signRequest.currentWorkflowStep.signRequestParams.XPos} + 'px;top: ' + ${signRequest.currentWorkflowStep.signRequestParams.YPos} + 'px;position:relative;pointer-events: auto;cursor: move;'">
                                <div id="borders" class="anim-border" th:style="'text-align:left;line-height:normal;width: ' + ${signWidth} + 'px; height: ' + ${signHeight} + 'px;'"></div>
                            </div>
                        </th:block>
                        <th:block th:if="${signable == 'ok' && signRequest.status.name() != 'signed' && signRequest.currentWorkflowStep.signRequestParams.newPageType.name() == 'none' && signRequest.currentWorkflowStep.signRequestParams.signType.name() == 'visa'}">
                            <div id="cross" onmousedown="dragSignature();" onmouseup="savePosition();" onmouseover="this.style.backgroundColor= 'rgba(0, 255, 0, .5)';" onmouseout="this.style.backgroundColor= 'rgba(255, 0, 0, .0)';"
                                 th:style="'background-repeat: no-repeat; background-position: left bottom; background-size: 100px;background-image: url(\'/images/sceau.png\'); width: 100px; height: 75px; line-height: 75px; text-align: center; left: ' + ${signRequest.currentWorkflowStep.signRequestParams.XPos} + 'px;top: ' + ${signRequest.currentWorkflowStep.signRequestParams.YPos} + 'px;position:relative;pointer-events: auto;cursor: move;'">
                                <div id="borders" class="anim-border"
                                     style="text-align:left;line-height:normal;width: 100px; height: 75px;user-select: none;-moz-user-select: none;-khtml-user-select: none;-webkit-user-select: none;-o-user-select: none;">
                                    <span id="textVisa" style="font-size: 8px;" th:text="'Visé par ' + ${user.firstname} + ' ' + ${user.name}"></span>
                                    <br>
                                </div>
                            </div>
                        </th:block>
                    </div>
                    <div class="d-none">
                        <div class="col-lg-4">
                            Page : <input readonly="readonly" autocomplete="off" class="form-control form-control-sm col-6" th:value="${signRequest.currentWorkflowStep.signRequestParams.signPageNumber}" id="signPageNumber" type="text" name="signPageNumber"/>
                        </div>
                        <div class="col-lg-4">
                            X position : <input readonly="readonly" autocomplete="off" class="form-control form-control-sm col-6" th:value="${signRequest.currentWorkflowStep.signRequestParams.XPos}" id="xPos" type="text" name="xPos"/>
                        </div>
                        <div class="col-lg-4">
                            Y position : <input readonly="readonly" autocomplete="off" class="form-control form-control-sm col-6" th:value="${signRequest.currentWorkflowStep.signRequestParams.YPos}" id="yPos" type="text" name="yPos"/>
                        </div>
                    </div>
                </div>
                <div th:unless="${documentType == 'pdf'}">
                    <div class="alert alert-warning" role="alert">
                        <h4 class="alert-heading">Signature d'un document autre que PDF</h4>
                        <p>Vous allez signer un document qui n'est pas un PDF. Dans ce cas la signature visuelle n'est pas possible/</p>
                        <hr>
                        <p class="mb-0">Si vous signez à m'aide d'un certificat, le fichier sera encapsulé dans un zip au format ASIC-E</p>
                    </div>
                </div>

            </form>
            <script th:inline="javascript">
                /*<![CDATA[*/
                var zoom = 1;
                var nbImagePage = [[${imagePagesSize}]];
                var currentImagePage = [[${signRequest.currentWorkflowStep.signRequestParams.signPageNumber}]] - 1;
                var documentUrl = "/user/documents/[[${documentId}]]/getimagepdfpage/";
                var signId = [[${signRequest.id}]];
                /*]]>*/
            </script>
        </div>
        <div th:unless="${signable == 'ok'}">
            <div class="alert alert-danger">
                Vous n'avez plus d'ation à effectuer sur cette demande, merci de fermer cette fenetre
                <br/>
                <input class="btn btn-danger text-center d-none" id="signe" title="Signe" type="submit" value="Fermer" onclick="window.close();"/>
            </div>
        </div>

        <div id="signModal" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-body text-center">
                        <textarea placeholder="Vous pouvez ajouter un commentaire" class="form-control" name="comment" cols="" rows=""></textarea>

                        <div th:switch="${signRequest.currentWorkflowStep.signRequestParams.signType.name()}">
                            <div th:case="'certSign'">
                                <div th:if="${keystore != null}">
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">Mot de passe</span>
                                        </div>

                                        <input class="form-control" required="required" placeholder="Vous allez signer à l'aide d'un certificat, merci d'entrer le mot de passe" id="password" name="password" type="password"/>
                                        <div class="input-group-append">
                                            <input data-toggle="modal" data-target="#wait" onclick="submitSignRequest();" alt="${signLabel}" class="btn btn-success" id="signe" title="Signe" type="button" value="Signer"/>
                                        </div>
                                    </div>
                                </div>
                                <div th:unless="${keystore != null}">
                                    <div class="card card-body bg-danger text-white">
                                        <a href="/user/users/" class="text-white">Pas de keystore</a>
                                    </div>
                                </div>
                            </div>
                            <div th:case="'nexuSign'">
                                <button type="submit" class="btn btn-success  text-center" data-target="#signatureModal">Signer</button>
                            </div>
                            <div th:case="*">
                                <div th:if="${signRequest.currentWorkflowStep.signRequestParams.signType.name() == 'visa'}">
                                    <input alt="${visaLabel}" class="btn btn-success  text-center" id="signe" onclick="document.getElementById('signForm').submit();" type="button" value="Viser"/>
                                </div>
                                <div th:unless="${signRequest.currentWorkflowStep.signRequestParams.signType.name() == 'visa'}">
                                    <div th:if="${user.signImage != null}">
                                        <input alt="${signLabel}" class="btn btn-success  text-center" id="signe" onclick="document.getElementById('signForm').submit();" type="button" value="Signer"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary align-self-center" data-dismiss="modal">Fermer</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="wait" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-body text-center">
                        <h5>Signature en cours</h5>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated active" style="width: 100%;" id="bar">
                                <strong> <span id="bar-text"></span>
                                </strong>
                            </div>
                        </div>
                        <div style="display: none;" id="passwordError" class="alert alert-danger" role="alert">
                            Mauvais mot de passe
                        </div>
                        <div style="display: none;" id="signError" class="alert alert-danger" role="alert">
                            Erreur du système de signature
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="closeModal" type="button" class="btn btn-secondary align-self-center" data-dismiss="modal">
                            Fermer
                        </button>
                        <a id="validModal" th:href="${referer}" class="btn btn-success align-self-center">Terminer</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
<script th:inline="javascript">
    /*<![CDATA[*/
    zoom == 2;

    function toggleZoom() {
        if (zoom == 1) {
            zoom = 2;
        } else {
            zoom = 1;
        }

        document.getElementById("pointer_div").style = "background-size: " + [[${pdfWidth}]] * zoom + "px;background-image:url('/user/documents/[[${documentId}]]/getimagepdfpage/" + currentImagePage + "');width:" + ([[${pdfWidth}]] * zoom) + "px;height: " + ([[${pdfHeight}]] * zoom) + "px;border:1px solid #CCC;";
        document.getElementById("cross").style.backgroundSize = "" + [[${signWidth}]] * zoom + "px";
        document.getElementById("cross").style.width = "" + [[${signWidth}]] * zoom + "px";
        document.getElementById("cross").style.height = "" + [[${signHeight}]] * zoom + "px";
        document.getElementById("cross").style.lineHeight = "" + [[${signHeight}]] * zoom + "px";
        document.getElementById("cross").style.left = "" + document.getElementById("xPos").value * zoom + "px";
        document.getElementById("cross").style.top = "" + document.getElementById("yPos").value * zoom + "px";
        document.getElementById("borders").style.width = "" + [[${signWidth}]] * zoom + "px";
        document.getElementById("borders").style.height = "" + [[${signHeight}]] * zoom + "px";
        var textDate = document.getElementById("textDate");
        if (textDate != null) {
            textDate.style.fontSize = 8 * zoom + "px";
        }
        var textVisa = document.getElementById("textVisa");
        if (textVisa != null) {
            textVisa.style.fontSize = 8 * zoom + "px";
        }

    }

    /*]]>*/
</script>
</body>
</html>
