<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head"></head>
<body>
	<nav th:replace="fragments/menu :: menu(activeMenu)"></nav>
	<nav class="nav justify-content-between" aria-label="breadcrumb">
		<ol class="breadcrumb col-11">
			<li class="breadcrumb-item"><a href="/">Liste des demandes</a></li>
			<li class="breadcrumb-item active" aria-current="page">Demande de signature : <span th:text="${signRequest.name}"></span></li>
		</ol>
		<div class="navbar-nav align-self-center">
			<button data-target="#collapseHelp" data-toggle="collapse" type="button" class="btn btn-info">
				<span class="fas fa-info-circle"> <!--  -->
				</span>
			</button>
		</div>
	</nav>
	<div aria-expanded="true" class="collapse" id="collapseHelp">
		<div class="alert alert-info">
			Pour modifier la position de la signature, cliquez sur le document.
			Selon le type de signature, le lancement de l'application NexU ou un mot de passe peut être demandé.
		</div>
	</div>
	<main role="main" class=" container">
	<div th:if="${signable == 'ok'}">
		<form id="signForm" th:action="'/user/signrequests/sign/' + ${signRequest.id}" method="post">
			<input type="hidden" name="signonly" value="true">
			<div th:if="${documentType == 'pdf'}">
				<div class="row">
					<div class="col-lg-12">
						<div class="row">
							<div class="col-lg-4">
								<input type="button" class="btn btn-dark" id="previous" onclick="previousImage()" value="Précédent" />
							</div>
							<div class="col-lg-4 text-center">
								<dl class="display-group border-bottom m-0">
									<dt class="col-lg-5">Afficher la date</dt>
									<dd>
										<label class="switch"> <input onclick="activeDate();" type="checkbox" name="addDate" id="_activeDate" /> <span class="slider round">
												<!--  -->
										</span>
										</label>
									</dd>
								</dl>
							</div>
							<div class="col-lg-4">
								<input type="button" class="btn btn-dark float-right" id="next" onclick="nextImage()" value="Suivant" />
							</div>
						</div>
						<div class="d-flex justify-content-center">
							<div id="pointer_div" onclick="savePositionx2();" onmouseout="resetPositionx2();" onmousemove="pointItx2(event);" th:style="'background-size: ' + ${pdfWidth * 2} + 'px;background-image:url(\'/user/documents/' + ${documentId} + '/getimagepdfpage/' + ${signRequest.signRequestParams.signPageNumber -1} + '\');width:' + ${pdfWidth * 2} + 'px;height:' + ${pdfHeight * 2} + 'px;border:1px solid #CCC;'">
								<th:block th:if="${signable == 'ok' && signRequest.status.name() != 'signed' && signRequest.signRequestParams.newPageType.name() == 'none' && signRequest.signRequestParams.signType.name() != 'visa'}">
									<div id="cross" th:style="'background-repeat: no-repeat; background-position: left bottom; background-size: ' + ${signWidth * 2} + 'px;background-image: url(\'data:image/png;base64,' + ${signFile} + '\'); width: ' + ${signWidth * 2} + 'px; height: ' + ${signHeight * 2} + 'px; line-height: ' + ${signHeight * 2} + 'px; text-align: center; left: ' + ${signRequest.signRequestParams.XPos * 2} + 'px;top: ' + ${signRequest.signRequestParams.YPos * 2} + 'px;position:relative;pointer-events: none;'">
										<div id="borders" th:style="'text-align:left;line-height:normal;width: ' + ${signWidth * 2} + 'px; height: ' + ${signHeight * 2} + 'px;'"></div>
									</div>
								</th:block>
							</div>
						</div>
					</div>
					<script th:inline="javascript">
						/*<![CDATA[*/
							var nbImagePage = [[${imagePagesSize}]];
							var currentImagePage = [[${signRequest.signRequestParams.signPageNumber}]] - 1;
							var documentUrl = [[${documentUrl}]];
						/*]]>*/
					</script>
				</div>
				<div class="d-none">
					<div class="col-lg-4">
						Page : <input readonly="readonly" autocomplete="off" class="form-control form-control-sm col-6" th:value="${signRequest.signRequestParams.signPageNumber}" id="signPageNumber" type="text" name="signPageNumber" />
					</div>
					<div class="col-lg-4">
						X position : <input readonly="readonly" autocomplete="off" class="form-control form-control-sm col-6" th:value="${signRequest.signRequestParams.XPos}" id="xPos" type="text" name="xPos" />
					</div>
					<div class="col-lg-4">
						Y position : <input readonly="readonly" autocomplete="off" class="form-control form-control-sm col-6" th:value="${signRequest.signRequestParams.YPos}" id="yPos" type="text" name="yPos" />
					</div>
				</div>
			</div>
								<textarea placeholder="Vous pouvez ajouter un commentaire" class="form-control" name="comment" cols="" rows=""></textarea>

					<div th:if="${user.signImage == null && documentType == 'pdf' && signRequest.signRequestParams.signType.name() != 'visa'}">
						<div class="card card-body bg-danger text-white">
							<a href="/user/users/" class="text-white">Pas d'image de signature</a>
						</div>
					</div>
					<div th:switch="${signRequest.signRequestParams.signType.name()}">
						<div th:case="'certSign'">
							<div th:if="${keystore != null}">
								<div class="input-group">
									Mot de passe
									<input class="form-control" placeholder="${passwordLabel}" id="password" name="password" type="password" />
									<div class="input-group-append">
										<input data-toggle="modal" data-target="#wait" onclick="submitSignRequest();" alt="${signLabel}" class="btn btn-success" id="signe" title="Signe" type="button" value="Signer" />
									</div>
								</div>
							</div>
							<div th:unless="${keystore != null}">
								<div class="card card-body bg-danger text-white">
									<a href="/user/users/" class="text-white">Pas de keystore</a>
								</div>
							</div>
						</div>
						<div th:case="'nexuSign'">
							<button type="submit" class="btn btn-success  text-center" data-target="#signatureModal">
								Signer
							</button>
						</div>
						<div th:case="*">
							<div th:if="${signRequest.signRequestParams.signType.name() == 'visa'}">
								<input alt="${visaLabel}" class="btn btn-success  text-center" id="signe" title="Signe" type="submit" value="Signer" />
							</div>
							<div th:unless="${signRequest.signRequestParams.signType.name() == 'visa'}">
								<div th:if="${user.signImage != null}">
									<input alt="${signLabel}" class="btn btn-success  text-center" id="signe" title="Signe" type="submit" value="Signer" />
								</div>
							</div>
						</div>
					</div>

		</form>
	</div>
	<div th:unless="${signable == 'ok'}">
		<div class="alert alert-info">
		Vous n'avez plus d'ation à effectuer sur cette demande, merci de fermer cette fenetre
		<br/>
		<input class="btn btn-danger text-center" id="signe" title="Signe" type="submit" value="Fermer" onclick="window.close();" />
		</div>
		
	</div>

	<div id="wait" class="modal fade" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-body text-center">
					<h5>Signature en cours</h5>
					<div class="progress">
						<div class="progress-bar progress-bar-striped progress-bar-animated active" style="width: 100%;" id="bar">
							<strong> <span id="bar-text"></span>
							</strong>
						</div>
					</div>
					<div style="display: none;" id="passwordError" class="alert alert-danger" role="alert">
						Mauvais mot de passe
					</div>
				</div>
				<div class="modal-footer">
					<button id="closeModal" type="button" class="btn btn-secondary align-self-center" data-dismiss="modal">Close</button>
					<button id="validModal" onclick="window.location.reload()" type="button" class="btn btn-success align-self-center" data-dismiss="modal">Terminer</button>
				</div>
			</div>
		</div>
	</div>
	</main>
</body>
</html>
