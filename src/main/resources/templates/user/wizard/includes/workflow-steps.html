<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="workflow-steps(workflow, formIdPrefix)">
    <p th:if="${workflow == null || workflow.workflowSteps.size() == 0}">
        Après la validation, vous pourrez télécharger le document
    </p>
    <div th:if="${workflow != null && workflow.workflowSteps.size() > 0}">
        <p>
            Le circuit "<span th:text="${workflow.description}"></span>" comporte
            <span th:text="${workflow.workflowSteps.size()}"></span>
            étape<span th:if="${workflow.workflowSteps.size() > 1}">s</span>
        </p>
        <ul class="list-group striped-list">
            <th:block th:each="step, iterator : ${workflow.workflowSteps}">
                <li th:id="${formIdPrefix} + '-' + ${iterator.index}"
                    class="list-group-item border-secondary">
                    <div class="d-flex flex-column gap-1">
                        <div class="d-flex align-items-center">
                            <h3 class="d-inline">
                                <span class="badge rounded-pill text-bg-primary me-4 align-middle" th:text="${iterator.index + 1}"></span>
                            </h3>
                            <h5 th:if="${step.description != null && step.description != ''}" th:text="${step.description}"></h5>
                            <h5 th:unless="${step.description != null && step.description != ''}" th:text="'Étape ' + ${iterator.index + 1}"></h5>
                        </div>
                        <div>
                            <th:block th:unless="${step.autoSign}">
                                <b>Type de signature :</b>
                                <span th:text="${#messages.msg('signbook.signtype.' + step.signType)}"></span>
                                <small th:if="${step.signType == T(org.esupportail.esupsignature.entity.enums.SignType).signature}">
                                (Niveau mini :
                                <span th:text="${#messages.msg('signlevelShort.' + step.minSignLevel)}"></span>,
                                Niveau maxi :
                                <span th:text="${#messages.msg('signlevelShort.' + step.maxSignLevel)}"></span>
                                )
                                </small>
                                <br>
                                <b>Destinataires :</b>
                                <th:block th:if="${step.users.size() > 0}" th:each="user, userIterator : ${step.users}">
                                    <span th:text="${user.firstname} + ' ' + ${user.name} + ' (' + ${user.email} + ')'"></span>
                                    <span th:if="${user.currentReplaceByUser != null}" th:text="' (remplacé par ' + ${user.currentReplaceByUser.email} + ')'"></span>
                                    <span th:if="${userIterator.index < step.users.size() - 1}">, </span>
                                </th:block>
                                <span th:if="${step.repeatable}">
                                    (cette étape peut donner lieu à plusieurs validations en série)
                                </span>
                            </th:block>
                            <th:block th:if="${step.autoSign}">
                                Étape automatique
                            </th:block>
                        </div>
                        <div th:if="${step.changeable == true && !step.autoSign}" class="form-group">
                            <label>
                                <b>
                                    <span th:text="'Vous pouvez modifier ou saisir le' + ${step.maxRecipients != null && step.maxRecipients > 1 ? '(s)' : ''} + ' participant' + ${step.maxRecipients != null && step.maxRecipients > 1 ? '(s)' : ''} + ' pour l\'étape ' + ${iterator.index + 1}"></span>
                                    <span th:if="${step.maxRecipients < 99}" th:text="'(maximum ' + ${step.maxRecipients} + ')'" ></span>
                                </b>
                            </label>
                            <select class="select-users"
                                    th:id="'recipientsEmails-' + ${iterator.index + 1}"
                                    th:data-es-max-recipient="${step.maxRecipients}"
                                    th:maxlength="${step.maxRecipients}"
                                    multiple="multiple"
                                    name="recipientEmails"
                                    required="required">
                                <option data-placeholder="true"></option>
                                <th:block th:each="user : ${step.users}">
                                    <option th:if="${user.email != null && user.email != 'generic'}"
                                            selected="selected"
                                            th:text="${user.email}"
                                            th:placeholder="${user.email}"
                                            th:value="${user.email}"></option>
                                </th:block>
                            </select>
                            <div th:id="'tempUsers-recipientsEmails-' + ${iterator.index + 1}"></div>
                            <div class="form-group mb-3" th:id="'all-sign-to-complete-div-' + ${iterator.index + 1}" th:style="${step.users.size() == 1} ? 'display: none'">
                                <div class="form-check form-switch form-switch-md">
                                    <label class="form-check-label" th:for="'all-sign-to-complete-' + ${iterator.index + 1}">
                                        Tous les participants doivent-ils signer ?
                                    </label>
                                    <input type="checkbox" class="form-check-input" th:checked="${step.allSignToComplete}" name="allSignToCompletes" th:value="${iterator.index + 1}" th:id="'all-sign-to-complete-' + ${iterator.index + 1}"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
            </th:block>
        </ul>
        <th:block th:if="${isTempUsers}">
            <hr>
            <p>Certains destinataires sont externes à l'établissement, merci de saisir/vérifier les informations complémentaires si besoin</p>
            <th:block th:each="workflowStep, iterator : ${workflow.workflowSteps}">
                <th:block th:each="user : ${workflowStep.users}">
                    <div th:id="'extRecipient-' + ${iterator.index + 1} + '-' + ${user.email}" th:data-es-email="${user.email}" class="alert alert-primary" th:if="${user.userType.name() == 'external'}">
                        <b>Destinataire : <span th:text="${user.email}"></span></b>
                        <input id="emails" type="hidden" name="emails" th:value="${user.email}">
                        <div class="d-flex col-10">
                            <label class="col-2" for="names">Nom</label>
                            <input id="names" class="form-control col-10" type="text" name="names" th:value="${user.firstname != 'Nouvel utilisateur'} ? ${user.name} : ''" required>
                        </div>
                        <div class="d-flex col-10">
                            <label class="col-2" for="firstnames">Prénom</label>
                            <input id="firstnames" class="form-control col-10" type="text" name="firstnames" th:value="${user.firstname != 'Nouvel utilisateur'} ? ${user.firstname} : ''" required>
                        </div>
                        <div class="d-flex col-10">
                            <label class="col-2" for="phones">Mobile</label>
                            <input id="phones" class="form-control col-10" type="text" name="phones" value="" th:required="${globalProperties.smsRequired}">
                        </div>
                    </div>
                </th:block>
            </th:block>
        </th:block>
        <ul th:if="${!workflow.targets.isEmpty()}" class="list-group striped-list mt-1">
            <th:block th:each="target, iterator : ${workflow.targets}">
                <li th:if="${target.targetUri.contains('mailto:')}" class="list-group-item border-secondary">
                    <b>Étape finale :</b> Envoi par mail à
                    <select class="select-users" id="targetEmailsSelect" multiple="multiple" name="targetEmails">
                        <option data-placeholder="true"></option>
                        <th:block th:each="targetEmail : ${target.targetUri.replace('mailto:', '').split(',')}">
                            <option selected="selected" th:if="${targetEmail != ''}" th:text="${targetEmail}" th:value="${targetEmail}"></option>
                        </th:block>
                    </select>
                </li>
            </th:block>
        </ul>
    </div>
</th:block>