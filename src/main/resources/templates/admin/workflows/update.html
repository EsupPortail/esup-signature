<!doctype html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<!--/*@thymesVar id="workflow" type="org.esupportail.esupsignature.entity.Workflow"*/-->
<!--/*@thymesVar id="sourceTypes" type="java.util.List<org.esupportail.esupsignature.entity.enums.DocumentIOType>"*/-->
<!--/*@thymesVar id="targetTypes" type="java.util.List<org.esupportail.esupsignature.entity.enums.DocumentIOType>"*/-->
<head th:replace="fragments/head"></head>
<script type="module">
    import {WorkflowUi} from '/static/js/modules/ui/workflows/WorkflowUi.js?version=[[${version}]]';
    new WorkflowUi();
</script>
<body>
<nav th:replace="fragments/nav"></nav>
<main role="main">
    <div class="wrapper">
        <nav th:insert="/fragments/sides/side-admin"></nav>
        <nav id="breadcrumb" aria-label="breadcrumb" class="breadcrumb-nav">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/admin/workflows">Liste des circuits</a></li>
                <li aria-current="page" class="breadcrumb-item active">Circuit : <span th:text="${workflow.description}"></span>
                </li>
            </ol>
        </nav>
        <div id="content" class="content">
            <div class="fixed-action-btn" >
                <a id="saveButton" th:if="${workflow.fromCode == null || !workflow.fromCode}" role="button" title="Enregistrer" class="btn-floating btn-lg bg-success wave-effect"
                        onclick="document.getElementById('updateSignBook').submit();">
                    <i class="fas fa-save"></i>
                </a>
            </div>
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" href="#" onclick="return false;">Paramètres</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="'/admin/workflows/' + ${workflow.id}">Étapes</a>
                </li>
            </ul>
            <br>
            <div class="card col-lg-10 mx-auto">
                <div class="card-body">
                    <h2>Nombre de demandes pour ce circuit : <span th:text="${nbSignRequests}"></span></h2>
                    <form th:object="${workflow}" th:action="'/admin/workflows/update'" method="post" id="updateSignBook">
                        <input type="hidden" th:field="*{id}">
                        <div class="form-group mb-3">
                            <label><strong>Titre</strong></label>
                            <input class="form-control" type="text" th:field="*{title}" value="" autocomplete="on">
                        </div>
                        <div class="form-group mb-3">
                            <label><strong>Description</strong></label>
                            <input class="form-control" type="text" th:field="*{description}" value="" autocomplete="on">
                        </div>
                        <div class="form-check mb-2">
                            <input id="publicUsage" type="checkbox" class="form-check-input" th:field="*{publicUsage}"/>
                            <label for="publicUsage" class="form-check-label">Visibilité publique ?</label>
                        </div>
                        <div class="form-check mb-2">
                            <input id="visibility" type="checkbox" class="form-check-input" th:field="*{visibility}"/>
                            <label for="visibility" class="form-check-label">Diffusion du workflow pour les rôles</label>
                        </div>
                        <div class="form-group mb-3">
                            <label for="roles">
                                Rôle
                                <div class="alert alert-info d-none"><small>Le rôle correspond au groupe autorisé à accéder à
                                    ce formulaire</small></div>
                            </label>
                            <select id="roles" class="slim-select-simple" type="text" th:field="*{roles}" multiple th:classappend="${!workflow.visibility} ? 'd-none' : ''">
                                <th:block th:each="newRole : ${roles}">
                                    <option th:text="${newRole}" th:value="${newRole}" th:selected="${#lists.contains(workflow.roles, newRole)}"></option>
                                </th:block>
                            </select>
                        </div>
                        <div class="form-group mb-3" id="managers">
                            <label for="managersSelect"><strong>Superviseur(s) du circuit</strong>
                                <button class="btn btn-sm btn-transparent" data-bs-target="#collapseHelp1" data-bs-toggle="collapse"
                                        type="button">
                                    <span class="fas fa-info-circle text-info"></span>
                                </button>
                                <div class="collapse" id="collapseHelp1">
                                    <div class="alert alert-info">
                                        Les superviseurs peuvent consulter les demandes de ce circuit
                                    </div>
                                </div>
                            </label>
                            <select id="managersSelect" class="select-users" multiple="multiple" name="managers">
                                <th:block th:each="manager : ${workflow.managers}">
                                    <option selected="selected" th:value="${manager}" th:text="${manager}"></option>
                                </th:block>
                            </select>
                        </div>
                        <div class="form-check mb-2">
                            <input id="sendAlertToAllRecipients" type="checkbox" class="form-check-input" th:field="*{sendAlertToAllRecipients}"/>
                            <label for="sendAlertToAllRecipients" class="form-check-label">Avertir tous les participants à la fin du circuit ?</label>
                        </div>
                        <div class="form-group mb-3">
                            <label><strong>Types de délégation autorisés</strong></label>
                            <th:block th:each="shareType : ${T(org.esupportail.esupsignature.entity.enums.ShareType).values()}">
                                <div class="form-check text-left">
                                    <input th:checked="${workflow.authorizedShareTypes.contains(shareType)}" th:id="'check-' + ${shareType.name()}" type="checkbox" class="form-check-input" name="types" th:value="${shareType.name()}"/>
                                    <label class="form-check-label" th:for="'check-' + ${shareType.name()}" th:text="#{'usershare.sharetype.' + ${shareType.name()}}"></label>
                                </div>
                            </th:block>
                        </div>
                        <div class="form-group mb-3">
                            <label for="sourceTypeSelect">
                                <strong> Protocole pour la source des documents </strong>
                            </label>
                            <select class="slim-select-simple" id="sourceTypeSelect" th:field="*{sourceType}" size="1">
                                <th:block th:each="sourceType : ${sourceTypes}">
                                    <option th:selected="${workflow.sourceType == sourceType}" th:value="${sourceType}"
                                            th:text="#{'signbook.documentiotype.' + ${sourceType}}"></option>
                                </th:block>
                            </select>
                        </div>
                        <div class="form-group mb-3" id="documentsSourceUriDiv">
                            <label for="documentsSourceUri"> <strong>Lien pour la source des documents</strong></label>
                            <input id="documentsSourceUri" th:field="*{documentsSourceUri}"
                                   placeholder="Si autre que la valeur par défaut" class="form-control" type="text"
                                   value=""
                                   autocomplete="on">
                        </div>
                        <div class="form-check mb-2">
                            <input id="scanPdfMetadatas" type="checkbox" class="form-check-input" th:field="*{scanPdfMetadatas}"/>
                            <label for="scanPdfMetadatas" class="form-check-label">Construction du circuit à partir des métadonnées des pdf importés</label>
                        </div>
                        <div class="form-group mb-3">
                            <label for="documentsSourceUri"> <strong>Destination des documents</strong></label>
                            <table class="table table-borderless table-striped">
                                <thead class="table-secondary">
                                <tr>
                                    <th class="text-left">Type</th>
                                    <th class="text-left">URI</th>
                                    <th>Supprimer
                                    </th>
                                    <th>
                                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTarget">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </th>
                                </tr>
                                </thead>
                                <tbody>
                                <th:block th:each="target, iterator : ${workflow.targets}">
                                    <tr>
                                        <td class="text-left" th:text="${target.targetType}">
                                        </td>
                                        <td class="text-left w-100" th:text="${target.targetUri}">
                                        </td>
                                        <td>
                                            <a th:id="'deleteSign_' + ${signImageId}" th:href="'/admin/workflows/delete-target/' + ${workflow.id} + '/' + ${target.id}" role="button" class="btn btn-sm btn-danger text-white">
                                                <i class="fas fa-trash-alt"></i>
                                            </a>
                                        </td>
                                        <td></td>
                                    </tr>
                                </th:block>
                                </tbody>
                            </table>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<div class="modal fade" id="addTarget" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form class="form-group mb-3" th:action="'/admin/workflows/add-target/' + ${workflow.id}" method="post">
                <div class="modal-header">
                    <h3 class="modal-title">Ajout d'une destination</h3>
                </div>
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label for="targetType">
                            <strong> Protocole pour la destination des documents </strong>
                        </label>
                        <select class="slim-select-simple" id="targetType" name="targetType">
                            <th:block th:each="targetType : ${T(org.esupportail.esupsignature.entity.enums.DocumentIOType).values()}">
                                <option th:value="${targetType}" th:text="#{'signbook.documentiotype.' + ${targetType}}"></option>
                            </th:block>
                        </select>
                    </div>
                    <div class="form-group mb-3" id="documentsTargetUriDiv">
                        <label for="documentsTargetUri"><strong>Lien pour la destination des documents</strong></label>
                        <input id="documentsTargetUri" name="documentsTargetUri" class="form-control" type="text" autocomplete="on">
                        <p class="alert alert-info"><small>Séparez les mails par des ; dans la cas d'une destination mail</small></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary float-end"
                            data-bs-dismiss="modal">Annuler
                    </button>
                    <button type="submit" class="btn btn-success float-end">
                        Ajouter
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<footer th:replace="fragments/footer"></footer>
</body>
</html>