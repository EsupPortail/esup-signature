<!doctype html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head"></head>
<body>
	<nav th:replace="fragments/menu :: menu(activeMenu)"></nav>
	<main role="main">
		<div class="wrapper">
		<nav id="sidebar">
			<div class="m-1">
				<button title="Accueil" type="button" onclick="location.href='/'" class="mb-1 col-12 btn btn-transparent text-left">
					<i class="fas fa-home"></i> <span class="sidebar-label">Accueil</span>
				</button>
				<button th:unless="${referer != null}" title="Abandonner" class="btn btn-light col-12 mb-1 text-left" value="Retour" onclick="window.history.back();">
					<i class="fas fa-arrow-left"></i><span class="sidebar-label"> Retour</span>
				</button>
			</div>
		</nav>
		<div id="content" class="content">
			<nav aria-label="breadcrumb">
				<ol class="breadcrumb">
					<li class="breadcrumb-item"><a href="/admin/signrequests">Liste
						des demandes</a></li>
					<li class="breadcrumb-item active" aria-current="page">Demande
						de signature : <span th:text="${signRequest.token}"></span>
					</li>
				</ol>
			</nav>
			<div class="card bg-light">
				<div class="card-header">
					<button class="btn btn-link" data-toggle="collapse"
						data-target="#collapseTools" aria-expanded="true"
						aria-controls="collapseTools">
						Statut <i class="fas fa-caret-down"></i>
					</button>
				</div>
				<div id="collapseTools" class="collapse show"
					aria-labelledby="headingOne" data-parent="#accordion">
					<div class="card-body text-center">
						<div th:replace="user/signrequests/includes/status :: status"></div>
						<div th:switch="${signable}">
							<div th:case="'ok'">
								<dl class="display-group border-bottom m-0 d-none">
									<dt class="col-lg-6">
										Parapheur courant
										<button data-target="#collapseHelpCurrent"
											data-toggle="collapse" type="button"
											class="btn btn-sm btn-info">
											<span class="fas fa-info-circle"></span>
										</button>
										<div class="collapse" id="collapseHelpCurrent">
											<div class="alert alert-info">
												<small> Les paramètres du parapheur courant sont
													appliqués par défaut. Vous pouvez modifier la position
													manuellement à l'aide de la prévisualisation. </small>
											</div>
										</div>
									</dt>
									<dd>
										<span class="alert alert-secondary"> <i
											class="fas fa-book"></i> ${currentSignBook.name}
										</span>
									</dd>
								</dl>
							</div>
							<div th:case="*">
								<div th:if="${user.eppn == signRequest.createBy}">
									<div th:if="${signRequest.status.name() == 'draft'}">
										<div class="alert alert-info">Demande en cours de
											création</div>
										<div
											th:if="${#lists.size(signRequest.originalDocuments) == 0}">
											<div th:if="${modelId != null}">
												<button type="button" class="btn btn-info"
													onclick="window.open('${modelId}', '_blank')">
													<i class="fas fa-download"></i> Télécharger le modèle
												</button>
											</div>

											<div class="alert alert-info">Vous devez ajouter des
												documents</div>
										</div>
									</div>
								</div>
							</div>
							<div th:if="${signRequest.status.name() == 'exported'}" class="alert alert-warning">
							<small><span th:text="'Emplacement définitif : ' + ${signRequest.exportedDocumentURI}"></span></small>
							<br>
							<a class="btn btn-success" th:href="'/ws/get-last-file?name=' + ${signRequest.token}"><i class="fa fa-download"></i> Télécharger le document signé</a>

							</div>
							<div th:if="${signRequest.status.name() == 'pending'}">
								<div class="alert alert-info">
									La demande est en cours de signature par le(s) destinataire(s)
									suivants :
									<div class="form-group">
										<table class="table table-striped table-sm">
											<thead class="thead-dark">
												<tr>
													<th scope="col">Destinataires</th>
													<th scope="col">Statut de la signature</th>
												</tr>
											</thead>
											<tbody>
												<th:block
													th:each="signBooksLabel : ${@signRequestService.getCurrentRecipientsNames(signRequest)}">
													<tr>
														<td align="left"><i class="fas fa-user"></i> <span
															th:text="${signBooksLabel.key}"></span></td>
														<td align="center">
															<div th:switch="${signBooksLabel.value}">
																<i th:case="true" class="fas fa-check text-success"></i>
																<i th:case="false" class="fas fa-times text-danger"></i>
															</div>
														</td>
													</tr>
												</th:block>
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
						<div th:if="${user.eppn == signRequest.createBy}">
							<div th:switch="${signRequest.status.name()}">
								<div th:case="'signed'">
									<dl class="display-group border-bottom m-0">
										<dt class="col-lg-5">
											Terminer
											<button data-target="#collapseHelp1" data-toggle="collapse"
												type="button" class="btn btn-sm btn-info">
												<span class="fas fa-info-circle"></span>
											</button>
											<div class="collapse" id="collapseHelp1">
												<div class="alert alert-info">
													<small> La cloture de la demande permet de liberer
														le parapheur. La demande sera supprimée dans un délai
														défini par l'administrateur. </small>
												</div>
											</div>
										</dt>
										<dd class="col-lg-7">
											<form class="form-group"
												th:action="'/admin/signrequests/complete/' +  ${id}"
												method="get">
												<div class="input-group">
													<button type="submit" class="btn btn-warning">
														<i class="fas fa-flag-checkered"> </i> Terminer
													</button>
												</div>
											</form>
										</dd>
									</dl>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>


			<div class="card bg-light">
				<div class="card-header">
					<button class="btn btn-link" data-toggle="collapse"
						data-target="#collapseOriginals" aria-expanded="true"
						aria-controls="collapseOriginals">
						Liste des documents originaux <i class="fas fa-caret-down"></i>
					</button>
				</div>
				<div id="collapseOriginals" class="collapse show"
					aria-labelledby="headingOne" data-parent="">
					<div class="card-body">
						<div class="file-loading">
							<input id="multipartFile" name="multipartFiles" type="file"
								multiple="multiple" />
						</div>
					</div>
				</div>
			</div>
			<div class="card bg-light">
				<div class="card-header">
					<button class="btn btn-link" data-toggle="collapse"
						data-target="#collapseSigned" aria-expanded="true"
						aria-controls="collapseSigned">
						Liste des documents signés <i class="fas fa-caret-down"></i>
					</button>
				</div>
				<div id="collapseSigned" class="collapse show"
					aria-labelledby="headingOne" data-parent="">
					<div class="card-body">
						<div class="file-loading">
							<input id="signedFiles" type="file" multiple="multiple" />
						</div>
					</div>
				</div>
			</div>
			<div class="card bg-light">
				<div class="card-header">
					<button class="btn btn-link" data-toggle="collapse"
						data-target="#collapseComments" aria-expanded="true"
						aria-controls="collapseTools">
						Commentaires <span th:text="'(' + ${#lists.size(comments)} + ')'"></span>
						<i class="fas fa-caret-down"></i>
					</button>
				</div>
				<div id="collapseComments" class="collapse"
					aria-labelledby="headingOne" data-parent="#accordion">
					<div class="card-body">
						<ul class="list-group">
							<th:block th:each="comment : ${comments}">
								<div class="d-flex w-100 justify-content-between">
									<li href="#" class="list-group-item list-group-item-action">
									De : <span class="mb-1" th:text="${comment.eppn}"></span> -
									<small>
										le : <span th:text="${#dates.format(comment.logDate, 'dd/MM/yyyy HH:mm')}"></span>
										<br>
										Action effectuée : <span th:text="#{'signbook.status.' + ${comment.finalStatus}}" ></span>
									</small>
									<p th:text="${comment.comment}"></p>

									</li>
								</div>
							</th:block>
						</ul>
						<form th:action="'/admin/signrequests/comment/' + ${id}">
							<textarea placeholder="Vous pouvez ajouter un commentaire"
								class="form-control" name="comment" cols="" rows=""></textarea>
							<button type="submit" class="btn btn-primary">
								<i class="fas fa-comments" aria-hidden="true"></i> Envoyer un
								commentaire
							</button>
						</form>

					</div>
				</div>
			</div>

			<div class="card bg-light">
				<div class="card-header">
					<button class="btn btn-link" data-toggle="collapse"
						data-target="#collapseLogs" aria-expanded="true"
						aria-controls="collapseTools">
						Logs (<span th:text="(${#lists.size(logs)})"></span>) <i
							class="fas fa-caret-down"></i>
					</button>
				</div>
				<div id="collapseLogs" class="collapse" aria-labelledby="headingOne"
					data-parent="#accordion">
					<div class="card-body">
						<table class="table table-sm table-striped table-hover">
							<thead>
								<tr>
									<th class="none">Date</th>
									<th class="none">Eppn</th>
									<th class="none">Action</th>
									<th class="none">Statut initial</th>
									<th class="none">Statut final</th>
								</tr>
							</thead>
							<tbody>
								<th:block th:each="log : ${logs}">
									<tr>
										<td><span th:text=${log.logDate}></span></td>
										<td><span th:text=${log.eppn}></span></td>
										<td><span th:text=${log.action}></span></td>
										<td><span th:text=${log.initialStatus}></span></td>
										<td><span th:text=${log.finalStatus}></span></td>
									</tr>
								</th:block>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
		</div>
	</main>

	<script th:inline="javascript">
		/*<![CDATA[*/


	$('#multipartFile').on('filebatchuploadcomplete', function(event, file, previewId, index, reader) {
		location.reload();
	});
	$('#multipartFile').on('fileuploaded', function(event, file, previewId, index, reader) {
		location.reload();
	});

	$('#multipartFile').on('fileloaded', function(event, file, previewId, index, reader) {
		$('#multipartFile').fileinput('upload');
	});

	$('#multipartFile').on('filedeleted', function(event, id, index) {
		location.reload();
	});

	$("#multipartFile").fileinput({
    	language: "fr",
        showCaption: false,
        showClose: false,
		showUpload: false,
		showBrowse: false,
		showRemove: false,
		dropZoneEnabled: false,
		browseOnZoneClick: true,
    	uploadUrl: "/admin/signrequests/add-doc/[[${id}]]",
    	uploadAsync: false,
        maxFileCount: 1,
        validateInitialCount: true,
    	overwriteInitial: false,
        theme: 'explorer-fas',
        pdfRendererUrl: 'http://plugins.krajee.com/pdfjs/web/viewer.html',
    	initialPreview: [
    		[# th:each="originalDocument : ${signRequest.originalDocuments}"]
    		[# th:text=${originalDocument.url}][/],
    		[/]
    		],
   	    initialPreviewConfig: [
    		[# th:each="originalDocument : ${signRequest.originalDocuments}"]
       		[# th:switch="${#strings.arraySplit(originalDocument.contentType, '/')[1]}"]
    			[# th:case="'gif'"]
	      	        {type: "image", size: [[${originalDocument.size}]], downloadUrl: "/admin/documents/getfile/[[${originalDocument.id}]]",caption: [[${originalDocument.fileName}]], filename: [[${originalDocument.fileName}]], url: [['/admin/signrequests/remove-doc/' + ${originalDocument.id}]], key: [[${originalDocument.id}]]},
    			[/]
      	      	[# th:case="'pdf'"]
      	    	  	{type: "pdf", size: [[${originalDocument.size}]], downloadUrl: "/admin/documents/getfile/[[${originalDocument.id}]]",caption: [[${originalDocument.fileName}]], filename: [[${originalDocument.fileName}]], url: "/admin/signrequests/remove-doc/[[${originalDocument.id}]]", key: [[${originalDocument.id}]]},
      	    	[/]
    			[# th:case="'doc'"]
    				{type: "office", size: [[${originalDocument.size}]], downloadUrl: [[${originalDocument.url}]],caption: [[${originalDocument.fileName}]], filename: [[${originalDocument.fileName}]], url: [['/admin/signrequests/remove-doc/' + ${originalDocument.id}]], key: [[${originalDocument.id}]]},
    			[/]
    			[# th:case="'avi'"]
    				{type: "video", size: [[${originalDocument.size}]], downloadUrl: [[${originalDocument.url}]],caption: [[${originalDocument.fileName}]], filename: [[${originalDocument.fileName}]], url: [['/admin/signrequests/remove-doc/' + ${originalDocument.id}]], key: [[${originalDocument.id}]]},
    			[/]
	    		[# th:case="*"]
		    		{type: "other", size: [[${originalDocument.size}]], downloadUrl: [[${originalDocument.url}]],caption: [[${originalDocument.fileName}]], filename: [[${originalDocument.fileName}]], url: [['/admin/signrequests/remove-doc/' + ${originalDocument.id}]], key: [[${originalDocument.id}]]},
	    		[/]
    		[/]
    		[/]
   	    ],
   		initialPreviewAsData: true,
   		initialPreviewFileType: 'pdf',
        preferIconicPreview: true,
        previewFileIconSettings: { // configure your icon file extensions
            'doc': '<i class="fas fa-file-word text-primary  fa-2x"></i>',
            'xls': '<i class="fas fa-file-excel text-success  fa-2x"></i>',
            'ppt': '<i class="fas fa-file-powerpoint text-danger  fa-2x"></i>',
            'pdf': '<i class="fas fa-file-pdf text-danger  fa-2x"></i>',
            'zip': '<i class="fas fa-file-archive text-muted  fa-2x"></i>',
            'htm': '<i class="fas fa-file-code text-info  fa-2x"></i>',
            'txt': '<i class="fas fa-file-alt text-info fa-2x"></i>',
            'mov': '<i class="fas fa-file-video text-warning fa-2x"></i>',
            'mp3': '<i class="fas fa-file-audio text-warning  fa-2x"></i>',
            'jpg': '<i class="fas fa-file-image text-danger fa-2x"></i>',
            'gif': '<i class="fas fa-file-image text-muted fa-2x"></i>',
            'png': '<i class="fas fa-file-image text-primary fa-2x"></i>'
        },
        previewFileExtSettings: { // configure the logic for determining icon file extensions
            'doc': function(ext) {
                return ext.match(/(doc|docx)$/i);
            },
            'xls': function(ext) {
                return ext.match(/(xls|xlsx)$/i);
            },
            'ppt': function(ext) {
                return ext.match(/(ppt|pptx)$/i);
            },
            'zip': function(ext) {
                return ext.match(/(zip|rar|tar|gzip|gz|7z)$/i);
            },
            'htm': function(ext) {
                return ext.match(/(htm|html)$/i);
            },
            'txt': function(ext) {
                return ext.match(/(txt|ini|csv|java|php|js|css)$/i);
            },
            'mov': function(ext) {
                return ext.match(/(avi|mpg|mkv|mov|mp4|3gp|webm|wmv)$/i);
            },
            'mp3': function(ext) {
                return ext.match(/(mp3|wav)$/i);
            }
        },
        fileActionSettings: {
        	showDrag: false,
            showZoom: function(config) {
                if (config.type === 'pdf' || config.type === 'image') {
                    return true;
                }
                return false;
            },
            [# th:if="${signRequest.status.name() != 'draft' || user.eppn != signRequest.createBy}"]
	        	showRemove: false
        	[/]

        }

    });

	$("#signedFiles").fileinput({
    	language: "fr",
        showCaption: false,
        showClose: false,
       	showUpload: false,
       	showBrowse: false,
       	showRemove: false,
       	dropZoneEnabled: false,
        browseOnZoneClick: true,
    	uploadAsync: false,
        theme: 'explorer-fas',
        pdfRendererUrl: 'http://plugins.krajee.com/pdfjs/web/viewer.html',
    	initialPreview: [
    		[# th:each="signedDocument : ${signRequest.signedDocuments}"]
    		[[${signedDocument.url}]],
    		[/]
    		],
   	    initialPreviewConfig: [
    		[# th:each="signedDocument : ${signRequest.signedDocuments}"]
			[# th:switch="${#strings.arraySplit(signedDocument.contentType, '/')[1]}"]
      	      	[# th:case="'pdf'"]
	      	      	{type: "pdf", size: [[${signedDocument.size}]], downloadUrl: "/admin/documents/getfile/[[${signedDocument.id}]]",caption: [[${signedDocument.fileName}]], filename: [[${signedDocument.fileName}]], key: [[${signedDocument.id}]]},
      	    	[/]
	    		[# th:case="*"]
					{type: "other", size: [[${signedDocument.size}]], downloadUrl: "/admin/documents/getfile/[[${signedDocument.id}]]",caption: [[${signedDocument.fileName}]], filename: [[${signedDocument.fileName}]], key: [[${signedDocument.id}]]},
	    		[/]
    		[/]
    		[/]
   	    ],
   		initialPreviewAsData: true,
   		initialPreviewFileType: 'image',
   	    overwriteInitial: false,
        preferIconicPreview: true,
        previewFileIconSettings: { // configure your icon file extensions
            'pdf': '<i class="fas fa-file-pdf text-danger fa-2x"></i>',
            'asic': '<i class="fas fa-file-signature text-dark fa-2x"></i>',
        },
        previewFileExtSettings: { // configure the logic for determining icon file extensions
            'asic': function(ext) {
                return ext.match(/(asics|asice)$/i);
            }
        },
        fileActionSettings: {
        	showDrag: false,
        	showZoom: function(config) {
                 if (config.type === 'pdf') {
                     return true;
                 }
                 return false;
             },
        	showRemove: false
        }

    });
/*]]>*/
</script>

</body>
</html>
